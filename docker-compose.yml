# =================================================================
# ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆç”¨ Docker Compose ãƒ•ã‚¡ã‚¤ãƒ«
# è»½é‡ã§é«˜é€Ÿãªå˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ç’°å¢ƒ
# =================================================================
version: '3.8'

services:
  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ã€é«˜é€Ÿï¼‰
  unit-test-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: adf-unit-test-runner
    environment:
      - TEST_MODE=unit
      - PYTEST_MARKERS=unit
      - PYTHONPATH=/app
      - TEST_TIMEOUT=120
    volumes:
      - ./tests:/app/tests
      - ./src:/app/src
      - ./input:/app/input
      - ./output:/app/output
      - unit_test_results:/app/test_results
    working_dir: /app
    networks:
      - unit-test-network
    profiles:
      - unit-test
    command: >
      sh -c "
        echo 'ğŸš€ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...' &&
        python -m pytest tests/unit/ -v --tb=short --cov=src --cov-report=term-missing --cov-report=html:test_results/coverage_html --junit-xml=test_results/unit_test_results.xml
      "

  # Azure Blob Storage ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼ˆè»½é‡ç‰ˆã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  azurite-unit:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: azurite-unit-test
    environment:
      - AZURITE_ACCOUNTS=devstoreaccount1:Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==
    ports:
      - "10100:10000" # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆç”¨ãƒãƒ¼ãƒˆ
    volumes:
      - azurite_unit_data:/data
    command: [ "azurite", "--blobHost", "0.0.0.0", "--location", "/data", "--debug", "/data/debug.log" ]
    networks:
      - unit-test-network
    profiles:
      - unit-test
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 10000 || exit 1" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

networks:
  unit-test-network:
    driver: bridge

volumes:
  unit_test_results:
    driver: local
  azurite_unit_data:
    driver: local
