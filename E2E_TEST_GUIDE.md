# ADF E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒ ä½¿ç”¨ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Azure Data Factory (ADF) ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®End-to-End (E2E) ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰ã¨å®Ÿè¡Œæ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚Dockerã¨Docker Composeã‚’ä½¿ç”¨ã—ã¦ã€å®Œå…¨ã«åˆ†é›¢ã•ã‚ŒãŸå†ç¾å¯èƒ½ãªãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã¯ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    E2E Test Environment                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ E2E Test Runner â”‚  â”‚   SQL Server    â”‚  â”‚   Azurite    â”‚ â”‚
â”‚  â”‚   (Python)      â”‚  â”‚   (Database)    â”‚  â”‚  (Storage)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ IR Simulator    â”‚  â”‚     Redis       â”‚                   â”‚
â”‚  â”‚ (Integration)   â”‚  â”‚    (Cache)      â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ å‰ææ¡ä»¶

### å¿…è¦ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢

- **Docker** (v20.10ä»¥ä¸Š)
- **Docker Compose** (v2.0ä»¥ä¸Š)
- **Git**

### å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«

- `Dockerfile.e2e.complete-light` - E2Eãƒ†ã‚¹ãƒˆç”¨Dockerãƒ•ã‚¡ã‚¤ãƒ«
- `docker-compose.e2e.yml` - Docker Composeè¨­å®š
- `requirements.e2e.txt` - E2Eãƒ†ã‚¹ãƒˆç”¨Pythonä¾å­˜é–¢ä¿‚
- `run-e2e-tests.sh` - è‡ªå‹•å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. ç’°å¢ƒè¨­å®š

ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è¨­å®šï¼š

```bash
cp .env.e2e.template .env.e2e
# .env.e2eãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦Azureèªè¨¼æƒ…å ±ã‚’è¨­å®š
```

### 2. E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

#### å®Œå…¨è‡ªå‹•å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰

```bash
./run-e2e-tests.sh
```

#### æ‰‹å‹•å®Ÿè¡Œ

```bash
# 1. ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
docker-compose -f docker-compose.e2e.yml build

# 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
docker-compose -f docker-compose.e2e.yml up --abort-on-container-exit
```

## ğŸ“ å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³

### è‡ªå‹•å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
# ãƒ“ãƒ«ãƒ‰ã®ã¿å®Ÿè¡Œ
./run-e2e-tests.sh --build-only

# ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆãƒ“ãƒ«ãƒ‰ã‚¹ã‚­ãƒƒãƒ—ï¼‰
./run-e2e-tests.sh --test-only

# ãƒ†ã‚¹ãƒˆå¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
./run-e2e-tests.sh --cleanup

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 600ç§’ï¼‰
./run-e2e-tests.sh --timeout 900

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
./run-e2e-tests.sh --help
```

### Docker Composeã‚³ãƒãƒ³ãƒ‰

```bash
# ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿èµ·å‹•
docker-compose -f docker-compose.e2e.yml up sqlserver-test azurite-test

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ
docker-compose -f docker-compose.e2e.yml up -d

# ãƒ­ã‚°ç¢ºèª
docker-compose -f docker-compose.e2e.yml logs e2e-test-runner

# ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
docker-compose -f docker-compose.e2e.yml down

# ãƒœãƒªãƒ¥ãƒ¼ãƒ å«ã‚ã¦å‰Šé™¤
docker-compose -f docker-compose.e2e.yml down --volumes
```

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

### å‡ºåŠ›å½¢å¼

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã€ä»¥ä¸‹ã®å½¢å¼ã§çµæœãŒå‡ºåŠ›ã•ã‚Œã¾ã™ï¼š

```
test_results/
â”œâ”€â”€ e2e_complete.xml         # å…¨ä½“ã®JUnit XMLçµæœ
â”œâ”€â”€ e2e_report.html          # HTMLãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ
â”œâ”€â”€ coverage.xml             # ã‚«ãƒãƒ¬ãƒƒã‚¸XML
â”œâ”€â”€ coverage_html/           # HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
â”œâ”€â”€ basic_connections.xml    # åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ
â”œâ”€â”€ docker_integration.xml   # Dockerçµ±åˆãƒ†ã‚¹ãƒˆçµæœ
â””â”€â”€ ...                      # ãã®ä»–å€‹åˆ¥ãƒ†ã‚¹ãƒˆçµæœ
```

### çµæœç¢ºèªæ–¹æ³•

```bash
# ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
ls -la test_results/

# HTMLãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã
open test_results/e2e_report.html

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã
open test_results/coverage_html/index.html
```

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ç’°å¢ƒå¤‰æ•°è¨­å®š

`.env.e2e`ãƒ•ã‚¡ã‚¤ãƒ«ã§ä»¥ä¸‹ã®è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ï¼š

- **Azureèªè¨¼æƒ…å ±**: ADF_SUBSCRIPTION_ID, ADF_CLIENT_ID, etc.
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š**: SQL_SERVER_HOST, SQL_SERVER_PASSWORD, etc.
- **ãƒ†ã‚¹ãƒˆè¨­å®š**: TEST_TIMEOUT, LOG_LEVEL, etc.

### ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å¤‰æ›´

`docker-compose.e2e.yml`ã®`e2e-test-runner`ã‚µãƒ¼ãƒ“ã‚¹ã®`command`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†ã—ã¦ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

```yaml
command: >
  sh -c "
    python -m pytest /app/tests/e2e/test_specific_module.py -v --tb=short
  "
```

### è¿½åŠ ã‚µãƒ¼ãƒ“ã‚¹

æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¾‹ï¼šMongoDBã€Elasticsearchï¼‰ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã€`docker-compose.e2e.yml`ã«æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©ã‚’è¿½åŠ ã—ã¾ã™ã€‚

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. Docker Composeèµ·å‹•å¤±æ•—

```bash
# ã‚¨ãƒ©ãƒ¼: ãƒãƒ¼ãƒˆãŒæ—¢ã«ä½¿ç”¨ä¸­
ERROR: for sqlserver-test  Cannot start service sqlserver-test: 
driver failed programming external connectivity on endpoint

# è§£æ±ºæ–¹æ³•: ä½¿ç”¨ä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
sudo lsof -i :1433
kill -9 <PID>
```

#### 2. SQL Serveræ¥ç¶šã‚¨ãƒ©ãƒ¼

```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
docker-compose -f docker-compose.e2e.yml exec sqlserver-test \
  /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong!Passw0rd123' -Q 'SELECT 1' -C
```

#### 3. ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼

```bash
# Dockerãƒ¡ãƒ¢ãƒªè¨­å®šã‚’å¢—åŠ 
# Docker Desktop > Settings > Resources > Memory ã‚’8GBä»¥ä¸Šã«è¨­å®š
```

#### 4. ãƒ“ãƒ«ãƒ‰å¤±æ•—

```bash
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œå†ãƒ“ãƒ«ãƒ‰
docker system prune -f
docker-compose -f docker-compose.e2e.yml build --no-cache
```

### ãƒ­ã‚°ç¢ºèª

```bash
# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°
docker-compose -f docker-compose.e2e.yml logs

# ç‰¹å®šã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°
docker-compose -f docker-compose.e2e.yml logs e2e-test-runner

# ãƒ­ã‚°ã‚’ãƒ•ã‚©ãƒ­ãƒ¼
docker-compose -f docker-compose.e2e.yml logs -f
```

### ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰

```bash
# ãƒ‡ãƒãƒƒã‚°ç”¨ã«å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
docker-compose -f docker-compose.e2e.yml run --rm e2e-test-runner bash

# æ‰‹å‹•ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python -m pytest tests/e2e/test_basic_connections.py -v -s
```

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ä¸¦åˆ—å®Ÿè¡Œ

```bash
# ä¸¦åˆ—ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
export PYTEST_XDIST_WORKERS=4
python -m pytest tests/e2e/ -n 4
```

### ãƒªã‚½ãƒ¼ã‚¹è¨­å®š

`docker-compose.e2e.yml`ã§ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã‚’è¨­å®šï¼š

```yaml
services:
  e2e-test-runner:
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### æ©Ÿå¯†æƒ…å ±ç®¡ç†

- `.env.e2e`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’gitignoreã«è¿½åŠ 
- æœ¬ç•ªç’°å¢ƒã®èªè¨¼æƒ…å ±ã¯ä½¿ç”¨ã—ãªã„
- ãƒ†ã‚¹ãƒˆå°‚ç”¨ã®Azureãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½¿ç”¨
- ä¸è¦ãªãƒãƒ¼ãƒˆå…¬é–‹ã‚’é¿ã‘ã‚‹

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Docker Composeå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.com/compose/)
- [pytestå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.pytest.org/)
- [Azure Data Factoryå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.microsoft.com/azure/data-factory/)

## ğŸ¤ è²¢çŒ®

ãƒã‚°å ±å‘Šã‚„æ©Ÿèƒ½æ”¹å–„ã®ææ¡ˆã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Issueãƒˆãƒ©ãƒƒã‚«ãƒ¼ã¾ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã«ã¤ã„ã¦ã¯ã€LICENSEãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
