{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "factoryName": {
            "type": "string",
            "metadata": "データ ファクトリ名",
            "defaultValue": "omni-df-dev"
        }
    },
    "variables": {
        "factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
    },
    "resources": [
        {
            "name": "[concat(parameters('factoryName'), '/ds_KarteS3')]",
            "type": "Microsoft.DataFactory/factories/datasets",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "エラーで使えない",
                "linkedServiceName": {
                    "referenceName": "li_Karte_AmazonS3",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "directory": {
                        "type": "string"
                    },
                    "filename": {
                        "type": "string"
                    }
                },
                "annotations": [],
                "type": "Json",
                "typeProperties": {
                    "location": {
                        "type": "AmazonS3Location",
                        "bucketName": "karte-data-bucket",
                        "folderPath": {
                            "value": "@dataset().directory",
                            "type": "Expression"
                        },
                        "fileName": {
                            "value": "@dataset().filename",
                            "type": "Expression"
                        }
                    }
                },
                "schema": {}
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/ds_sqlmi')]",
            "type": "Microsoft.DataFactory/factories/datasets",
            "apiVersion": "2018-06-01",
            "properties": {
                "linkedServiceName": {
                    "referenceName": "li_sqlmi_dwh2",
                    "type": "LinkedServiceReference"
                },
                "annotations": [],
                "type": "AzureSqlMITable",
                "schema": [],
                "typeProperties": {
                    "schema": "marketing",
                    "table": "顧客DNA_推定DM"
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/ds_contract_score')]",
            "type": "Microsoft.DataFactory/factories/datasets",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "ソースとなるDBの定義",
                "linkedServiceName": {
                    "referenceName": "li_dam_dwh",
                    "type": "LinkedServiceReference"
                },
                "annotations": [],
                "type": "AzureSqlDWTable",
                "schema": [
                    {
                        "name": "HASHED_MTGID",
                        "type": "varchar"
                    },
                    {
                        "name": "INTERNAL_AREA_GAS",
                        "type": "varchar"
                    },
                    {
                        "name": "INTERNAL_AREA_GAS_MENU",
                        "type": "varchar"
                    },
                    {
                        "name": "EXTERNAL_AREA_GAS",
                        "type": "varchar"
                    },
                    {
                        "name": "EXTERNAL_AREA_GAS_MENU",
                        "type": "varchar"
                    },
                    {
                        "name": "POWER",
                        "type": "varchar"
                    },
                    {
                        "name": "POWER_MENU",
                        "type": "varchar"
                    },
                    {
                        "name": "PV_SCORE_POWER",
                        "type": "decimal",
                        "precision": 6,
                        "scale": 5
                    },
                    {
                        "name": "PV_SCORE_RANK_POWER",
                        "type": "varchar"
                    },
                    {
                        "name": "PV_SCORE_GAS",
                        "type": "decimal",
                        "precision": 6,
                        "scale": 5
                    },
                    {
                        "name": "ESTIMATED_PV_HOLDINGS_FLAG_GAS",
                        "type": "decimal",
                        "precision": 3,
                        "scale": 0
                    },
                    {
                        "name": "DG_STN_AGE_0_29",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "DG_STN_AGE_30_39",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "DG_STN_AGE_40_49",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "DG_STN_AGE_50_59",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "DG_STN_AGE_60_69",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "DG_STN_AGE_70_99",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "DG_SITI_ST_NUM",
                        "type": "varchar"
                    },
                    {
                        "name": "DG_STNS_4MLON_LESS",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "DG_STNS_10MLON_OVER",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "TNKYSK_2MONTH",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "TNKYSK_1YEAR",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_GS_DTRKSCR_MONTH03",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_GS_DTRKSCR_YEAR01",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_DK_DTRKSCR_MONTH03",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_DK_DTRKSCR_YEAR01",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_SGSTB_TBLKNR",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_SGSTB_BLTINKNR",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_SGSTB_TES",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_SGSTB_HRK",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_SGSTB_OY",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_SGSTB_FNHT",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_SGSTB_GSKNSK",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_SV_GSKK_SS",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    },
                    {
                        "name": "SYZI_DK_WEB",
                        "type": "decimal",
                        "precision": 5,
                        "scale": 2
                    }
                ],
                "typeProperties": {
                    "schema": "omni",
                    "table": {
                        "value": "omni_ods_marketing_trn_karte_contract_score_hashed",
                        "type": "Expression"
                    }
                }
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/ds_Json_Blob_test')]",
            "type": "Microsoft.DataFactory/factories/datasets",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "検証用",
                "linkedServiceName": {
                    "referenceName": "li_blob_tgomnidevrgsa_container",
                    "type": "LinkedServiceReference"
                },
                "parameters": {
                    "directory": {
                        "type": "string"
                    },
                    "filename": {
                        "type": "string"
                    }
                },
                "annotations": [],
                "type": "Json",
                "typeProperties": {
                    "location": {
                        "type": "AzureBlobStorageLocation",
                        "fileName": {
                            "value": "@dataset().filename",
                            "type": "Expression"
                        },
                        "folderPath": {
                            "value": "@dataset().directory",
                            "type": "Expression"
                        },
                        "container": "tgomni"
                    }
                },
                "schema": {}
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Ins_usageservice_mtgid')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "KARTE連携用利用サービスの作成",
                "activities": [
                    {
                        "name": "at_Insert_karte_usageservice_mtgid",
                        "description": "MTGIDベースの利用サービスを作成し、成形したKARTE用利用サービスを作成する",
                        "type": "Script",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "\n--処理(c)\n-- 利用サービス(mTGID)データ作成\nTRUNCATE TABLE [omni].[omni_ods_cloak_trn_usageservice_mtgid_temp];\n\nINSERT INTO [omni].[omni_ods_cloak_trn_usageservice_mtgid_temp]\nSELECT\n     [INDEX_ID]           -- インデックス番号\n    ,[USER_KEY_TYPE]      -- ユーザーキー種別\n    ,[USER_KEY]           -- ユーザーキー\n    ,[SERVICE_TYPE]       -- サービス契約種別\n    ,[TRANSFER_TYPE]      -- 異動種別\n    ,[TRANSFER_YMD]       -- サービス契約異動日\n    ,[ROLE_TYPE]          -- ロール種別\n    ,[ROLE_TRANSFER_YMD]  -- ロール異動日\n    ,[SERVICE_KEY_TYPE1]  -- サービス契約キー種別1\n    ,[SERVICE_KEY1]       -- サービス契約キー1\n    ,[SERVICE_KEY_TYPE2]  -- サービス契約キー種別2\n    ,[SERVICE_KEY2]       -- サービス契約キー2\n    ,[SERVICE_KEY_TYPE3]  -- サービス契約キー種別3\n    ,[SERVICE_KEY3]       -- サービス契約キー3\n    ,[SERVICE_KEY_START_YMD]-- サービス契約キー適用日\n    ,[OUTPUT_DATE]        -- 出力日時\n    ,[UPDATE_FLAG]        -- 更新フラグ\n    ,[UAD_FLAG]           -- UAD区分\n    ,[PURGE_DATE]         -- 満期落とし対象日付\n    ,[REC_REG_YMD]\n    ,[REC_UPD_YMD]\n    ,[CSV_YMD]\nFROM (\n    SELECT\n         [INDEX_ID]           -- インデックス番号\n        ,[USER_KEY_TYPE]      -- ユーザーキー種別\n        ,[USER_KEY]           -- ユーザーキー\n        ,[SERVICE_TYPE]       -- サービス契約種別\n        ,[TRANSFER_TYPE]      -- 異動種別\n        ,[TRANSFER_YMD]       -- サービス契約異動日\n        ,[ROLE_TYPE]          -- ロール種別\n        ,[ROLE_TRANSFER_YMD]  -- ロール異動日\n        ,[SERVICE_KEY_TYPE1]  -- サービス契約キー種別1\n        ,[SERVICE_KEY1]       -- サービス契約キー1\n        ,[SERVICE_KEY_TYPE2]  -- サービス契約キー種別2\n        ,[SERVICE_KEY2]       -- サービス契約キー2\n        ,[SERVICE_KEY_TYPE3]  -- サービス契約キー種別3\n        ,[SERVICE_KEY3]       -- サービス契約キー3\n        ,[SERVICE_KEY_START_YMD]-- サービス契約キー適用日\n        ,[OUTPUT_DATE]        -- 出力日時\n        ,[UPDATE_FLAG]        -- 更新フラグ\n        ,[UAD_FLAG]           -- UAD区分\n        ,[PURGE_DATE]         -- 満期落とし対象日付\n        ,[REC_REG_YMD]\n        ,[REC_UPD_YMD]\n        ,[CSV_YMD]\n\n        ,ROW_NUMBER() OVER(PARTITION BY [INDEX_ID]\n                                        ,[USER_KEY_TYPE]\n                                        ,[USER_KEY]\n                                        ,[SERVICE_TYPE]\n                                        ,[TRANSFER_TYPE]\n                                        ,[TRANSFER_YMD]\n                                        ,[ROLE_TYPE]\n                                        ,[ROLE_TRANSFER_YMD]\n                                        ,[SERVICE_KEY_TYPE1]\n                                        ,[SERVICE_KEY1]\n                                        ,[SERVICE_KEY_TYPE2]\n                                        ,[SERVICE_KEY2]\n                                        ,[SERVICE_KEY_TYPE3]\n                                        ,[SERVICE_KEY3]\n                                        ,[SERVICE_KEY_START_YMD]\n                                        ,[OUTPUT_DATE]\n                                        ,[UAD_FLAG]\n                                        ,[PURGE_DATE]\n                            ORDER BY [UPDATE_FLAG] desc\n                          ) num -- [UPDATE_FLAG]更新フラグを除くカラムが一致し、[UPDATE_FLAG]更新フラグの降順\n    FROM [omni].[omni_ods_cloak_trn_contract_key_latest_status] latest   --   (最新断面)\n    WHERE EXISTS(SELECT 1 FROM [omni].[omni_ods_cloak_trn_contract_key_mtgid_temp] key_mtgid WHERE key_mtgid.[INDEX_ID]=latest.[INDEX_ID])\n          AND [USER_KEY_TYPE] NOT IN ('017','011')   -- (017：顧客(Bx),011：会員ID)を除く\n) tmp\nWHERE num=1   -- 重複の[UPDATE_FLAG]更新フラグが大きいほうを残す\n;\n\n--処理(d)\n--mTGIDベースの利用サービスを作成\nTRUNCATE TABLE [omni].[omni_ods_cloak_trn_usageservice_mtgid];\n\nINSERT INTO [omni].[omni_ods_cloak_trn_usageservice_mtgid]\nSELECT\n     key_bx.[USER_KEY]    as BX\n    ,key_mtgid.[USER_KEY] as MTGID\n    ,ustmp.[INDEX_ID]           -- インデックス番号\n    ,ustmp.[USER_KEY_TYPE]      -- ユーザーキー種別\n    ,ustmp.[USER_KEY]           -- ユーザーキー\n    ,ustmp.[SERVICE_TYPE]       -- サービス契約種別\n    ,ustmp.[TRANSFER_TYPE]      -- 異動種別\n    ,ustmp.[TRANSFER_YMD]       -- サービス契約異動日\n    ,ustmp.[ROLE_TYPE]          -- ロール種別\n    ,ustmp.[ROLE_TRANSFER_YMD]  -- ロール異動日\n    ,ustmp.[SERVICE_KEY_TYPE1]  -- サービス契約キー種別1\n    ,ustmp.[SERVICE_KEY1]       -- サービス契約キー1\n    ,ustmp.[SERVICE_KEY_TYPE2]  -- サービス契約キー種別2\n    ,ustmp.[SERVICE_KEY2]       -- サービス契約キー2\n    ,ustmp.[SERVICE_KEY_TYPE3]  -- サービス契約キー種別3\n    ,ustmp.[SERVICE_KEY3]       -- サービス契約キー3\n    ,ustmp.[SERVICE_KEY_START_YMD]-- サービス契約キー適用日\n    ,ustmp.[OUTPUT_DATE]        -- 出力日時\n    ,ustmp.[UPDATE_FLAG]        -- 更新フラグ\n    ,ustmp.[UAD_FLAG]           -- UAD区分\n    ,ustmp.[PURGE_DATE]         -- 満期落とし対象日付\n    ,ustmp.[REC_REG_YMD]\n    ,ustmp.[REC_UPD_YMD]\n    ,ustmp.[CSV_YMD]\nFROM [omni].[omni_ods_cloak_trn_contract_key_mtgid_temp] key_mtgid        -- CLOAK契約キー(mTGIDリスト)_temp\nINNER JOIN [omni].[omni_ods_cloak_trn_usageservice_mtgid_temp] ustmp      -- 作業テーブル\n      ON ustmp.[INDEX_ID]=key_mtgid.[INDEX_ID]\nLEFT JOIN [omni].[omni_ods_cloak_trn_contract_key_bx_temp] key_bx         -- CLOAK契約キー(Bxリスト)_temp\n      ON key_bx.[INDEX_ID]=ustmp.[INDEX_ID]\n;\n\n--処理(e)\n-- mTGIDベース利用サービスを成型\nTRUNCATE TABLE [omni].[omni_ods_cloak_trn_karte_usageservice_mtgid];\n\nINSERT INTO [omni].[omni_ods_cloak_trn_karte_usageservice_mtgid]\nSELECT\n       MTGID\n      ,INDEX_ID\n\n      ,CASE WHEN SERVICE_KEY_TYPE1='001' THEN SERVICE_KEY1\n            WHEN SERVICE_KEY_TYPE2='001' THEN SERVICE_KEY2\n            WHEN SERVICE_KEY_TYPE3='001' THEN SERVICE_KEY3\n            ELSE NULL\n       END AS KEY_1X    -- ガスメータ設置場所番号\n\n      ,CASE WHEN USER_KEY_TYPE='003' THEN USER_KEY\n            ELSE NULL\n       END AS KEY_3X       -- お客さま登録番号\n       \n      ,CASE WHEN SERVICE_KEY_TYPE1='004' THEN SERVICE_KEY1\n            WHEN SERVICE_KEY_TYPE2='004' THEN SERVICE_KEY2\n            WHEN SERVICE_KEY_TYPE3='004' THEN SERVICE_KEY3\n            ELSE NULL\n       END AS KEY_4X    -- ガス使用契約番号\n\n      ,CASE WHEN SERVICE_KEY_TYPE1='007' THEN SERVICE_KEY1\n            WHEN SERVICE_KEY_TYPE2='007' THEN SERVICE_KEY2\n            WHEN SERVICE_KEY_TYPE3='007' THEN SERVICE_KEY3\n            ELSE NULL\n       END AS SA_ID  -- 電力契約番号\n\n      ,SERVICE_TYPE --サービス契約種別\n      ,TRANSFER_YMD --サービス契約異動日\n      \nFROM (\n    -- 利用サービスの重複削除\n    SELECT\n        *\n    FROM(\n        SELECT \n              *\n              ,ROW_NUMBER() OVER (\n                  PARTITION BY BX,MTGID,INDEX_ID,\n                           USER_KEY_TYPE,USER_KEY,SERVICE_TYPE,ROLE_TYPE,ROLE_TRANSFER_YMD,\n                           SERVICE_KEY_TYPE1,SERVICE_KEY1,SERVICE_KEY_TYPE2,SERVICE_KEY2,SERVICE_KEY_TYPE3,SERVICE_KEY3,\n                           SERVICE_KEY_START_YMD,OUTPUT_DATE,UPDATE_FLAG,UAD_FLAG,PURGE_DATE\n              ORDER BY TRANSFER_YMD DESC,TRANSFER_TYPE DESC \n              ) ROWNUM\n        FROM [omni].[omni_ods_cloak_trn_usageservice_mtgid]\n    )tmp\n    WHERE ROWNUM=1 AND TRANSFER_TYPE='02'\n)tmp2\n;\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "TGContractScore"
                },
                "annotations": [],
                "lastPublishTime": "2023-11-15T02:32:47Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Insert_ClientDmBx')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "顧客DMにBxを付与し作業テーブルに出力する",
                "activities": [
                    {
                        "name": "at_Insert_ClientDmBx",
                        "description": "ODS_顧客DMにODS_利用サービスのBxを付与し、作業テーブルに出力する",
                        "type": "Script",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "-- 「Bx、4x」が同一のレコードが複数存在するため、「Bx、4x」ごとに1レコードになるように絞り込む\nTRUNCATE TABLE [omni].[omni_ods_cloak_trn_usageservice_bx4x_temp]; -- 利用サービスBx4x\n\nINSERT INTO [omni].[omni_ods_cloak_trn_usageservice_bx4x_temp]     -- 利用サービスBx4x\nSELECT\n     Bx\n    ,KEY_4X\n    ,INDEX_ID\n    ,TRANSFER_YMD          -- サービス契約異動日\n    ,SERVICE_KEY_START_YMD -- サービス契約キー適用日\n    ,OUTPUT_DATE           -- 出力日時\nFROM (\n    SELECT\n         *\n        ,row_number() over (partition by BX,KEY_4X order by OUTPUT_DATE desc,TRANSFER_YMD desc,SERVICE_KEY_START_YMD desc) as ROWNUM\n\n    FROM (\n        SELECT\n             Bx\n\n            ,CASE WHEN SERVICE_KEY_TYPE1='004' THEN SERVICE_KEY1\n                  WHEN SERVICE_KEY_TYPE2='004' THEN SERVICE_KEY2\n                  WHEN SERVICE_KEY_TYPE3='004' THEN SERVICE_KEY3\n                  ELSE NULL\n             END as KEY_4X\n\n            ,INDEX_ID\n            ,TRANSFER_YMD             -- サービス契約異動日\n            ,SERVICE_KEY_START_YMD    -- サービス契約キー適用日\n            ,OUTPUT_DATE              -- 出力日時\n        FROM [omni].[omni_ods_cloak_trn_usageservice] -- 利用サービス\n        WHERE SERVICE_TYPE='001'      -- サービス契約種別=ガス契約\n              and TRANSFER_TYPE='02'  -- 異動種別=提供中\n    )tmp1\n)tmp2\n\nWHERE ROWNUM=1  -- 「Bx,4x」が一致するレコードのうち、最新のレコードを抽出する\n;\n\n-- 「Bx、3x、SA_ID」が同一のレコードが複数存在するため、「Bx、3x、SA_ID」ごとに1レコードになるように絞り込む\nTRUNCATE TABLE [omni].[omni_ods_cloak_trn_usageservice_bx3xsaid_temp]; -- 利用サービスBx3xSA_ID\n\nINSERT INTO [omni].[omni_ods_cloak_trn_usageservice_bx3xsaid_temp]     -- 利用サービスBx3xSA_ID\nSELECT\n     Bx\n    ,KEY_3X\n    ,KEY_SA_ID\n    ,INDEX_ID\n    ,TRANSFER_YMD          -- サービス契約異動日\n    ,SERVICE_KEY_START_YMD -- サービス契約キー適用日\n    ,OUTPUT_DATE           -- 出力日時\nFROM (\n    SELECT\n         *\n        ,row_number() over (partition by BX,KEY_3X,KEY_SA_ID order by OUTPUT_DATE desc,TRANSFER_YMD desc,SERVICE_KEY_START_YMD desc) as ROWNUM\n\n    FROM (\n        SELECT\n             Bx\n            ,USER_KEY as KEY_3X\n\n            ,CASE WHEN SERVICE_KEY_TYPE1='007' THEN SERVICE_KEY1\n                  WHEN SERVICE_KEY_TYPE2='007' THEN SERVICE_KEY2\n                  WHEN SERVICE_KEY_TYPE3='007' THEN SERVICE_KEY3\n                  ELSE NULL\n             END as KEY_SA_ID\n\n            ,INDEX_ID\n            ,TRANSFER_YMD             -- サービス契約異動日\n            ,SERVICE_KEY_START_YMD    -- サービス契約キー適用日\n            ,OUTPUT_DATE              -- 出力日時\n        FROM [omni].[omni_ods_cloak_trn_usageservice] -- 利用サービス\n        WHERE SERVICE_TYPE='006'      -- サービス契約種別=電気契約\n            and TRANSFER_TYPE='02'    -- 異動種別=提供中\n            and USER_KEY_TYPE='003'   -- ユーザキー種別=お客様登録番号(3x)\n    )tmp1\n)tmp2\n\nWHERE ROWNUM=1  -- 「Bx,3x,SA_ID」が一致するレコードのうち、最新のレコードを抽出する\n;\n\n-- 顧客DMにBxを付与する\n-- ①ガス契約あり\nTRUNCATE TABLE [omni].[omni_ods_marketing_trn_client_dm_bx_temp];\n\nINSERT INTO [omni].[omni_ods_marketing_trn_client_dm_bx_temp]\nSELECT\n      usv.BX\n     ,usv.INDEX_ID\n     ,usv.TRANSFER_YMD             -- サービス契約異動日\n     ,usv.SERVICE_KEY_START_YMD    -- サービス契約キー適用日\n     ,usv.OUTPUT_DATE              -- 出力日時\n\n     ,cldm.*\n\nFROM [omni].[omni_ods_marketing_trn_client_dm] cldm    -- 顧客DM\n\nLEFT JOIN [omni].[omni_ods_cloak_trn_usageservice_bx4x_temp] usv -- 利用サービスBx4x\n    ON cldm.LIV0EU_4X=usv.KEY_4X\n\nWHERE cldm.LIV0EU_4X is not NULL -- ガス契約あり\n;\n\n-- ②電気契約単独\nINSERT INTO [omni].[omni_ods_marketing_trn_client_dm_bx_temp]\nSELECT\n      usv.BX\n     ,usv.INDEX_ID\n     ,usv.TRANSFER_YMD             -- サービス契約異動日\n     ,usv.SERVICE_KEY_START_YMD    -- サービス契約キー適用日\n     ,usv.OUTPUT_DATE              -- 出力日時\n\n     ,cldm.*\n\nFROM [omni].[omni_ods_marketing_trn_client_dm] cldm    -- 顧客DM\n\nLEFT JOIN [omni].[omni_ods_cloak_trn_usageservice_bx3xsaid_temp] usv -- 利用サービスBx3xSA_ID\n    ON cldm.EPCISCRT_3X=usv.KEY_3X -- 3x\n       and isnull(cldm.EPCISCRT_LIGHTING_SA_ID,cldm.EPCISCRT_POWER_SA_ID) = KEY_SA_ID -- 電力契約番号(SA_ID)\nWHERE cldm.LIV0EU_4X is NULL    -- ガス契約なし\n;\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "Marketing"
                },
                "annotations": [],
                "lastPublishTime": "2024-05-09T02:07:22Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Send_Cpkiyk')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "DAM-DB「本人特定契約」IFに必要なデータを抽出、gzipファイルでBLOB出力し、SFMCにSFTP連携する。",
                "activities": [
                    {
                        "name": "at_CreateCSV_Cpkiyk",
                        "description": "DBから「本人特定契約」IFに必要なデータを抽出、gzipファイルでBLOB出力",
                        "type": "Copy",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "SqlDWSource",
                                "sqlReaderQuery": "--------------------------------------------------------------------------\n-- 本人特定契約_IF連携＞ADF整備\n--------------------------------------------------------------------------\n\n-- テーブル「本人特定契約」からMA向けの項目を抽出する\nDECLARE @today_jst datetime;\nSET @today_jst=CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');  -- 最新の日時\nDECLARE @outDT varchar(20);\nSET @outDT=format(@today_jst, 'yyyy/MM/dd HH:mm:ss')\n\n----------------------------------------------------------------------------\n\nSELECT\n     MTGID          -- 会員ID\n    ,EDA_NO         -- 枝番\n    ,GMT_SET_NO     -- ガスメータ設置場所番号\n    ,SYOKY_NO       -- 使用契約番号\n    ,CST_REG_NO     -- お客さま登録番号\n    ,SHRKY_NO       -- 支払契約番号\n    ,HJ_CST_NAME    -- 表示名称\n    ,YUSEN_JNJ_NO   -- 優先順位\n    ,TKTIYMD        -- 特定年月日\n    ,TRKSBTCD       -- 種別コード\n    ,CST_NO         -- 表示用お客さま番号\n    ,INTRA_TRK_ID   -- イントラ登録ID\n    ,SND_UM_CD      -- ホスト送信有無コード\n    ,TRK_SBT_CD     -- 登録種別コード\n    ,REC_REG_YMD    -- レコード登録年月日\n    ,REC_REG_JKK    -- レコード登録時刻\n    ,REC_UPD_YMD    -- レコード更新年月日\n    ,REC_UPD_JKK    -- レコード更新時刻\n    ,TAIKAI_FLAG    -- 退会フラグ\n\n    ,@outDT as OUTPUT_DATETIME -- 出力日付\nFROM [omni].[omni_ods_mytginfo_trn_cpkiyk] -- 本人特定契約\n;\n",
                                "queryTimeout": "02:00:00",
                                "partitionOption": "None"
                            },
                            "sink": {
                                "type": "DelimitedTextSink",
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextWriteSettings",
                                    "quoteAllText": true,
                                    "fileExtension": ".csv"
                                }
                            },
                            "enableStaging": false,
                            "translator": {
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": true,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_DamDwhTable_shir",
                                "type": "DatasetReference",
                                "parameters": {
                                    "table": "--"
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_CSV_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/Cpkiyk",
                                    "columnDelimiter": ",",
                                    "quoteChar": "\"",
                                    "firstRowAsHeader": true,
                                    "filename": {
                                        "value": "@concat('Cpkiyk_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "at_SendSftp_Cpkiyk",
                        "description": "Blobに出力されたgzipファイルをSFMCにSFTP連携",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "at_CreateCSV_Cpkiyk",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:30:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/Cpkiyk",
                                    "filename": {
                                        "value": "@concat('Cpkiyk_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/Cpkiyk",
                                    "filename": {
                                        "value": "@concat('Cpkiyk_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "SMC"
                },
                "annotations": [],
                "lastPublishTime": "2025-05-09T02:34:48Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Send_ClientDM')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "DAM-DBから「顧客」IFに必要なデータを抽出、gzipファイルでBLOB出力し、SFMCにSFTP連携する。",
                "activities": [
                    {
                        "name": "at_CreateCSV_ClientDM",
                        "description": "DBから「顧客」IFに必要なデータを抽出、gzipファイルでBLOB出力",
                        "type": "Copy",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "SqlDWSource",
                                "sqlReaderQuery": "--------------------------------------------------------------------------\n-- 顧客DM_IF連携＞ADF整備（SFTP送信）\n-- \n-- 2024/02/20　新規作成\n-- 2024/04/22　レイアウト変更に伴う、カラム追加（391行目～446行目）\n--------------------------------------------------------------------------\n\n-- IF出力日時の宣言\nDECLARE @outputDT varchar(20);\n-- 取得した日時をyyyy/MM/dd HH:mm:ssに変換する\nSET @outputDT = format(CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'), 'yyyy/MM/dd HH:mm:ss');\n\n-- 置換対象文字の宣言\nDECLARE @replacementNCHAR nvarchar(30);\n-- 置換対象文字の定義(NCHAR(13) = CR, NCHAR(10) = LF)\nSET @replacementNCHAR = ',' + NCHAR(13) + NCHAR(10) + '\"';\n\n-- 作業テーブル「顧客DM_Bx付_temp」からMA向けの項目を抽出する\nSELECT\n     ROW_NUMBER() OVER(ORDER BY USAGESERVICE_BX ASC, LIV0EU_4X ASC, LIV0EU_1X ASC, LIV0EU_8X ASC, EPCISCRT_3X ASC, LIV0EU_2X ASC) AS CONNECTION_KEY --接続キー\n    ,USAGESERVICE_BX                             --利用サービス_Bx\n    ,USAGESERVICE_INDEX_ID                       --利用サービス_インデックス番号\n    ,USAGESERVICE_TRANSFER_YMD                   --利用サービス_サービス契約異動日\n    ,SERVICE_KEY_START_YMD                       --利用サービス_サービス契約キー適用日\n    ,USAGESERVICE_OUTPUT_DATE                    --利用サービス_出力日時\n    ,CLIENT_KEY_AX                               --顧客キー_Ax\n    ,LIV0EU_1X                                   --LIV0EU_ガスメータ設置場所番号_1x\n    ,LIV0EU_8X                                   --LIV0EU_カスタマ番号_8x\n    ,LIV0EU_UKMT_NW_PART_CD                      --LIV0EU_受持ＮＷ箇所コード\n    ,LIV0EU_UKMT_NW_PART_CORP_NAME               --LIV0EU_受持ＮＷ箇所_法人名\n    ,LIV0EU_NEW_CORP_AGG_CD                      --LIV0EU_新社集計箇所コード\n    ,LIV0EU_APPLY_START_YMD                      --LIV0EU_適用開始年月日\n    ,LIV0EU_APPLY_END_YMD                        --LIV0EU_適用終了年月日\n    ,LIV0EU_4X                                   --LIV0EU_使用契約番号_4x\n    ,LIV0EU_2X                                   --LIV0EU_支払契約番号_2x\n    ,LIV0EU_ZIP_CD                               --LIV0EU_郵便番号\n    ,LIV0EU_PERF_KJ                              --LIV0EU_都道府県名漢字\n    ,LIV0EU_GYOK_CD                              --LIV0EU_行政区画コード\n    ,LIV0EU_GYOK_NAME                            --LIV0EU_行政区名\n    ,LIV0EU_STREET_CD                            --LIV0EU_町コード\n    ,LIV0EU_STREET_MAME                          --LIV0EU_町名\n    ,LIV0EU_CITY_BLOCK_CD                        --LIV0EU_丁目_字コード\n    ,LIV0EU_BLD_NO                               --LIV0EU_建物番号\n    ,LIV0EU_SHINSETSU_YM                         --LIV0EU_新設年月\n    ,LIV0EU_INNER_TUBE_EQP_STATE_CD              --LIV0EU_供内管設備状態コード\n    ,LIV0EU_GAS_METER_CLOSING_CD                 --LIV0EU_ガスメータ開閉栓状態コード\n    ,LIV0EU_USAGE_CD                             --LIV0EU_用途コード\n    ,LIV0EU_GAS_USAGE_AP_DT_CLASS                --LIV0EU_ガス用途_集合・戸建分類\n    ,LIV0EU_GAS_USAGE_MAJOR_CLASS                --LIV0EU_ガス用途_大分類\n    ,LIV0EU_GAS_USAGE_MIDIUM_CLASS               --LIV0EU_ガス用途_中分類\n    ,LIV0EU_GAS_USAGE_MINOR_CLASS                --LIV0EU_ガス用途_小分類\n    ,LIV0EU_GAS_USAGE_HOME_USE_DETAIL            --LIV0EU_ガス用途_家庭用詳細\n    ,LIV0EU_GAS_USAGE_BIZ_USE_DETAIL             --LIV0EU_ガス用途_業務用詳細\n    ,LIV0EU_GAS_USAGE_12_SEGMENT_CLASS           --LIV0EU_ガス用途_12セグメント分類\n    ,LIV0EU_GAS_USAGE_TOSHI_ENE_MAJOR_CLASS      --LIV0EU_ガス用途_都市エネ大分類\n    ,LIV0EU_GAS_USAGE_TOSHI_ENE_MINOR_CLASS      --LIV0EU_ガス用途_都市エネ小分類\n    ,LIV0EU_GAS_USAGE_TOSHI_ENE_PUBOFF_FLG       --LIV0EU_ガス用途_都市エネ官公庁フラグ\n    ,LIV0EU_METER_NUMBER_FLOW_RATE               --LIV0EU_メータ号数流量\n    ,LIV0EU_READING_METER_METHOD_NAME            --LIV0EU_検針方法名称\n    ,LIV0EU_GAS_PAY_METHOD_CD                    --LIV0EU_ガス料金支払方法コード\n    ,LIV0EU_GAS_PAY_METHOD                       --LIV0EU_ガス料金支払方法\n    ,LIV0EU_CHARGE_G_CD                          --LIV0EU_料金Ｇコード\n    ,LIV0EU_CHARGE_G_AREA_TYPE_CD                --LIV0EU_料金Ｇエリア区分コード\n    ,LIV0EU_BLOCK_NUMBER                         --LIV0EU_ブロック番号\n    ,LIV0EU_GAS_SHRI_CRT_SHBT_CD                 --LIV0EU_ガス料金契約種別コード\n    ,LIV0EU_GAS_SHRI_CRT_SHBT_CD_NAME            --LIV0EU_ガス料金契約種別コード契約種名\n    ,LIV0EU_GAS_SHRI_CRT_SHBT_CD_CRT_DETAILS     --LIV0EU_ガス料金契約種別コード契約種細目名\n    ,LIV0EU_KSY_NAME                             --LIV0EU_管理課所名称\n    ,LIV0EU_TEIHO_METRO_SIGN                     --LIV0EU_定保メトロサイン\n    ,LIV0EU_TEIHO_METRO_SIGN_NAME                --LIV0EU_定保メトロサイン名称\n    ,LIV0EU_TEIHO_HOUSING_SITUATION_NAME         --LIV0EU_定保在宅状況名称\n    ,LIV0EU_OPENING_REASON_NAME                  --LIV0EU_開栓事由名称\n    ,LIV0EU_HOME_OWNER_TYPE_NAME                 --LIV0EU_住宅施主区分名称\n    ,LIV0EU_HOME_OWNERSHIP_TYPE_NAME             --LIV0EU_住宅所有区分名称\n    ,LIV0EU_CIS_DM_REFUAL_SING                   --LIV0EU_CIS_ＤＭ拒否サイン\n    ,LIV0EU_CIS_SERVICE_UM_CD                    --LIV0EU_CIS_サービス情報有無コード\n    ,LIV0EU_LSYR_TOTAL_USE                       --LIV0EU_前年総使用量\n    ,LIV0EU_HEAVY_USE_JYUYOUKA_FLG               --LIV0EU_多使用需要家フラグ\n    ,LIV0EU_INCHANGE_NW_LIFEVAL_ENESUTA_BRI      --LIV0EU_受持NW箇所_ライフバル・エネスタ分類\n    ,LIV0EU_INCHANGE_NW_LIFEVAL_ENESUTA_NAME     --LIV0EU_受持NW箇所_ライフバル・エネスタ名\n    ,LIV0EU_OPENING_MONTH_PASSED                 --LIV0EU_開栓後経過月\n    ,LIV0EU_OPENING_MONTH_PASSED_CATEGORY        --LIV0EU_開栓後経過月カテゴリ\n    ,TEIHO_TYPE                                  --定保区分\n    ,LIV0SPD_KONRO_SHBT                          --LIV0共有所有機器_コンロ種別\n    ,LIV0SPD_KONRO_SHBT_NAME                     --LIV0共有所有機器_コンロ種別名\n    ,LIV0SPD_KONRO_POSSESSION_EQUIPMENT_NO       --LIV0共有所有機器_コンロ_所有機器番号\n    ,LIV0SPD_KONRO_SL_DEST_CD                    --LIV0共有所有機器_コンロ_販売先コード\n    ,LIV0SPD_KONRO_DT_MANUFACTURE                --LIV0共有所有機器_コンロ_製造年月\n    ,LIV0SPD_KONRO_NUM_YEAR                      --LIV0共有所有機器_コンロ_経年数\n    ,LIV0SPD_KONRO_NUM_YEAR_CATEGORY             --LIV0共有所有機器_コンロ_経年数カテゴリ\n    ,LIV0SPD_KYTK_SHBT                           --LIV0共有所有機器_給湯機種別\n    ,LIV0SPD_KYTK_NAME                           --LIV0共有所有機器_給湯機種名称\n    ,LIV0SPD_KYTK_POSSESSION_DEVICE_NO           --LIV0共有所有機器_給湯器_所有機器番号\n    ,LIV0SPD_KYTK_SL_DESTINATION_CD              --LIV0共有所有機器_給湯器_販売先コード\n    ,LIV0SPD_KYTK_DT_MANUFACTURE                 --LIV0共有所有機器_給湯器_製造年月\n    ,LIV0SPD_KYTK_NUM_YEAR                       --LIV0共有所有機器_給湯器_経年数\n    ,LIV0SPD_KYTK_NUM_YEAR_CATEGORY              --LIV0共有所有機器_給湯器_経年数カテゴリ\n    ,LIV0SPD_210_RICE_COOKER                     --LIV0共有所有機器_210_炊飯器\n    ,LIV0SPD_220_MICROWAVE                       --LIV0共有所有機器_220_レンジ\n    ,LIV0SPD_230_OVEN                            --LIV0共有所有機器_230_オーブン\n    ,LIV0SPD_240_CONVECTION_OVEN                 --LIV0共有所有機器_240_コンベック\n    ,LIV0SPD_250_COMBINATION_MICROWAVE           --LIV0共有所有機器_250_コンビネーションレンジ\n    ,LIV0SPD_300_DRYING_MACHINE                  --LIV0共有所有機器_300_乾燥機ほか\n    ,LIV0SPD_310_DRIER                           --LIV0共有所有機器_310_ドライヤー（衣類乾燥機）\n    ,LIV0SPD_410_WIRE_MESH_STOVE                 --LIV0共有所有機器_410_金網ストーブ\n    ,LIV0SPD_420_OPEN_STOVE                      --LIV0共有所有機器_420_開放型ストーブ\n    ,LIV0SPD_430_FH_STOVE                        --LIV0共有所有機器_430_FHストーブ\n    ,LIV0SPD_440_BF_STOVE                        --LIV0共有所有機器_440_BFストーブ\n    ,LIV0SPD_450_FF_STOVE                        --LIV0共有所有機器_450_FFストーブ\n    ,LIV0SPD_460_FE_STOVE                        --LIV0共有所有機器_460_FEストーブ\n    ,TESHSMC_SERIAL_NUMBER                       --TES熱源機情報_製造番号\n    ,TESHSMC_SYSTEM_SHBT                         --TES熱源機情報_システム種別\n    ,TESHSEQ_SYSTEM_COMPLETION_DATE              --TES熱源機情報_システム落成日\n    ,TESHSEQ_MAINTENANCE_TYPE_CD                 --TES熱源機情報_メンテ区分コード\n    ,TESHSEQ_OWNER_TYPE_CD                       --TES熱源機情報_所有形態コード\n    ,TESHSEQ_ATTACHMENT_YMD                      --TES熱源機情報_取付年月日\n    ,TESHSEQ_REMOVAL_YMD                         --TES熱源機情報_取外年月日\n    ,TESHSEQ_TES_MAINT_ELIGIBILITY               --TES熱源機情報_TESメンテ加入資格有無\n    ,TESHRDTR_UNDER_FLOOR_HEATING                --TES放熱器情報_床暖房有無\n    ,TESHRDTR_BATH_HEATING                       --TES放熱器情報_バス暖房有無\n    ,TESSV_MAINTENANCE_JOIN                      --TESサービス情報_TESメンテ加入有無\n    ,TESSV_SERVICE_ID                            --TESサービス情報_サービス番号\n    ,TESSV_SERVICE_EXPIRATION_YM                 --TESサービス情報_サービス満了年月\n    ,TESSV_SERVICE_SHBT                          --TESサービス情報_サービス種別\n    ,ARMC_COUNT                                  --警報機情報_警報器台数\n    ,ARMC_REMOVED_FLG                            --警報機情報_警報器取外し済みフラグ\n    ,ARMC_UNDER_LEASE_FLG                        --警報機情報_警報器リース中フラグ\n    ,ARMC_LEASE_END_FLG                          --警報機情報_警報器リース終了フラグ\n    ,EPCISCRT_3X                                 --電力CIS契約情報_お客様登録番号_3x\n    ,EPCISCRT_LIGHTING_SA_ID                     --電力CIS契約情報_電灯_電力契約番号\n    ,EPCISCRT_LIGHTING_START_USE_DATE            --電力CIS契約情報_電灯_使用開始日\n    ,EPCISCRT_LIGHTING_END_USE_DATE              --電力CIS契約情報_電灯_使用中止日\n    ,EPCISCRT_LIGHTING_CRT_STATUS                --電力CIS契約情報_電灯_契約ステータス\n    ,EPCISCRT_LIGHTING_RESN_DISCONTION_USE       --電力CIS契約情報_電灯_使用中止理由\n    ,EPCISCRT_LIGHTING_CRT_TYPE                  --電力CIS契約情報_電灯_契約タイプ\n    ,EPCISCRT_LIGHTING_CRT_TYPE_NAME             --電力CIS契約情報_電灯_契約タイプ_名称\n    ,EPCISCRT_LIGHTING_CRT_TYPE_COMBIN_SINGLE    --電力CIS契約情報_電灯_契約タイプ_合算・単独分類\n    ,EPCISCRT_LIGHTING_SHRI_METHOD               --電力CIS契約情報_電灯_支払方法\n    ,EPCISCRT_LIGHTING_SHRI_METHOD_NAME          --電力CIS契約情報_電灯_支払方法名\n    ,EPCISCRT_LIGHTING_PRICE_MENU                --電力CIS契約情報_電灯_料金メニュー\n    ,EPCISCRT_LIGHTING_PRICE_MENU_NAME           --電力CIS契約情報_電灯_料金メニュー名\n    ,EPCISCRT_LIGHTING_CRT_ELECT_CURRENT         --電力CIS契約情報_電灯_契約電流\n    ,EPCISCRT_LIGHTING_CRT_CAPACITY              --電力CIS契約情報_電灯_契約容量\n    ,EPCISCRT_LIGHTING_CRT_ELECT_POWER           --電力CIS契約情報_電灯_契約電力\n    ,EPCISCRT_LIGHTING_CRT_ELECT_POWER_KW        --電力CIS契約情報_電灯_契約電力kW換算値\n    ,EPCISCRT_LIGHTING_USAGE_CD                  --電力CIS契約情報_電灯_用途コード\n    ,EPCISCRT_LIGHTING_ELECT_USAGE_NAME          --電力CIS契約情報_電灯_電気用途名\n    ,EPCISCRT_LIGHTING_ELECT_USAGE_BRI           --電力CIS契約情報_電灯_電気用途分類\n    ,EPCISCRT_LIGHTING_USAGE_FAMILY_DETAIL       --電力CIS契約情報_電灯_電気用途家庭用詳細\n    ,EPCISCRT_POWER_SA_ID                        --電力CIS契約情報_動力_電力契約番号\n    ,EPCISCRT_POWER_START_USE_DATE               --電力CIS契約情報_動力_使用開始日\n    ,EPCISCRT_POWER_END_USE_DATE                 --電力CIS契約情報_動力_使用中止日\n    ,EPCISCRT_POWER_CRT_STATUS                   --電力CIS契約情報_動力_契約ステータス\n    ,EPCISCRT_POWER_RESN_DISCONTION_USE          --電力CIS契約情報_動力_使用中止理由\n    ,EPCISCRT_POWER_CRT_TYPE                     --電力CIS契約情報_動力_契約タイプ\n    ,EPCISCRT_POWER_CRT_TYPE_NAME                --電力CIS契約情報_動力_契約タイプ_名称\n    ,EPCISCRT_POWER_CRT_TYPE_COMBIN_SINGLE       --電力CIS契約情報_動力_契約タイプ_合算・単独分類\n    ,EPCISCRT_POWER_SHRI_METHOD                  --電力CIS契約情報_動力_支払方法\n    ,EPCISCRT_POWER_SHRI_METHOD_NAME             --電力CIS契約情報_動力_支払方法名\n    ,EPCISCRT_POWER_PRICE_MENU                   --電力CIS契約情報_動力_料金メニュー\n    ,EPCISCRT_POWER_PRICE_MENU_NAME              --電力CIS契約情報_動力_料金メニュー名\n    ,EPCISCRT_POWER_CRT_ELECT_CURRENT            --電力CIS契約情報_動力_契約電流\n    ,EPCISCRT_POWER_CRT_CAPACITY                 --電力CIS契約情報_動力_契約容量\n    ,EPCISCRT_POWER_CRT_ELECT_POWER              --電力CIS契約情報_動力_契約電力\n    ,EPCISCRT_POWER_CRT_ELECT_POWER_KW           --電力CIS契約情報_動力_契約電力kW換算値\n    ,EPCISCRT_POWER_USAGE_CD                     --電力CIS契約情報_動力_用途コード\n    ,EPCISCRT_POWER_ELECT_USAGE_NAME             --電力CIS契約情報_動力_電気用途名\n    ,EPCISCRT_POWER_ELECT_USAGE_BRI              --電力CIS契約情報_動力_電気用途分類\n    ,EPCISCRT_POWER_ELECT_USAGE_FAMILY_DETAIL    --電力CIS契約情報_動力_電気用途家庭用詳細\n    ,EPCISCRT_ELECT_UNDER_CRT_FLG                --電力CIS契約情報_電力契約中フラグ\n    ,EPCISCRT_ELECT_CANCELLED_FLG                --電力CIS契約情報_電力解約済みフラグ\n    ,EPCISCRT_LIGHTING_CONTRACT_COUNT            --電力CIS契約情報_電灯契約数\n    ,EPCISCRT_POWER_CONTRACT_CRT_COUNT           --電力CIS契約情報_動力契約数\n    ,EPCISCRT_LIGHTING_TOTAL_KW                  --電力CIS契約情報_電灯合計kW\n    ,EPCISCRT_POWER_CONTRACT_TOTAL_KW            --電力CIS契約情報_動力合計kW\n    ,EPCISCLM_2018_DNRKSIYO                      --電力CIS請求情報_2018年度電気使用量\n    ,EPCISCLM_2018_DNRKRYO                       --電力CIS請求情報_2018年度電気料金\n    ,EPCISCLM_2019_DNRKSIYO                      --電力CIS請求情報_2019年度電気使用量\n    ,EPCISCLM_2019_DNRKRYO                       --電力CIS請求情報_2019年度電気料金\n    ,EPCISCLM_2020_DNRKSIYO                      --電力CIS請求情報_2020年度電気使用量\n    ,EPCISCLM_2020_DNRKRYO                       --電力CIS請求情報_2020年度電気料金\n    ,EPCISCLM_2021_DNRKSIYO                      --電力CIS請求情報_2021年度電気使用量\n    ,EPCISCLM_2021_DNRKRYO                       --電力CIS請求情報_2021年度電気料金\n    ,CISDWH_DISTRICT_CD                          --CISDWH_地区コード\n    ,CISDWH_CALORIE_CORRECTION_USAGE_1YEAR       --CISDWH_熱量補正使用量_直近1年\n    ,CISDWH_SALES_AMOUNT_1YEAR                   --CISDWH_販売金額_直近1年\n    ,CISDWH_2018_GASSIYO                         --CISDWH_2018年度ガス使用量\n    ,CISDWH_2018_GASRYO                          --CISDWH_2018年度ガス料金\n    ,CISDWH_2019_GASSIYO                         --CISDWH_2019年度ガス使用量\n    ,CISDWH_2019_GASRYO                          --CISDWH_2019年度ガス料金\n    ,CISDWH_2020_GASSIYO                         --CISDWH_2020年度ガス使用量\n    ,CISDWH_2020_GASRYO                          --CISDWH_2020年度ガス料金\n    ,CISDWH_2021_GASSIYO                         --CISDWH_2021年度ガス使用量\n    ,CISDWH_2021_GASRYO                          --CISDWH_2021年度ガス料金\n    ,EPCISRPN_START_APPLI_FLG                    --電力CIS受付情報_開始申込フラグ\n    ,EPCISRPN_START_ELECT_RECEPT_DBRI            --電力CIS受付情報_開始電力受付方法（大分類）\n    ,EPCISRPN_START_ELECT_RECEPT_SBRI            --電力CIS受付情報_開始電力受付方法（小分類）\n    ,Format(EPCISRPN_START_RECEPT_DT, 'yyyy/MM/dd') AS EPCISRPN_START_RECEPT_DT --電力CIS受付情報_開始受付日\n    ,EPCISRPN_SUSPNTIN_RECEPT_FLG                --電力CIS受付情報_中止申込フラグ\n    ,EPCISRPN_SUSPNTIN_ELECT_RECEPT_MAJOR_CLS    --電力CIS受付情報_中止電力受付方法（大分類）\n    ,EPCISRPN_SUSPNTIN_ELECT_RECEPT_MINOR_CLS    --電力CIS受付情報_中止電力受付方法（小分類）\n    ,Format(EPCISRPN_SUSPNTIN_RECEPT_DT, 'yyyy/MM/dd') AS EPCISRPN_SUSPNTIN_RECEPT_DT --電力CIS受付情報_中止受付日\n    ,LIV1CSWK_OPENING_FLG_1YEAR                  --LIV1案件業務_開栓フラグ_1年以内\n    ,LIV1CSWK_CLOSING_FLG_1YEAR                  --LIV1案件業務_閉栓フラグ_1年以内\n    ,LIV1CSWK_SL_FLG_1YEAR                       --LIV1案件業務_販売フラグ_1年以内\n    ,LIV1CSWK_KKSR_FLG_1YEAR                     --LIV1案件業務_機器修理・点検フラグ_1年以内\n    ,LIV1CSWK_ACA_FLG_1YEAR                      --LIV1案件業務_能動的接点活動フラグ_1年以内\n    ,LIV1CSWK_FOLLOWUP_SERVICE_FLG_1YEAR         --LIV1案件業務_アフターフォローフラグ_1年以内\n    ,LIV1CSWK_OTHER_FLG_1YEAR                    --LIV1案件業務_その他フラグ_1年以内\n    ,LIV1CSWK_CASE_ALL_ASPECT_FLG_1YEAR          --LIV1案件業務_案件全般フラグ_1年以内\n    ,LIV1CSWK_OPENING_FLG_2YEAR                  --LIV1案件業務_開栓フラグ_2年以内\n    ,LIV1CSWK_CLOSED_FLG_2YEAR                   --LIV1案件業務_閉栓フラグ_2年以内\n    ,LIV1CSWK_SL_FLG_2YEAR                       --LIV1案件業務_販売フラグ_2年以内\n    ,LIV1CSWK_KKSR_FLG_2YEAR                     --LIV1案件業務_機器修理・点検フラグ_2年以内\n    ,LIV1CSWK_ACA_FLG_2YEAR                      --LIV1案件業務_能動的接点活動フラグ_2年以内\n    ,LIV1CSWK_FOLLOWUP_SERVICE_FLG_2YEAR         --LIV1案件業務_アフターフォローフラグ_2年以内\n    ,LIV1CSWK_OTHER_FLG_2YEAR                    --LIV1案件業務_その他フラグ_2年以内\n    ,LIV1CSWK_CASE_ALL_ASPECT_FLG_2YEAR          --LIV1案件業務_案件全般フラグ_2年以内\n    ,LIV1CSWK_OPENING_FLG_2018                   --LIV1案件業務_開栓フラグ_2018年度\n    ,LIV1CSWK_CLOSED_FLG_2018                    --LIV1案件業務_閉栓フラグ_2018年度\n    ,LIV1CSWK_SL_FLG_2018                        --LIV1案件業務_販売フラグ_2018年度\n    ,LIV1CSWK_KKSR_FLG_2018                      --LIV1案件業務_機器修理・点検フラグ_2018年度\n    ,LIV1CSWK_ACA_FLG_2018                       --LIV1案件業務_能動的接点活動フラグ_2018年度\n    ,LIV1CSWK_FOLLOWUP_SERVICE_FLG_2018          --LIV1案件業務_アフターフォローフラグ_2018年度\n    ,LIV1CSWK_OTHER_FLG_2018                     --LIV1案件業務_その他フラグ_2018年度\n    ,LIV1CSWK_CASE_ALL_ASPECT_FLG_2018           --LIV1案件業務_案件全般フラグ_2018年度\n    ,LIV1CSWK_OPENING_FLG_2019                   --LIV1案件業務_開栓フラグ_2019年度\n    ,LIV1CSWK_CLOSED_FLG_2019                    --LIV1案件業務_閉栓フラグ_2019年度\n    ,LIV1CSWK_SL_FLG_2019                        --LIV1案件業務_販売フラグ_2019年度\n    ,LIV1CSWK_KKSR_FLG_2019                      --LIV1案件業務_機器修理・点検フラグ_2019年度\n    ,LIV1CSWK_ACA_FLG_2019                       --LIV1案件業務_能動的接点活動フラグ_2019年度\n    ,LIV1CSWK_FOLLOWUP_SERVICE_FLG_2019          --LIV1案件業務_アフターフォローフラグ_2019年度\n    ,LIV1CSWK_OTHER_FLG_2019                     --LIV1案件業務_その他フラグ_2019年度\n    ,LIV1CSWK_CASE_ALL_ASPECT_FLG_2019           --LIV1案件業務_案件全般フラグ_2019年度\n    ,LIV1CSWK_OPENING_FLG_2020                   --LIV1案件業務_開栓フラグ_2020年度\n    ,LIV1CSWK_CLOSED_FLG_2020                    --LIV1案件業務_閉栓フラグ_2020年度\n    ,LIV1CSWK_SL_FLG_2020                        --LIV1案件業務_販売フラグ_2020年度\n    ,LIV1CSWK_KKSR_FLG_2020                      --LIV1案件業務_機器修理・点検フラグ_2020年度\n    ,LIV1CSWK_ACA_FLG_2020                       --LIV1案件業務_能動的接点活動フラグ_2020年度\n    ,LIV1CSWK_FOLLOWUP_SERVICE_FLG_2020          --LIV1案件業務_アフターフォローフラグ_2020年度\n    ,LIV1CSWK_OTHER_FLG_2020                     --LIV1案件業務_その他フラグ_2020年度\n    ,LIV1CSWK_CASE_ALL_ASPECT_FLG_2020           --LIV1案件業務_案件全般フラグ_2020年度\n    ,LIV1CSWK_OPENING_FLG_2021                   --LIV1案件業務_開栓フラグ_2021年度\n    ,LIV1CSWK_CLOSED_FLG_2021                    --LIV1案件業務_閉栓フラグ_2021年度\n    ,LIV1CSWK_SL_FLG_2021                        --LIV1案件業務_販売フラグ_2021年度\n    ,LIV1CSWK_KKSR_FLG_2021                      --LIV1案件業務_機器修理・点検フラグ_2021年度\n    ,LIV1CSWK_ACTIVE_CONTACT_ACTIVIT_FLG_2021    --LIV1案件業務_能動的接点活動フラグ_2021年度\n    ,LIV1CSWK_FOLLOWUP_SERVICE_FLG_2021          --LIV1案件業務_アフターフォローフラグ_2021年度\n    ,LIV1CSWK_OTHER_FLG_2021                     --LIV1案件業務_その他フラグ_2021年度\n    ,LIV1CSWK_CASE_ALL_ASPECT_FLG_2021           --LIV1案件業務_案件全般フラグ_2021年度\n    ,LIV1CSWK_OPENING_FLG                        --LIV1案件業務_開栓フラグ_全期間\n    ,LIV1CSWK_CLOSED_FLG                         --LIV1案件業務_閉栓フラグ_全期間\n    ,LIV1CSWK_SL_FLG                             --LIV1案件業務_販売フラグ_全期間\n    ,LIV1CSWK_KKSR_FLG                           --LIV1案件業務_機器修理・点検フラグ_全期間\n    ,LIV1CSWK_ACA_FLG                            --LIV1案件業務_能動的接点活動フラグ_全期間\n    ,LIV1CSWK_AF_FLG                             --LIV1案件業務_アフターフォローフラグ_全期間\n    ,LIV1CSWK_OTHER_FLG                          --LIV1案件業務_その他フラグ_全期間\n    ,LIV1CSWK_CASE_ALL_ASPECT_FLG                --LIV1案件業務_案件全般フラグ_全期間\n    ,LIV2ACMTSL_GASKIKI_ALL_SL_FLG_1YEAR         --LIV2落成実績販売_ガス機器全般販売フラグ_1年以内\n    ,LIV2ACMTSL_EQUIPMENT_ALL_SL_FLG_1YEAR       --LIV2落成実績販売_機器全般販売フラグ_1年以内\n    ,LIV2ACMTSL_HOUSE_FCLTS_ALL_SL_FLG_1YEAR     --LIV2落成実績販売_住設機器・リフォーム全般販売フラグ_1年以内\n    ,LIV2ACMTSL_ALLSL_FLG_1YEAR                  --LIV2落成実績販売_オール販売フラグ_1年以内\n    ,LIV2ACMTSL_GASKIKI_ALL_SL_FLG_2YEAR         --LIV2落成実績販売_ガス機器全般販売フラグ_2年以内\n    ,LIV2ACMTSL_EQUIPMENT_ALL_SL_FLG_2YEAR       --LIV2落成実績販売_機器全般販売フラグ_2年以内\n    ,LIV2ACMTSL_HOUSE_FCLTS_ALL_SL_FLG_2YEAR     --LIV2落成実績販売_住設機器・リフォーム全般販売フラグ_2年以内\n    ,LIV2ACMTSL_ALLSL_FLG_2YEAR                  --LIV2落成実績販売_オール販売フラグ_2年以内\n    ,LIV2ACMTSL_GASKIKI_ALL_SL_FLG_2018          --LIV2落成実績販売_ガス機器全般販売フラグ_2018年度\n    ,LIV2ACMTSL_EQUIPMENT_ALL_SL_FLG_2018        --LIV2落成実績販売_機器全般販売フラグ_2018年度\n    ,LIV2ACMTSL_HOUSE_FCLTS_ALL_SL_FLG_2018      --LIV2落成実績販売_住設機器・リフォーム全般販売フラグ_2018年度\n    ,LIV2ACMTSL_ALLSL_FLG_2018                   --LIV2落成実績販売_オール販売フラグ_2018年度\n    ,LIV2ACMTSL_GASKIKI_ALL_SL_FLG_2019          --LIV2落成実績販売_ガス機器全般販売フラグ_2019年度\n    ,LIV2ACMTSL_EQUIPMENT_ALL_SL_FLG_2019        --LIV2落成実績販売_機器全般販売フラグ_2019年度\n    ,LIV2ACMTSL_HOUSE_FCLTS_ALL_SL_FLG_2019      --LIV2落成実績販売_住設機器・リフォーム全般販売フラグ_2019年度\n    ,LIV2ACMTSL_ALLSL_FLG_2019                   --LIV2落成実績販売_オール販売フラグ_2019年度\n    ,LIV2ACMTSL_GASKIKI_ALL_SL_FLG_2020          --LIV2落成実績販売_ガス機器全般販売フラグ_2020年度\n    ,LIV2ACMTSL_EQUIPMENT_ALL_SL_FLG_2020        --LIV2落成実績販売_機器全般販売フラグ_2020年度\n    ,LIV2ACMTSL_HOUSE_FCLTS_ALL_SL_FLG_2020      --LIV2落成実績販売_住設機器・リフォーム全般販売フラグ_2020年度\n    ,LIV2ACMTSL_ALLSL_FLG_2020                   --LIV2落成実績販売_オール販売フラグ_2020年度\n    ,LIV2ACMTSL_GASKIKI_ALL_SL_FLG_2021          --LIV2落成実績販売_ガス機器全般販売フラグ_2021年度\n    ,LIV2ACMTSL_EQUIPMENT_ALL_SL_FLG_2021        --LIV2落成実績販売_機器全般販売フラグ_2021年度\n    ,LIV2ACMTSL_HOUSE_FCLTS_ALL_SL_FLG_2021      --LIV2落成実績販売_住設機器・リフォーム全般販売フラグ_2021年度\n    ,LIV2ACMTSL_ALLSL_FLG_2021                   --LIV2落成実績販売_オール販売フラグ_2021年度\n    ,LIV2ACMTSL_TES_EJ_SL_FLG                    --LIV2落成実績販売_TES_EJ_販売フラグ_全期間\n    ,LIV2ACMTSL_BATH_EJ_SL_FLG                   --LIV2落成実績販売_風呂給_EJ_販売フラグ_全期間\n    ,LIV2ACMTSL_OOYU_EJ_SL_FLG                   --LIV2落成実績販売_大湯_EJ_販売フラグ_全期間\n    ,LIV2ACMTSL_TES_STD_SL_FLG                   --LIV2落成実績販売_TES_標準_販売フラグ_全期間\n    ,LIV2ACMTSL_BATH_STD_SL_FLG                  --LIV2落成実績販売_風呂給_標準_販売フラグ_全期間\n    ,LIV2ACMTSL_OOYU_STD_SL_FLG                  --LIV2落成実績販売_大湯_標準_販売フラグ_全期間\n    ,LIV2ACMTSL_OTHER_BATH_SL_FLG                --LIV2落成実績販売_その他風呂販売フラグ_全期間\n    ,LIV2ACMTSL_SMALL_WATER_HEATER_SL_FLG        --LIV2落成実績販売_小型湯沸器販売フラグ_全期間\n    ,LIV2ACMTSL_CLOTHES_DRYER_SL_FLG             --LIV2落成実績販売_衣類乾燥機販売フラグ_全期間\n    ,LIV2ACMTSL_BUILD_IN_KONRO_PPT_SL_FLG        --LIV2落成実績販売_ビルトインコンロ_ピピッと_販売フラグ_全期間\n    ,LIV2ACMTSL_BUILD_IN_KONRO_NPPT_SL_FLG       --LIV2落成実績販売_ビルトインコンロ_ピピッと以外_販売フラグ_全期間\n    ,LIV2ACMTSL_TABLE_KONRO_PPT_SL_FLG           --LIV2落成実績販売_テーブルコンロ_ピピッと_販売フラグ_全期間\n    ,LIV2ACMTSL_TABLE_KONRO_NPPT_SL_FLG          --LIV2落成実績販売_テーブルコンロ_ピピッと以外_販売フラグ_全期間\n    ,LIV2ACMTSL_FAN_HEATER_SL_FLG                --LIV2落成実績販売_ファンヒータ販売フラグ_全期間\n    ,LIV2ACMTSL_FLOOR_HEATER_SL_FLG              --LIV2落成実績販売_床暖房販売フラグ_全期間\n    ,LIV2ACMTSL_MIST_SAUNA_SL_FLG                --LIV2落成実績販売_ミストサウナ販売フラグ_全期間\n    ,LIV2ACMTSL_BATHROOM_HEATRE_SL_FLG           --LIV2落成実績販売_浴室暖房乾燥機販売フラグ_全期間\n    ,LIV2ACMTSL_ALARM_SL_FLG                     --LIV2落成実績販売_警報器販売フラグ_全期間\n    ,LIV2ACMTSL_RICE_COOKER_SL_FLG               --LIV2落成実績販売_炊飯器販売フラグ_全期間\n    ,LIV2ACMTSL_FFHU_SL_FLG                      --LIV2落成実績販売_FF暖房機販売フラグ_全期間\n    ,LIV2ACMTSL_STD_STOVE_SL_FLG                 --LIV2落成実績販売_一般ストーブ販売フラグ_全期間\n    ,LIV2ACMTSL_BUILD_IN_MICROWAVE_SL_FLG        --LIV2落成実績販売_ビルトインレンジ販売フラグ_全期間\n    ,LIV2ACMTSL_HIGH_SPEED_OVEN_SL_FLG           --LIV2落成実績販売_高速オーブン販売フラグ_全期間\n    ,LIV2ACMTSL_DISHWASHER_SL_FLG                --LIV2落成実績販売_食器洗い乾燥機販売フラグ_全期間\n    ,LIV2ACMTSL_ECO_WILL_SL_FLG                  --LIV2落成実績販売_エコウイル販売フラグ_全期間\n    ,LIV2ACMTSL_ENEFARM_SL_FLG                   --LIV2落成実績販売_エネファーム販売フラグ_全期間\n    ,LIV2ACMTSL_HEATING_ONLY_RADIATOR_SL_FLG     --LIV2落成実績販売_暖房専用放熱器販売フラグ_全期間\n    ,LIV2ACMTSL_TES_AIR_CON_INDOOR_UN_SL_FLG     --LIV2落成実績販売_TESエアコン室内機販売フラグ_全期間\n    ,LIV2ACMTSL_SOLAMO_SL_FLG                    --LIV2落成実績販売_SOLAMO販売フラグ_全期間\n    ,LIV2ACMTSL_GASKIKI_GENERAL_SL_FLG           --LIV2落成実績販売_ガス機器全般販売フラグ_全期間\n    ,LIV2ACMTSL_EQUIPMENT_GENERAL_SL_FLG         --LIV2落成実績販売_機器全般販売フラグ_全期間\n    ,LIV2ACMTSL_UNIT_SL_FLG                      --LIV2落成実績販売_ユニットバス販売フラグ_全期間\n    ,LIV2ACMTSL_SYSETM_KITCHEN_SL_FLG            --LIV2落成実績販売_システムキッチン販売フラグ_全期間\n    ,LIV2ACMTSL_RANGE_HOOD_SL_FLG                --LIV2落成実績販売_換気扇フード販売フラグ_全期間\n    ,LIV2ACMTSL_WASHBASIN_SL_FLG                 --LIV2落成実績販売_洗面化粧台販売フラグ_全期間\n    ,LIV2ACMTSL_TOILET_SL_FLG                    --LIV2落成実績販売_トイレ販売フラグ_全期間\n    ,LIV2ACMTSL_AIR_CON_SL_FLG                   --LIV2落成実績販売_エアコン販売フラグ_全期間\n    ,LIV2ACMTSL_SUN_LIGHT_SYSTEM_SL_FLG          --LIV2落成実績販売_太陽光システム販売フラグ_全期間\n    ,LIV2ACMTSL_HOUSE_FCLTS_RNV_ALL_SL_FLG       --LIV2落成実績販売_住設機器・リフォーム全般販売フラグ_全期間\n    ,LIV2ACMTSL_ALL_SL_FLG                       --LIV2落成実績販売_オール販売フラグ_全期間\n    ,LIV2AMTAECSL_GASKIKI_ALL_SL_PRICE_1YEAR     --LIV2落成実績税抜実販売金額_ガス機器全般販売_税抜実販売価格合算_1年以内\n    ,LIV2AMTAECSL_EQUIPMENT_ALL_SLPRICE_1YEAR    --LIV2落成実績税抜実販売金額_機器全般販売_税抜実販売価格合算_1年以内\n    ,LIV2AMTAECSL_GASKIKI_ALL_SL_PRICE_2018      --LIV2落成実績税抜実販売金額_ガス機器全般販売_税抜実販売価格合算_2018年度\n    ,LIV2AMTAECSL_EQUIPMENT_ALL_SL_PRICE_2018    --LIV2落成実績税抜実販売金額_機器全般販売_税抜実販売価格合算_2018年度\n    ,LIV2AMTAECSL_GASKIKI_ALL_SL_PRICE_2019      --LIV2落成実績税抜実販売金額_ガス機器全般販売_税抜実販売価格合算_2019年度\n    ,LIV2AMTAECSL_EQUIPMENT_ALL_SL_PRICE_2019    --LIV2落成実績税抜実販売金額_機器全般販売_税抜実販売価格合算_2019年度\n    ,LIV2AMTAECSL_GASKIKI_ALL_SL_PRICE_2020      --LIV2落成実績税抜実販売金額_ガス機器全般販売_税抜実販売価格合算_2020年度\n    ,LIV2AMTAECSL_EQUIPMENT_ALL_SL_PRICE_2020    --LIV2落成実績税抜実販売金額_機器全般販売_税抜実販売価格合算_2020年度\n    ,LIV2AMTAECSL_GASKIKI_ALL_SL_PRICE_2021      --LIV2落成実績税抜実販売金額_ガス機器全般販売_税抜実販売価格合算_2021年度\n    ,LIV2AMTAECSL_EQUIPMENT_ALL_SL_PRICE_2021    --LIV2落成実績税抜実販売金額_機器全般販売_税抜実販売価格合算_2021年度\n    ,LIV2AMTAECSL_GASKIKI_ALL_SL_PRICE           --LIV2落成実績税抜実販売金額_ガス機器全般販売_税抜実販売価格合算_全期間\n    ,LIV2AMTAECSL_EQUIPMENT_ALL_SL_PRICE_EXC     --LIV2落成実績税抜実販売金額_機器全般販売_税抜実販売価格合算_全期間\n    ,COSMOS_PAYMENT_CNTRACT_ID                   --COSMOS設備_支払契約番号\n    ,COSMOS_CNTRACT_SHBT                         --COSMOS設備_契約種別\n    ,COSMOS_CNTRACT_SETTING_REASON               --COSMOS設備_契約設定理由\n    ,COSMOS_CNTRACT_PART                         --COSMOS設備_契約箇所\n    ,COSMOS_MY24_CNTRACT_FLG                     --COSMOS設備_マイツーホー契約フラグ\n    ,Format(COSMOS_MY24_CNTRACT_DT, 'yyyy/MM/dd') AS COSMOS_MY24_CNTRACT_DT --COSMOS設備_マイツーホー契約日\n    ,COSMOS_WATCH_OVER_CNTRACT_FLG               --COSMOS設備_くらし見守り契約フラグ\n    ,Format(COSMOS_WATCH_OVER_CNTRACT_DT, 'yyyy/MM/dd') AS COSMOS_WATCH_OVER_CNTRACT_DT --COSMOS設備_くらし見守り契約日\n    ,Format(COSMOS_SERVICE_START_YMD, 'yyyy/MM/dd') AS COSMOS_SERVICE_START_YMD --COSMOS設備_サービス開始年月日\n    ,COSMOS_MY24_CANCELL_CNTRACT_FLG             --COSMOS設備_マイツーホー解約フラグ\n    ,Format(COSMOS_MY24_CANCELL_CNTRACT_DT, 'yyyy/MM/dd') AS COSMOS_MY24_CANCELL_CNTRACT_DT --COSMOS設備_マイツーホー解約日\n    ,COSMOS_WATCH_OVER_CANCELL_CRT_FLG           --COSMOS設備_くらし見守り解約フラグ\n    ,Format(COSMOS_WATCH_OVER_CANCELL_CRT_DT, 'yyyy/MM/dd') AS COSMOS_WATCH_OVER_CANCELL_CRT_DT --COSMOS設備_くらし見守り解約日\n    ,MATHPROC_YEAR_BUILT                         --数理加工情報_築年数\n    ,MATHPROC_YEAR_BUILT_GROUP_NAME              --数理加工情報_築年グループ名\n    ,MATHPROC_SALE_RENT_CLASS                    --数理加工情報_分譲賃貸分類\n    ,MATHPROC_ANN_GAS_USAGE                      --数理加工情報_年間ガス使用量\n    ,MATHPROC_ANN_GAS_USAGE_CATG                 --数理加工情報_年間ガス使用量CATG\n    ,MATHPROC_ANN_GAS_USAGE_1YEAR_50M_INC        --数理加工情報_年間ガス使用量_直近1年_50m刻み\n    ,MATHPROC_ANN_GAS_USAGE_1YEAR_GYOMU_TYPE     --数理加工情報_年間ガス使用量_直近1年_業務用区分\n    ,MATHPROC_ESTI_DNRK_USAGE                    --数理加工情報_推定電力使用量（ガス使用量などからの推計）\n    ,MATHPROC_ESTI_DNRK_USAGE_CATG               --数理加工情報_推定電力使用量CATG\n    ,ELECT_USAGE                                 --電力使用量（最終的な推計値）\n    ,ELECT_USAGE_500KW_INC                       --電力使用量（最終的な推計値）_500kWh刻み\n    ,MYTG_MYTG_FLG                               --myTG会員情報_myTGフラグ\n    ,MYTG_MEMBER_REGIST_DT                       --myTG会員情報_myTG会員登録日\n    ,MYTG_MTGID                                  --myTG会員情報_myTG会員ID\n    ,MYTG_SEX                                    --myTG会員情報_myTG性別\n    ,MYTG_AGE                                    --myTG会員情報_myTG年代\n    ,ZUTOMO_GAS_TOTAL_ADVANTAGES_AMOUNT          --ずっともガス総メリット額（セットポイント込）\n    ,ZUTOMO_GAS_TOTAL_ADVANTAGES_FLG             --ずっともガス総メリットフラグ（セットポイント込）\n    ,ZUTOMO_ELECT_TOTAL_ADVANTAGES_AMOUNT        --ずっとも電気総メリット額（ポイント込）\n    ,ZUTOMO_ELECT_TOTAL_ADVANTAGES_FLG           --ずっとも電気総メリットフラグ（ポイント込)\n    ,CMBSTNCK_ENFCMNT_FLG                        --燃焼確認_実施フラグ\n    ,CMBSTNCK_ENFCMNT_FLG_2018                   --燃焼確認_2018年度実施フラグ\n    ,CMBSTNCK_ENFCMNT_FLG_2019                   --燃焼確認_2019年度実施フラグ\n    ,CMBSTNCK_ENFCMNT_FLG_2020                   --燃焼確認_2020年度実施フラグ\n    ,CMBSTNCK_ENFCMNT_FLG_2021                   --燃焼確認_2021年度実施フラグ\n    ,Format(CMBSTNCK_MOST_RECENT_ENFCMNT_DT, 'yyyy/MM/dd') AS CMBSTNCK_MOST_RECENT_ENFCMNT_DT --燃焼確認_直近実施日\n    ,TROUBLE_SUPPORT_USE_FLG                     --トラブルサポート利用フラグ\n    ,KAKETSUKE_SERVICE_USE_FLG                   --駆けつけサービス利用フラグ\n    ,SUMASUPP_RECEPT_FLG                         --住まサポ分析_受付フラグ\n    ,SUMASUPP_LATEST_RECEPT_CHANNELS             --住まサポ分析_最新受付チャネル\n    ,SUMASUPP_CASE_ID                            --住まサポ分析_落成フラグ（案件番号）\n    ,SUMASUPP_COMPLETION_FLG                     --住まサポ分析_落成フラグ\n    ,GASDVCSS_SUB_APPLICATE_FLG                  --ガス機器SS_加入申込フラグ\n    ,GASDVCSS_UNDER_CONTRUCT_FLG                 --ガス機器SS_契約中フラグ\n    ,GASDVCSS_CANCELLED_FLG                      --ガス機器SS_解約済フラグ\n    ,GASDVCSS_OP_ELECT_AIRCON_UNDER_CRT_FLG      --ガス機器SS_OP_電気エアコン_契約中フラグ\n    ,GASDVCSS_OP_WATER_UNDER_CRT_FLG             --ガス機器SS_OP_水まわり_契約中フラグ\n    ,GASDVCSS_OP_ELECT_EQP_UNDER_CRT_FLG         --ガス機器SS_OP_電気設備_契約中フラグ\n    ,TRANSLATE(REPLACE(MDBDATA_MGMT_CORP_NAME, NCHAR(13) + NCHAR(10), '_'), @replacementNCHAR, '____') AS MDBDATA_MGMT_CORP_NAME --MDBデータ_管理会社名\n    ,MDBDATA_BLDG_STRUCT                         --MDBデータ_建物構造\n    ,MDBDATA_TOTAL_NUMBER_HOUSES                 --MDBデータ_総戸数\n    ,PUBBLDGLS_PUB_BLDG_TYPE                     --公共建物リスト_公共物件区分\n    ,AGENCY_GAS_MEMBER_FLG                       --取次店ガス加入者フラグ\n    ,AGENCY_NAME                                 --取次店名\n    ,HSCLNG_USE_FLG                              --ハウスクリーニング_ハウスクリーニング利用実績フラグ\n    ,HSCLNG_USE_FLG_1YEAR                        --ハウスクリーニング_ハウスクリーニング利用実績フラグ_直近1年\n    ,HSCLNG_REPEATER_FLG                         --ハウスクリーニング_リピーターフラグ_全期間\n    ,HSCLNG_REPEATER_FLG_1YEAR                   --ハウスクリーニング_リピーターフラグ_直近1年\n    ,HSCLNG_NEW_CUSTOMER_FLG                     --ハウスクリーニング_新規顧客フラグ\n    ,HSCLNG_TARGET_AREA_FLG                      --ハウスクリーニング_対象エリアフラグ\n    ,TGCRM_HEAD_HOUSEHOLD_AGE                    --TGCRM_世帯主年代\n    ,HEAD_HOUSEHOLD_AGE                          --世帯主年代（実績値または推定値）\n    ,HEAD_HOUSEHOLD_AGE_FLG                      --世帯主年代実績値フラグ\n    ,WEBSHOP_ORDER_RESULT_FLG                    --WebShop_注文実績フラグ_全期間\n    ,WEBSHOP_ORDER_RESULT_FLG_1YEAR              --WebShop_注文実績フラグ_直近1年\n    ,WEBSHOP_REPEATER_FLG                        --WebShop_リピーターフラグ_全期間\n    ,WEBSHOP_REPEATER_FLG_1YEAR                  --WebShop_リピーターフラグ_直近1年\n    ,WEBSHOP_NEW_CUSTOMER_FLG                    --WebShop_新規顧客フラグ\n    ,WEBSHOP_ACCUMLATE_ORDER_COUNT               --WebShop_累積注文回数_全期間\n    ,WEBSHOP_ACCUMLATE_ORDER_COUNT_1YEAR         --WebShop_累積注文回数_直近1年間\n    ,Format(WEBHIS_REFERENCE_DATE, 'yyyy/MM/dd') AS WEBHIS_REFERENCE_DATE --WEB履歴_基準日\n    ,WEBHIS_1003_GP_VARPROC_MOVE_1MO_FLG         --WEB履歴_1003_GP_各種手続き_引越し_直近1か月フラグ\n    ,WEBHIS_1003_GP_VARPROC_MOVE_1YR_FLG         --WEB履歴_1003_GP_各種手続き_引越し_直近1年フラグ\n    ,WEBHIS_1005_GP_VARPROC_SWAPP_1MO_FLG        --WEB履歴_1005_GP_各種手続き_申込切替_直近1か月フラグ\n    ,WEBHIS_1005_GP_VARPROC_SWAPP_1YR_FLG        --WEB履歴_1005_GP_各種手続き_申込切替_直近1年フラグ\n    ,WEBHIS_1011_GP_GAS_ELECT_SASTENA_1MO_FLG    --WEB履歴_1011_GP_ガス・電気_さすてな_直近1か月フラグ\n    ,WEBHIS_1011_GP_GAS_ELECT_SASTENA_1YR_FLG    --WEB履歴_1011_GP_ガス・電気_さすてな_直近1年フラグ\n    ,WEBHIS_1012_GP_GAS_ELECT_TMZONE_1MO_FLG     --WEB履歴_1012_GP_ガス・電気_時間帯別_直近1か月フラグ\n    ,WEBHIS_1012_GP_GAS_ELECT_TMZONE_1YR_FLG     --WEB履歴_1012_GP_ガス・電気_時間帯別_直近1年フラグ\n    ,WEBHIS_1019_SS_REPSERV_GASKIKI_1MO_FLG      --WEB履歴_1019_SS_修理サービス_ガス機器_直近1か月フラグ\n    ,WEBHIS_1019_SS_REPSERV_GASKIKI_1YR_FLG      --WEB履歴_1019_SS_修理サービス_ガス機器_直近1年フラグ\n    ,WEBHIS_1020_SS_REPSERV_WARTER_1MO_FLG       --WEB履歴_1020_SS_修理サービス_水まわり_直近1か月フラグ\n    ,WEBHIS_1020_SS_REPSERV_WARTER_1YR_FLG       --WEB履歴_1020_SS_修理サービス_水まわり_直近1年フラグ\n    ,WEBHIS_1021_SS_REPSERV_SPESAPO_1MO_FLG      --WEB履歴_1021_SS_修理サービス_スペサポ_直近1か月フラグ\n    ,WEBHIS_1021_SS_REPSERV_SPESAPO_1YR_FLG      --WEB履歴_1021_SS_修理サービス_スペサポ_直近1年フラグ\n    ,WEBHIS_1024_SS_WATCHOVERSERV_1MO_FLG        --WEB履歴_1024_SS_見守りサービス_直近1か月フラグ\n    ,WEBHIS_1024_SS_WATCHOVERSERV_1YR_FLG        --WEB履歴_1024_SS_見守りサービス_直近1年フラグ\n    ,WEBHIS_1031_SS_HOUSEKEEPSERV_WS_1MO_FLG     --WEB履歴_1031_SS_家事サービス_WS_直近1か月フラグ\n    ,WEBHIS_1031_SS_HOUSEKEEPSERV_WS_1YR_FLG     --WEB履歴_1031_SS_家事サービス_WS_直近1年フラグ\n    ,WEBHIS_1036_SS_ENEKIKI_ENEFA_1MO_FLG        --WEB履歴_1036_SS_エネルギー機器_エネファ_直近1か月フラグ\n    ,WEBHIS_1036_SS_ENEKIKI_ENEFA_1YR_FLG        --WEB履歴_1036_SS_エネルギー機器_エネファ_直近1年フラグ\n    ,WEBHIS_1037_SS_ENEKIKI_BTM_1MO_FLG          --WEB履歴_1037_SS_エネルギー機器_BTM_直近1か月フラグ\n    ,WEBHIS_1037_SS_ENEKIKI_BTM_1YR_FLG          --WEB履歴_1037_SS_エネルギー機器_BTM_直近1年フラグ\n    ,WEBHIS_1038_SS_ENEKIKI_BTM_ADVLP_1MO_FLG    --WEB履歴_1038_SS_エネルギー機器_BTM_広告LP_直近1か月フラグ\n    ,WEBHIS_1038_SS_ENEKIKI_BTM_ADVLP_1YR_FLG    --WEB履歴_1038_SS_エネルギー機器_BTM_広告LP_直近1年フラグ\n    ,WEBHIS_1062_SS_WEBQUOTE_1MO_FLG             --WEB履歴_1062_SS_Web見積_直近1か月フラグ\n    ,WEBHIS_1062_SS_WEBQUOTE_1YR_FLG             --WEB履歴_1062_SS_Web見積_直近1年フラグ\n    ,WEBHIS_1064_SS_WEBQUOTE_ADVLP_1MO_FLG       --WEB履歴_1064_SS_Web見積_広告LP_直近1か月フラグ\n    ,WEBHIS_1064_SS_WEBQUOTE_ADVLP_1YR_FLG       --WEB履歴_1064_SS_Web見積_広告LP_直近1年フラグ\n    ,WEBHIS_9999_GENERAL_1MO_FLG                 --WEB履歴_9999_全般_直近1か月フラグ\n    ,WEBHIS_9999_GENERAL_1YR_FLG                 --WEB履歴_9999_全般_直近1年フラグ\n    ,LIVBASE_MDK_CUSTUNIT_UNDCONT_FLG            --暮らしES基盤_MDK_顧客単位_契約中フラグ\n    ,LIVBASE_MDK_CUSTUNIT_CANCEL_FLG             --暮らしES基盤_MDK_顧客単位_解約済フラグ\n    ,Format(LIVBASE_MDK_CUSTUNIT_CANCEL_DATE, 'yyyy/MM/dd') AS LIVBASE_MDK_CUSTUNIT_CANCEL_DATE --暮らしES基盤_MDK_顧客単位_解約日\n    ,TRANSLATE(REPLACE(LIVBASE_MDK_CUSTUNIT_APP_TYPE, NCHAR(13) + NCHAR(10), '_'), @replacementNCHAR, '____') AS LIVBASE_MDK_CUSTUNIT_APP_TYPE --暮らしES基盤_MDK_顧客単位_申込区分\n    ,Format(LIVBASE_MDK_CUSTUNIT_APP_DATE, 'yyyy/MM/dd') AS LIVBASE_MDK_CUSTUNIT_APP_DATE --暮らしES基盤_MDK_顧客単位_申込日\n    ,LIVBASE_EFSECLFLATSP_CUSTUNT_UNDCONT_FLG    --暮らしES基盤_EF安心定額サポート_顧客単位_契約中フラグ\n    ,LIVBASE_EFSECLFLATSP_CUSTUNT_CANCEL_FLG     --暮らしES基盤_EF安心定額サポート_顧客単位_解約済フラグ\n    ,Format(LIVBASE_EFSECLFLATSP_CUSTUNT_CANCEL_DATE, 'yyyy/MM/dd') AS LIVBASE_EFSECLFLATSP_CUSTUNT_CANCEL_DATE --暮らしES基盤_EF安心定額サポート_顧客単位_解約日\n    ,TRANSLATE(REPLACE(LIVBASE_EFSECLFLATSP_CUSTUNT_APP_TYPE, NCHAR(13) + NCHAR(10), '_'), @replacementNCHAR, '____') AS LIVBASE_EFSECLFLATSP_CUSTUNT_APP_TYPE --暮らしES基盤_EF安心定額サポート_顧客単位_申込区分\n    ,Format(LIVBASE_EFSECLFLATSP_CUSTUNT_APP_DATE, 'yyyy/MM/dd') AS LIVBASE_EFSECLFLATSP_CUSTUNT_APP_DATE --暮らしES基盤_EF安心定額サポート_顧客単位_申込日\n    ,LIVBASE_WATCHOVERLIF_CUSTUNT_UNDCONT_FLG    --暮らしES基盤_くらし見守り_顧客単位_契約中フラグ\n    ,LIVBASE_WATCHOVERLIF_CUSTUNT_CANCEL_FLG     --暮らしES基盤_くらし見守り_顧客単位_解約済フラグ\n    ,Format(LIVBASE_WATCHOVERLIF_CUSTUNT_CANCEL_DATE, 'yyyy/MM/dd') AS LIVBASE_WATCHOVERLIF_CUSTUNT_CANCEL_DATE --暮らしES基盤_くらし見守り_顧客単位_解約日\n    ,TRANSLATE(REPLACE(LIVBASE_WATCHOVERLIF_CUSTUNT_APP_TYPE, NCHAR(13) + NCHAR(10), '_'), @replacementNCHAR, '____') AS LIVBASE_WATCHOVERLIF_CUSTUNT_APP_TYPE --暮らしES基盤_くらし見守り_顧客単位_申込区分\n    ,Format(LIVBASE_WATCHOVERLIF_CUSTUNT_APP_DATE, 'yyyy/MM/dd') AS LIVBASE_WATCHOVERLIF_CUSTUNT_APP_DATE --暮らしES基盤_くらし見守り_顧客単位_申込日\n    ,LIVBASE_IFSTORY_CUSTUNT_UNDCONT_FLG         --暮らしES基盤_もしものたより_顧客単位_契約中フラグ\n    ,LIVBASE_IFSTORY_CUSTUNT_CANCEL_FLG          --暮らしES基盤_もしものたより_顧客単位_解約済フラグ\n    ,Format(LIVBASE_IFSTORY_CUSTUNT_CANCEL_DATE, 'yyyy/MM/dd') AS LIVBASE_IFSTORY_CUSTUNT_CANCEL_DATE --暮らしES基盤_もしものたより_顧客単位_解約日\n    ,TRANSLATE(REPLACE(LIVBASE_IFSTORY_CUSTUNT_APP_TYPE, NCHAR(13) + NCHAR(10), '_'), @replacementNCHAR, '____') AS LIVBASE_IFSTORY_CUSTUNT_APP_TYPE --暮らしES基盤_もしものたより_顧客単位_申込区分\n    ,Format(LIVBASE_IFSTORY_CUSTUNT_APP_DATE, 'yyyy/MM/dd') AS LIVBASE_IFSTORY_CUSTUNT_APP_DATE --暮らしES基盤_もしものたより_顧客単位_申込日\n    ,LIVBASE_SENCARE_CUSTUNT_UNDCONT_FLG         --暮らしES基盤_シニアケア_顧客単位_契約中フラグ\n    ,LIVBASE_SENCARE_CUSTUNT_CANCEL_FLG          --暮らしES基盤_シニアケア_顧客単位_解約済フラグ\n    ,Format(LIVBASE_SENCARE_CUSTUNT_CANCEL_DATE, 'yyyy/MM/dd') AS LIVBASE_SENCARE_CUSTUNT_CANCEL_DATE --暮らしES基盤_シニアケア_顧客単位_解約日\n    ,TRANSLATE(REPLACE(LIVBASE_SENCARE_CUSTUNT_APP_TYPE, NCHAR(13) + NCHAR(10), '_'), @replacementNCHAR, '____') AS LIVBASE_SENCARE_CUSTUNT_APP_TYPE --暮らしES基盤_シニアケア_顧客単位_申込区分\n    ,Format(LIVBASE_SENCARE_CUSTUNT_APP_DATE, 'yyyy/MM/dd') AS LIVBASE_SENCARE_CUSTUNT_APP_DATE --暮らしES基盤_シニアケア_顧客単位_申込日\n    ,TGRPSV_WARTER_REPAIR_USE_FLG                --東京ガスの修理サービス_水まわり修理_利用フラグ_全期間\n    ,TGRPSV_WARTER_REPAIR_USE_FLG_1YEAR          --東京ガスの修理サービス_水まわり修理_利用フラグ_直近1年\n    ,TGRPSV_WARTER_REPAIR_ACU_USE_COUNT          --東京ガスの修理サービス_水まわり修理_累積利用回数_全期間\n    ,TGRPSV_WARTER_REPAIR_ACU_USE_COUNT_1YEAR    --東京ガスの修理サービス_水まわり修理_累積利用回数_直近1年以内\n    ,TGRPSV_GASKIKI_REPAIR_USE_FLG               --東京ガスの修理サービス_ガス機器修理_利用フラグ_全期間\n    ,TGRPSV_GASKIKI_REPAIR_USE_FLG_1YEAR         --東京ガスの修理サービス_ガス機器修理_利用フラグ_直近1年\n    ,TGRPSV_GASKIKI_REPAIR_ACU_USE_COUNT         --東京ガスの修理サービス_ガス機器修理_累積利用回数_全期間\n    ,TGRPSV_GASKIKI_REPAIR_USE_COUNT_1YEAR       --東京ガスの修理サービス_ガス機器修理_累積利用回数_直近1年以内\n    ,MYTG_MAIL_OPEN_RATE                         --myTG会員情報_メール開封率_全期間\n    ,MYTG_MAIL_OPEN_RATE_1YEAR                   --myTG会員情報_メール開封率_直近1年\n    ,MYTG_MAIL_URL_CLICK_RATE                    --myTG会員情報_メール添付URLクリック率_全期間\n    ,MYTG_MAIL_URL_CLICK_RATE_1YEAR              --myTG会員情報_メール添付URLクリック率_直近1年\n    ,MYTG_SUBSCRIBE_FLG_1YEAR                    --myTG会員情報_定期利用フラグ_直近1年\n    ,MYTG_SUBSCRIBE_FLG_6MONTH                   --myTG会員情報_定期利用フラグ_直近6ヶ月\n    ,MYTG_ACTIVE_RATE                            --myTG会員情報_アクティブ率\n    ,MOST_RECENT_OPENER_FLG                      --直近開栓者フラグ\n    ,STRATEGIC_SEGMENT                           --戦略セグメント\n    ,CUSTOMER_STAGE                              --顧客ステージ\n    ,ESTIMVINTP_NEW_USED_MOVEIN_TYPE             --推定入居区分_新築中古入居分類\n    ,DEMOGRAPHIC_ESTIMATED_NUM_HOUSEHOLDS        --デモグラフィック情報_推定世帯人数\n    ,Format(REC_REG_YMD, 'yyyy/MM/dd HH:mm:ss') AS REC_REG_YMD  --レコード作成日時\n    ,Format(REC_UPD_YMD, 'yyyy/MM/dd HH:mm:ss') AS REC_UPD_YMD  --レコード更新日時\n    ,@outputDT AS OUTPUT_DATETIME                --IF出力日時\n\nFROM [omni].[omni_ods_marketing_trn_client_dm_bx_temp] -- 顧客DM_Bx付_temp\n;\n",
                                "queryTimeout": "02:00:00",
                                "partitionOption": "None"
                            },
                            "sink": {
                                "type": "DelimitedTextSink",
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextWriteSettings",
                                    "quoteAllText": true,
                                    "fileExtension": ".csv"
                                }
                            },
                            "enableStaging": false,
                            "translator": {
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": true,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_DamDwhTable_shir",
                                "type": "DatasetReference",
                                "parameters": {
                                    "table": "--"
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_CSV_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/ClientDM",
                                    "columnDelimiter": ",",
                                    "quoteChar": "\"",
                                    "firstRowAsHeader": true,
                                    "filename": {
                                        "value": "@concat('ClientDM_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "at_SendSftp_ClientDM",
                        "description": "Blobに出力されたgzipファイルをSFMCにSFTP連携",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "at_CreateCSV_ClientDM",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "08:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/ClientDM",
                                    "filename": {
                                        "value": "@concat('ClientDM_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/ClientDM",
                                    "filename": {
                                        "value": "@concat('ClientDM_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "SMC"
                },
                "annotations": [],
                "lastPublishTime": "2024-11-05T09:23:59Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_UtilityBills')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "mytokyogas-Blobから「料金確定のお知らせ」IFに必要なデータを抽出、gzipファイルでBLOB出力し、SFMCにSFTP連携する。",
                "activities": [
                    {
                        "name": "at_GetFiles_UtilityBills",
                        "description": "Blobのファイル一覧取得",
                        "type": "GetMetadata",
                        "dependsOn": [
                            {
                                "activity": "SetVariable Filename",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "dataset": {
                                "referenceName": "ds_BlobFiles_mTG",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": {
                                        "value": "@concat('forRcvry/',formatDateTime(variables('JST'),'yyyyMMdd'),'/DCPDA014')",
                                        "type": "Expression"
                                    },
                                    "filename": {
                                        "value": "@concat(formatDateTime(variables('JST'),'yyyyMMdd'),'_DAM_PriceConfirm.tsv')",
                                        "type": "Expression"
                                    }
                                }
                            },
                            "fieldList": [
                                "exists"
                            ],
                            "storeSettings": {
                                "type": "AzureBlobStorageReadSettings",
                                "recursive": true,
                                "enablePartitionDiscovery": false
                            },
                            "formatSettings": {
                                "type": "JsonReadSettings"
                            }
                        }
                    },
                    {
                        "name": "IfCondition_UtilityBills",
                        "description": "該当ファイル有無により、出力を替える",
                        "type": "IfCondition",
                        "dependsOn": [
                            {
                                "activity": "at_GetFiles_UtilityBills",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "userProperties": [],
                        "typeProperties": {
                            "expression": {
                                "value": "@activity('at_GetFiles_UtilityBills').output.exists",
                                "type": "Expression"
                            },
                            "ifFalseActivities": [
                                {
                                    "name": "at_CreateCSV_UtilityBills_Header",
                                    "description": "連携ファイルが存在しない場合のヘッダのみ出力",
                                    "type": "Copy",
                                    "dependsOn": [],
                                    "policy": {
                                        "timeout": "7.00:00:00",
                                        "retry": 10,
                                        "retryIntervalInSeconds": 60,
                                        "secureOutput": false,
                                        "secureInput": false
                                    },
                                    "userProperties": [],
                                    "typeProperties": {
                                        "source": {
                                            "type": "DelimitedTextSource",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageReadSettings",
                                                "recursive": false,
                                                "enablePartitionDiscovery": false
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextReadSettings"
                                            }
                                        },
                                        "sink": {
                                            "type": "DelimitedTextSink",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextWriteSettings",
                                                "quoteAllText": true,
                                                "fileExtension": ".csv"
                                            }
                                        },
                                        "enableStaging": false,
                                        "translator": {
                                            "type": "TabularTranslator",
                                            "typeConversion": true,
                                            "typeConversionSettings": {
                                                "allowDataTruncation": true,
                                                "treatBooleanAsNumber": false
                                            }
                                        }
                                    },
                                    "inputs": [
                                        {
                                            "referenceName": "ds_CSV_Blob",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/dev/OMNI/temp/",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": "header_DAM_UtilityBills.csv"
                                            }
                                        }
                                    ],
                                    "outputs": [
                                        {
                                            "referenceName": "ds_CSV_BlobGz",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/OMNI/MA/UtilityBills",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": {
                                                    "value": "@variables('FileName')",
                                                    "type": "Expression"
                                                }
                                            }
                                        }
                                    ]
                                }
                            ],
                            "ifTrueActivities": [
                                {
                                    "name": "at_CreateCSV_UtilityBills",
                                    "description": "連携ファイルから必要なデータのみを抽出しcsvファイルを作成、BLOBに配置する",
                                    "type": "Copy",
                                    "dependsOn": [],
                                    "policy": {
                                        "timeout": "7.00:00:00",
                                        "retry": 10,
                                        "retryIntervalInSeconds": 60,
                                        "secureOutput": false,
                                        "secureInput": false
                                    },
                                    "userProperties": [],
                                    "typeProperties": {
                                        "source": {
                                            "type": "SqlDWSource",
                                            "sqlReaderQuery": {
                                                "value": "----------------------------------------------------------------------------\n-- MA向けリスト連携 料金確定のお知らせ 出力 at_CreateCSV_UtilityBills\n----------------------------------------------------------------------------\n\n-- 作成する外部テーブル(料金確定のお知らせ_ext_temp)が存在する場合は削除する\nDECLARE @isAllEventsTemp int;\nSELECT @isAllEventsTemp=count(*) FROM sys.objects WHERE schema_id = schema_id('omni') AND name='omni_ods_mytginfo_trn_price_confirm_ext_temp';\nIF @isAllEventsTemp = 1\n    DROP EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_price_confirm_ext_temp];\n\n-- ADFによりTSVをロードする外部テーブルを作成する\n\n-- 外部テーブル作成 omni_ods_mytginfo_trn_price_confirm_ext_temp(料金確定のお知らせ_ext_temp)\nCREATE EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_price_confirm_ext_temp]\n(\n     ID_NO\tNVARCHAR(20)\tNULL\t -- 会員ID\n    ,PICTURE_MM\tNVARCHAR(2)\tNULL\t -- 画像月分\n    ,MAIL_ADR\tNVARCHAR(50)\tNULL\t -- メールアドレス\n)\nWITH (\n    DATA_SOURCE=[mytokyogas],\n    LOCATION='@{concat('/forRcvry/',convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'/DCPDA014/',convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'_DAM_PriceConfirm.tsv')}',\n    FILE_FORMAT=[TSV2],\n    REJECT_TYPE=VALUE,\n    REJECT_VALUE=0\n)\n;\n\n-- 会員IDと画像月分の組み合わせで重複削除する。重複削除するレコードはメールアドレスが最大のもの以外に行う\nSELECT ID_NO, PICTURE_MM, MAIL_ADR, '@{convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd')}'as CSV_YMD, FORMAT((GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyy/MM/dd HH:mm:ss') as OUTPUT_DATETIME\nFROM (\n    SELECT *\n    , DupRank = ROW_NUMBER() OVER (\n                PARTITION BY ID_NO\n                , PICTURE_MM\n                ORDER BY MAIL_ADR DESC\n                )\n    FROM omni.omni_ods_mytginfo_trn_price_confirm_ext_temp\n) as table_utilityBills\nWHERE DupRank = 1\n\n\n-- 作成した外部テーブルが存在する場合は削除行う\nSELECT @isAllEventsTemp=count(*) FROM sys.objects WHERE schema_id = schema_id('omni') AND name='omni_ods_mytginfo_trn_price_confirm_ext_temp';\nIF @isAllEventsTemp = 1\n    DROP EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_price_confirm_ext_temp];\n\n",
                                                "type": "Expression"
                                            },
                                            "queryTimeout": "02:00:00",
                                            "partitionOption": "None"
                                        },
                                        "sink": {
                                            "type": "DelimitedTextSink",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextWriteSettings",
                                                "quoteAllText": true,
                                                "fileExtension": ".csv"
                                            }
                                        },
                                        "enableStaging": false,
                                        "translator": {
                                            "type": "TabularTranslator",
                                            "typeConversion": true,
                                            "typeConversionSettings": {
                                                "allowDataTruncation": true,
                                                "treatBooleanAsNumber": false
                                            }
                                        }
                                    },
                                    "inputs": [
                                        {
                                            "referenceName": "ds_DamDwhTable_shir",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "table": "--"
                                            }
                                        }
                                    ],
                                    "outputs": [
                                        {
                                            "referenceName": "ds_CSV_BlobGz",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/OMNI/MA/UtilityBills",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": {
                                                    "value": "@variables('FileName')",
                                                    "type": "Expression"
                                                }
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "name": "at_SendSftp_UtilityBills",
                        "description": "SMCへ送信",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "IfCondition_UtilityBills",
                                "dependencyConditions": [
                                    "Skipped"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/UtilityBills",
                                    "filename": {
                                        "value": "@variables('FileName')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/2A01b_BillingNotice",
                                    "filename": {
                                        "value": "@variables('FileName')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "SetVariable JST",
                        "description": "トリガーの実行日時をJSTに変換する",
                        "type": "SetVariable",
                        "dependsOn": [],
                        "policy": {
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "variableName": "JST",
                            "value": {
                                "value": "@convertFromUtc(pipeline().parameters.executionStartDateTimeUTC,'Tokyo Standard Time')",
                                "type": "Expression"
                            }
                        }
                    },
                    {
                        "name": "SetVariable AMPM",
                        "description": "木曜日はPM、その他の曜日はAMを設定\nする",
                        "type": "SetVariable",
                        "dependsOn": [
                            {
                                "activity": "SetVariable JST",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "variableName": "AMPM",
                            "value": {
                                "value": "@concat(substring('PPPPAPP',dayOfWeek(variables('JST')),1), 'M')",
                                "type": "Expression"
                            }
                        }
                    },
                    {
                        "name": "SetVariable Filename",
                        "description": "ファイル名を設定する",
                        "type": "SetVariable",
                        "dependsOn": [
                            {
                                "activity": "SetVariable AMPM",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "variableName": "FileName",
                            "value": {
                                "value": "@concat('UtilityBills_', variables('AMPM') , formatDateTime(variables('JST'),'yyyyMMdd') , '.csv.gz')",
                                "type": "Expression"
                            }
                        }
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "parameters": {
                    "executionStartDateTimeUTC": {
                        "type": "string",
                        "defaultValue": "@trigger().startTime"
                    }
                },
                "variables": {
                    "JST": {
                        "type": "String"
                    },
                    "AMPM": {
                        "type": "String"
                    },
                    "FileName": {
                        "type": "String"
                    }
                },
                "folder": {
                    "name": "検電"
                },
                "annotations": [],
                "lastPublishTime": "2025-05-14T01:58:51Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Send_UsageServices')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "MA向けリスト連携（利用サービス）",
                "activities": [
                    {
                        "name": "at_CreateCSV_UsageServices",
                        "description": "",
                        "type": "Copy",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "SqlDWSource",
                                "sqlReaderQuery": "-- 「利用サービス」出力 at_CreateCSV_UsageServices\n\n-- 結果出力 => 利用サービス\n\nDECLARE @today_jst varchar(20);\nSET @today_jst=format(CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'), 'yyyy/MM/dd HH:mm:ss');\n\nSELECT \n     *\n    ,@today_jst as OUTPUT_DATETIME    -- 出力日付\nFROM [omni].[omni_ods_cloak_trn_usageservice]\n;\n",
                                "queryTimeout": "02:00:00",
                                "partitionOption": "None"
                            },
                            "sink": {
                                "type": "DelimitedTextSink",
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextWriteSettings",
                                    "quoteAllText": true,
                                    "fileExtension": ".csv"
                                }
                            },
                            "enableStaging": false,
                            "translator": {
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": true,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_DamDwhTable_shir",
                                "type": "DatasetReference",
                                "parameters": {
                                    "table": "--"
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_CSV_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/UsageServices",
                                    "columnDelimiter": ",",
                                    "quoteChar": "\"",
                                    "firstRowAsHeader": true,
                                    "filename": {
                                        "value": "@concat('UsageServices_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "at_SendSftp_UsageServices",
                        "description": "MA向けリスト連携（利用サービス）sftp送出",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "at_CreateCSV_UsageServices",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "08:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/UsageServices",
                                    "filename": {
                                        "value": "@concat('UsageServices_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/UsageServices",
                                    "filename": {
                                        "value": "@concat('UsageServices_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "SMC"
                },
                "annotations": [],
                "lastPublishTime": "2024-11-05T06:55:36Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Send_mTGMailPermission')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "MA向けリスト連携（メール許諾）",
                "activities": [
                    {
                        "name": "at_CreateCSV_mTGMailPermission",
                        "type": "Copy",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "SqlDWSource",
                                "sqlReaderQuery": "----------------------------------------------------------------------\n--  MA向けリスト連携 メール許諾 出力 at_CreateCSV_MailPermission\n----------------------------------------------------------------------\n\n-- 結果出力 => メール許諾\n\nDECLARE @today_jst varchar(20);\nSET @today_jst=format(CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'), 'yyyy/MM/dd HH:mm:ss');\n\nSELECT\n     cpinfo.ID_NO                     -- 会員ID\n    ,cpinfo.MAIL_ADR                  -- メールアドレス\n    ,cpinfo.SUBMAIL_ADR               -- サブメールアドレス\n    ,cpinfo.TEL_NO                    -- 電話番号\n    ,cpinfo.SUBTEL_NO                 -- 日中のご連絡先\n    ,mailsvc.SVC_CD                   -- サービスコード\n    ,mailsvc.START_YMD                -- 適用開始年月日\n    ,REPLACE(mailsvc.END_YMD, '99999999', '99991231') as END_YMD      -- 適用終了年月日\n    ,mailsvc.LOCK_FLG_CD              -- ロックフラグコード\n    ,mailsvc.REC_REG_YMD              -- レコード登録年月日\n    ,mailsvc.REC_REG_JKK              -- レコード登録時刻\n    ,mailsvc.REC_UPD_YMD              -- レコード更新年月日\n    ,mailsvc.REC_UPD_JKK              -- レコード更新時刻\n    ,@today_jst as OUTPUT_DATETIME    -- 出力日付\n    ,cpinfo.TAIKAI_FLAG               -- 退会フラグ　…追加\n    ,cpinfo.WEB_NO                    -- 8x（Web） …追加\n    ,cpinfo.TNP_CD                    -- 店舗コード …追加\n    ,cpinfo.THK_NWKSY_CD              -- THANKSネットワーク箇所コード …追加\n    ,cpinfo.ID_KBN                    -- 会員区分 …追加\n    ,cpinfo.REG_CD                    -- 会員登録経路 …追加\n    ,cpinfo.REG_COMP_FLG              -- 会員登録完了フラグ …追加\n    ,cpinfo.FIRST_MIGRATION_FLG       -- TGCRM初期移行フラグ …追加\n    ,cpinfo.FREE_ITEM01               -- 予備1 …追加\n    ,cpinfo.FREE_ITEM02               -- 予備2 …追加\n    ,cpinfo.FREE_ITEM03               -- 予備3 …追加\n    ,cpinfo.FREE_ITEM04               -- 予備4 …追加\n    ,cpinfo.FREE_ITEM05               -- 予備5 …追加\n    ,cpinfo.FREE_ITEM06               -- 予備6 …追加\n    ,cpinfo.FREE_ITEM07               -- 予備7 …追加\n    ,cpinfo.FREE_ITEM08               -- 予備8 …追加\n    ,cpinfo.FREE_ITEM09               -- 予備9 …追加\n    ,cpinfo.FREE_ITEM10               -- 予備10 …追加\nFROM [omni].[omni_ods_mytginfo_trn_cpinfo] cpinfo                     -- 会員基本情報\nLEFT OUTER JOIN [omni].[omni_ods_mytginfo_trn_mailsvc] mailsvc        -- メールサービス\n     ON cpinfo.ID_NO = mailsvc.ID_NO;                        -- 会員基本情報.会員ID=メールサービス.会員ID\n;\n",
                                "queryTimeout": "02:00:00",
                                "partitionOption": "None"
                            },
                            "sink": {
                                "type": "DelimitedTextSink",
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextWriteSettings",
                                    "quoteAllText": true,
                                    "fileExtension": ".csv"
                                }
                            },
                            "enableStaging": false,
                            "translator": {
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": true,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_DamDwhTable_shir",
                                "type": "DatasetReference",
                                "parameters": {
                                    "table": "--"
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_CSV_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/mTGMailPermission",
                                    "columnDelimiter": ",",
                                    "quoteChar": "\"",
                                    "firstRowAsHeader": true,
                                    "filename": {
                                        "value": "@concat('mTGMailPermission_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "at_SendSftp_mTGMailPermission",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "at_CreateCSV_mTGMailPermission",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/mTGMailPermission",
                                    "filename": {
                                        "value": "@concat('mTGMailPermission_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/mTGMailPermission",
                                    "filename": {
                                        "value": "@concat('mTGMailPermission_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "SMC"
                },
                "annotations": [],
                "lastPublishTime": "2024-11-05T06:55:36Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_PointGrantEmail')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "mytokyogas-Blobから「ポイント付与メール」IFに必要なデータを抽出、gzipファイルでBLOB出力し、SFMCにSFTP連携する。",
                "activities": [
                    {
                        "name": "at_GetFiles_PointGrantEmail",
                        "description": "Blobのファイル一覧取得",
                        "type": "GetMetadata",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "dataset": {
                                "referenceName": "ds_BlobFiles_mTG",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": {
                                        "value": "@concat('forRcvry/',convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'/DCPDA016')",
                                        "type": "Expression"
                                    },
                                    "filename": {
                                        "value": "@concat(convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'_DAM_PointAdd.tsv')",
                                        "type": "Expression"
                                    }
                                }
                            },
                            "fieldList": [
                                "exists"
                            ],
                            "storeSettings": {
                                "type": "AzureBlobStorageReadSettings",
                                "recursive": true,
                                "enablePartitionDiscovery": false
                            },
                            "formatSettings": {
                                "type": "JsonReadSettings"
                            }
                        }
                    },
                    {
                        "name": "at_SendSftp_PointGrantEmail",
                        "description": "SMCへ送信",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "IfCondition_PointGrantEmail",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/PointGrantEmail",
                                    "filename": {
                                        "value": "@concat('PointGrantEmail_', convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/3A01b_PointAddition",
                                    "filename": {
                                        "value": "@concat('PointGrantEmail_', convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "IfCondition_PointGrantEmail",
                        "description": "該当ファイル有無により、出力を替える",
                        "type": "IfCondition",
                        "dependsOn": [
                            {
                                "activity": "at_GetFiles_PointGrantEmail",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "userProperties": [],
                        "typeProperties": {
                            "expression": {
                                "value": "@activity('at_GetFiles_PointGrantEmail').output.exists",
                                "type": "Expression"
                            },
                            "ifFalseActivities": [
                                {
                                    "name": "at_CreateCSV_PointGrantEmail_Header",
                                    "description": "連携ファイルが存在しない場合のヘッダのみ出力",
                                    "type": "Copy",
                                    "dependsOn": [],
                                    "policy": {
                                        "timeout": "7.00:00:00",
                                        "retry": 10,
                                        "retryIntervalInSeconds": 60,
                                        "secureOutput": false,
                                        "secureInput": false
                                    },
                                    "userProperties": [],
                                    "typeProperties": {
                                        "source": {
                                            "type": "DelimitedTextSource",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageReadSettings",
                                                "recursive": false,
                                                "enablePartitionDiscovery": false
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextReadSettings"
                                            }
                                        },
                                        "sink": {
                                            "type": "DelimitedTextSink",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextWriteSettings",
                                                "quoteAllText": true,
                                                "fileExtension": ".csv"
                                            }
                                        },
                                        "enableStaging": false,
                                        "translator": {
                                            "type": "TabularTranslator",
                                            "typeConversion": true,
                                            "typeConversionSettings": {
                                                "allowDataTruncation": true,
                                                "treatBooleanAsNumber": false
                                            }
                                        }
                                    },
                                    "inputs": [
                                        {
                                            "referenceName": "ds_CSV_Blob",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/dev/OMNI/temp/",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": "header_DAM_PointGrantEmail.csv"
                                            }
                                        }
                                    ],
                                    "outputs": [
                                        {
                                            "referenceName": "ds_CSV_BlobGz",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/OMNI/MA/PointGrantEmail",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": {
                                                    "value": "@concat('PointGrantEmail_', convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                                    "type": "Expression"
                                                }
                                            }
                                        }
                                    ]
                                }
                            ],
                            "ifTrueActivities": [
                                {
                                    "name": "at_CreateCSV_PointGrantEmail",
                                    "description": "連携ファイルから必要なデータのみを抽出しcsvファイルを作成、BLOBに配置する",
                                    "type": "Copy",
                                    "dependsOn": [],
                                    "policy": {
                                        "timeout": "7.00:00:00",
                                        "retry": 10,
                                        "retryIntervalInSeconds": 60,
                                        "secureOutput": false,
                                        "secureInput": false
                                    },
                                    "userProperties": [],
                                    "typeProperties": {
                                        "source": {
                                            "type": "SqlDWSource",
                                            "sqlReaderQuery": {
                                                "value": "----------------------------------------------------------------------------\n-- MA向けリスト連携 ポイント付与メール 出力 at_CreateCSV_PointGrantEmail\n-- 2023/02/28　初版\n-- 2023/10/05　重複削除条件修正\n----------------------------------------------------------------------------\n\n-- 作成する外部テーブル(ポイント付与メール_ext_temp)が存在する場合は削除する\nDECLARE @isAllEventsTemp int;\nSELECT @isAllEventsTemp=count(*) FROM sys.objects WHERE schema_id = schema_id('omni') AND name='omni_ods_mytginfo_trn_point_add_ext_temp';\nIF @isAllEventsTemp = 1\n    DROP EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_point_add_ext_temp];\n\n-- ADFによりTSVをロードする外部テーブルを作成する\n\n-- 外部テーブル作成 omni_ods_mytginfo_trn_point_add_ext_temp(ポイント付与メール_ext_temp)\nCREATE EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_point_add_ext_temp]\n(\n     ID_NO\tNVARCHAR(20)\tNULL\t -- 会員ID\n    ,PNT_TYPE_CD\tNVARCHAR(4)\tNULL\t -- ポイント種別\n    ,MAIL_ADR\tNVARCHAR(50)\tNULL\t -- メールアドレス\n    ,PICTURE_MM\tNVARCHAR(2)\tNULL\t -- 画像月分\n)\nWITH (\n    DATA_SOURCE=[mytokyogas],\n    LOCATION='@{concat('/forRcvry/',convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'/DCPDA016/',convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'_DAM_PointAdd.tsv')}',\n    FILE_FORMAT=[TSV2],\n    REJECT_TYPE=VALUE,\n    REJECT_VALUE=0\n)\n;\n\n-- 会員IDと画像月分の組み合わせで重複削除する。重複削除するレコードはメールアドレスが最大のもの以外に行う\nSELECT ID_NO,PNT_TYPE_CD,MAIL_ADR,PICTURE_MM, '@{convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd')}'as CSV_YMD ,FORMAT((GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyy/MM/dd HH:mm:ss')as OUTPUT_DATETIME\nFROM (\nSELECT *\n, DupRank = ROW_NUMBER() OVER (\n              PARTITION BY ID_NO,PNT_TYPE_CD,PICTURE_MM\n              ORDER BY MAIL_ADR DESC\n            )\nFROM omni.omni_ods_mytginfo_trn_point_add_ext_temp\n) as table_pointGrantEmail\nWHERE DupRank = 1\n\n\n-- 作成した外部テーブルが存在する場合は削除行う\nSELECT @isAllEventsTemp=count(*) FROM sys.objects WHERE schema_id = schema_id('omni') AND name='omni_ods_mytginfo_trn_point_add_ext_temp';\nIF @isAllEventsTemp = 1\n    DROP EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_point_add_ext_temp];\n",
                                                "type": "Expression"
                                            },
                                            "queryTimeout": "02:00:00",
                                            "partitionOption": "None"
                                        },
                                        "sink": {
                                            "type": "DelimitedTextSink",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextWriteSettings",
                                                "quoteAllText": true,
                                                "fileExtension": ".csv"
                                            }
                                        },
                                        "enableStaging": false,
                                        "translator": {
                                            "type": "TabularTranslator",
                                            "typeConversion": true,
                                            "typeConversionSettings": {
                                                "allowDataTruncation": true,
                                                "treatBooleanAsNumber": false
                                            }
                                        }
                                    },
                                    "inputs": [
                                        {
                                            "referenceName": "ds_DamDwhTable_shir",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "table": "--"
                                            }
                                        }
                                    ],
                                    "outputs": [
                                        {
                                            "referenceName": "ds_CSV_BlobGz",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/OMNI/MA/PointGrantEmail",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": {
                                                    "value": "@concat('PointGrantEmail_', convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                                    "type": "Expression"
                                                }
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "parameters": {
                    "executionStartDateTimeUTC": {
                        "type": "string",
                        "defaultValue": "@trigger().startTime"
                    }
                },
                "folder": {
                    "name": "検電"
                },
                "annotations": [],
                "lastPublishTime": "2025-04-15T10:51:29Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Send_OpeningPaymentGuide')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "開栓後の支払方法のご案内",
                "activities": [
                    {
                        "name": "at_CreateCSV_OpeningPaymentGuide",
                        "type": "Copy",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "SqlDWSource",
                                "sqlReaderQuery": "--------------------------------------------------------------------------------------------------------------\n-- MA向けリスト連携 開栓後の支払方法のご案内（開栓者全量連携） 出力 at_CreateCSV_OpeningPaymentGuide\n--------------------------------------------------------------------------------------------------------------\n\nDECLARE @today_jst datetime;\nSET @today_jst=CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');\n\nDECLARE @from20days varchar(8);\nSET @from20days=format(dateadd(day,-20, @today_jst),'yyyyMMdd'); -- 実行日JSTから20日前\n\nDECLARE @to5days varchar(8);\nSET @to5days=format(dateadd(day,-5,@today_jst),'yyyyMMdd');      -- 実行日JSTから5日前\n\n\n-- ①作業テーブル作成\nTRUNCATE TABLE [omni].[omni_ods_ma_trn_opened1x_temp];\n\nINSERT INTO [omni].[omni_ods_ma_trn_opened1x_temp]\nSELECT\n     ANKEN_NO                -- 案件番号\n    ,GASMETER_SETTI_BASYO_NO -- ガスメータ設置場所番号\n    ,SAGYO_YMD               -- 作業年月日\nFROM [omni].[omni_ods_livalit_trn_liv5_opening_basics]\nWHERE TENKEN_JUTAKU_KBN='1'                  -- TG小売り\n      AND KAISEN_JIYU_CD in ('11','12')      -- 11:代替,12新設\n      AND SAGYO_YMD>=@from20days\n      AND SAGYO_YMD<@to5days\n      AND ERROR_FOLLOW_JOTAI_CD in('0','2')  -- 0：正常,2:フォロー済\n;\n\n\n-- ②作業テーブル作成\nTRUNCATE TABLE [omni].[omni_ods_ma_trn_opening_target_temp];\n\nINSERT INTO [omni].[omni_ods_ma_trn_opening_target_temp]\nSELECT\n     temp1.*\n    ,CONVERT(VARCHAR(11), A.SYO_KYO_TRNO)  as SYO_KYO_TRNO      -- 使用者契約お客さま登録番号\n    ,CONVERT(VARCHAR(11), A.SHSY_KYO_TRNO) as SHSY_KYO_TRNO     -- 支払者契約お客さま登録番号\n    ,NULL as SIH_HUHU_SHBT    -- A.SIH_HUHU_SHBT as SIH_HUHU_SHBT    -- 支払方法種別　...出力から無くし固定のNULLとする\nFROM [omni].[omni_ods_ma_trn_opened1x_temp] temp1    -- ①作業テーブル\nINNER JOIN [omni].[omni_odm_gascstmr_trn_gaskiy] A   -- ガス契約（契約中）日次お客さま情報\n      ON temp1.GASMETER_SETTI_BASYO_NO=CONVERT(VARCHAR(11),A.MTST_NO)\n--WHERE A.SHIK_SIH_KIY_JTKB<>'00'   -- 無効ではない\n--      AND A.SIK_SVC_SHBT not in ('11','14','15','21','13')   -- (11,14,15(一括),21(分割),13(郵送一括:オーナー))ではない　...条件削除\n;\n\n\n-- ③結果出力 => 開栓後の支払方法のご案内\nSET @today_jst=CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');  -- 最新の日時\n\nSELECT\n     Bx\n    ,INDEX_ID\n    ,ANKEN_NO                   -- 案件番号\n    ,GASMETER_SETTI_BASYO_NO    -- ガスメータ設置場所番号\n    ,SAGYO_YMD                  -- 作業年月日\n    ,SYO_KYO_TRNO               -- 使用者契約お客さま登録番号\n    ,SHSY_KYO_TRNO              -- 支払者契約お客さま登録番号\n    --,SIH_HUHU_SHBT              -- 支払方法種別　...出力から無くす\n    ,format(@today_jst, 'yyyy/MM/dd HH:mm:ss') as OUTPUT_DATETIME  -- IF出力日時\nFROM(\n    SELECT\n         A.Bx\n        ,A.INDEX_ID\n        ,temp2.*\n        ,ROW_NUMBER() OVER(PARTITION BY Bx,ANKEN_NO,GASMETER_SETTI_BASYO_NO,SAGYO_YMD ORDER BY OUTPUT_DATE desc) as rown -- INDEX_IDを除くカラムごとのOUTPUT_DATEの降順\n    FROM [omni].[omni_ods_cloak_trn_usageservice] A               -- 利用サービス\n    INNER JOIN [omni].[omni_ods_ma_trn_opening_target_temp] temp2 -- ②作業テーブル\n          ON A.USER_KEY=temp2.SYO_KYO_TRNO      -- 使用者契約お客さま登録番号\n            AND A.USER_KEY_TYPE='003'   -- お客さま番号3x\n            AND A.SERVICE_TYPE ='001'   -- ガス\n            AND A.TRANSFER_TYPE='02'    -- 提供中\n)tmp\nWHERE rown=1\n;\n",
                                "queryTimeout": "02:00:00",
                                "partitionOption": "None"
                            },
                            "sink": {
                                "type": "DelimitedTextSink",
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextWriteSettings",
                                    "quoteAllText": true,
                                    "fileExtension": ".csv"
                                }
                            },
                            "enableStaging": false,
                            "translator": {
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": true,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_DamDwhTable_shir",
                                "type": "DatasetReference",
                                "parameters": {
                                    "table": "--"
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_CSV_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/OpeningPaymentGuide",
                                    "columnDelimiter": ",",
                                    "quoteChar": "\"",
                                    "firstRowAsHeader": true,
                                    "filename": {
                                        "value": "@concat('OpeningPaymentGuide_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "at_SendSftp_OpeningPaymentGuide",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "at_CreateCSV_OpeningPaymentGuide",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/OpeningPaymentGuide",
                                    "filename": {
                                        "value": "@concat('OpeningPaymentGuide_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/OpeningPaymentGuide",
                                    "filename": {
                                        "value": "@concat('OpeningPaymentGuide_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "SMC"
                },
                "annotations": [],
                "lastPublishTime": "2024-11-25T09:05:51Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Send_ElectricityContractThanks')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "DAM-DBから「電気契約Thanks」IFに必要なデータを抽出、gzipファイルでBLOB出力し、SFMCにSFTP連携する。",
                "activities": [
                    {
                        "name": "at_CreateCSV_ElectricityContractThanks",
                        "description": "",
                        "type": "Copy",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "SqlDWSource",
                                "sqlReaderQuery": "--------------------------------------------------------------------------\n-- MA向けリスト連携（電気契約Thanksシナリオ）\n-- 2023/07 新規作成\n-- 2024/10 出力カラム「契約タイプ」追加、抽出条件変更、mTGID取得「本人特定契約」に変更\n--------------------------------------------------------------------------\n\nDECLARE @today_jst DATETIME;        -- 実行日\nSET @today_jst=CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time')\n\nDECLARE @targetDate varchar(8);     -- 抽出対象日=実行日-1日\nSET @targetDate=format(DATEADD(DAY,-1,@today_jst),'yyyyMMdd');\n\n\n------------------------------------------------------------------\n----① 中間①に出力する\nTRUNCATE TABLE [omni].[omni_ods_ma_trn_new_electricity_contract_temp];\n\nINSERT INTO [omni].[omni_ods_ma_trn_new_electricity_contract_temp]\nSELECT distinct\n     c.KEY_1X                     -- ガスメータ設置場所番号\n    ,c.KEY_3X                     -- お客さま登録番号\n    ,c.GAS_4X                     -- ガス使用契約番号\n    ,c.EL_4X                      -- 電力使用契約番号\n    ,c.KEY_8X                     -- カスタマ番号\n    ,c.SUPPLY_POINT_ID            -- 供給地点特定番号\n    ,c.SA_ID                      -- 電力契約番号\n    ,c.GAS_START_DT as START_DATE -- 使用開始日　契約\n    ,o.APPLICATION_DT             -- 申込日　指図\n    ,c.SA_TYPE_CD                 -- 契約タイプ　2024/10 追加\nFROM [omni].[omni_ods_epcis_trn_contract] c              -- 電力ＣＩＳ契約情報\nINNER JOIN [omni].[omni_ods_epcis_trn_operation_order] o -- 電力ＣＩＳ指図情報\n        ON c.SA_ID=o.SA_ID                                       -- 「電力契約番号」が一致\n            AND o.OO_STATUS_FLG='800' AND o.OO_TYPE_CD='ESST'    -- 開始作業完了\n\nWHERE c.UPD_DIVISION='A'               -- 更新区分=A:追加\n\n    AND c.REC_REG_YMD=@targetDate      -- 登録日(ジョブの実行日)=ADFの実行日-1日\n\n    -- and c.SA_TYPE_CD in('ESLVY','ESOLY')     -- 契約タイプ=合算　削除 2024/10\n\n    AND EXISTS (\n        SELECT 1 FROM (\n            SELECT\n                count(distinct ct.SA_ID) as count    -- 「電力契約番号」の数\n            FROM [omni].[omni_ods_epcis_trn_contract] ct   -- 電力ＣＩＳ契約情報\n            WHERE ct.SUPPLY_POINT_ID=c.SUPPLY_POINT_ID    -- 「供給地点特定番号」が一致し、「お客さま登録番号、お客さま名、電話番号」のいずれか一致\n                AND ( ct.KEY_3X=c.KEY_3X                  -- お客さま登録番号\n                    OR ct.PER_NAME=c.PER_NAME             -- お客さま名＿漢字\n                    OR ct.PER_NAME_KANA=c.PER_NAME_KANA   -- お客さま名＿カナ\n                    OR ct.PHONE=c.PHONE                   -- 電話番号\n                )\n        )tmp\n        WHERE count=1\n    )  -- 「供給地点特定番号、お客さま登録番号」ごとの最初の契約\n;\n\n\n--------------------------------------------------------------------\n----② 中間②に出力する　削除 2024/10\n\n\n--------------------------------------------------------------------\n----③ 電気契約Thanks履歴に出力する\nDECLARE @runYMD varchar(8);   -- 実行日\nSET @runYMD=format(@today_jst,'yyyyMMdd');\n\nINSERT INTO [omni].[omni_ods_ma_trn_electricity_thanks_history]\nSELECT distinct\n    --Bx                       -- Bx　削除 2024/10\n    --MTGID                    -- mTGID　削除 2024/10\n    --INDEX_ID                 -- インデックス番号　削除 2024/10\n     KEY_1X                   -- ガスメータ設置場所番号\n    ,KEY_3X                   -- お客さま登録番号\n    ,GAS_4X                   -- ガス使用契約番号\n    ,EL_4X                    -- 電力使用契約番号\n    ,KEY_8X                   -- カスタマ番号\n    ,SUPPLY_POINT_ID          -- 供給地点特定番号\n    ,SA_ID                    -- 電力契約番号\n    ,START_DATE               -- 使用開始日\n    ,APPLICATION_DT           -- 申込日\n    --,USAGESERVICE_OUTPUT_DATE -- 利用サービス出力日　削除 2024/10\n    --,''                       -- 初回請求確定出力日　削除 2024/10\n    ,SA_TYPE_CD               -- 契約タイプ　2024/10 追加\n\t,@runYMD\nFROM [omni].[omni_ods_ma_trn_new_electricity_contract_temp] ct         -- 中間①\nWHERE not EXISTS(\n    SELECT 1 FROM [omni].[omni_ods_ma_trn_electricity_thanks_history] th -- 電気契約Thanks履歴\n    WHERE ct.SUPPLY_POINT_ID=th.SUPPLY_POINT_ID AND ct.KEY_3X=th.KEY_3X\n)  -- 電気契約Thanks履歴に同一の「供給地点特定番号、お客さま登録番号」が存在しない場合に挿入する\n;\n\n\n------------------------------------------------------------------\n--④ MA向けに出力する\nDECLARE @targetDate30 varchar(8);   -- 抽出対象日=実行日-30日\nSET @targetDate30=format(DATEADD(DAY,-30,@today_jst),'yyyyMMdd');\n\nDECLARE @targetDate25 varchar(8);   -- 抽出対象日=実行日-25日\nSET @targetDate25=format(DATEADD(DAY,-25,@today_jst),'yyyyMMdd');\n\nDECLARE @outputDT varchar(20);   -- IF出力日時\nSET @outputDT=format(CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyy/MM/dd HH:mm:ss');\n\nSELECT\n    --Bx                        -- Bx　削除 2024/10\n     MTGID                    -- mTGID\n    --,INDEX_ID                 -- インデックス番号　削除 2024/10\n    ,KEY_1X                   -- ガスメータ設置場所番号\n    ,KEY_3X                   -- お客さま登録番号\n    ,GAS_4X                   -- ガス使用契約番号\n    ,EL_4X                    -- 電力使用契約番号\n    ,KEY_8X                   -- カスタマ番号\n    ,SUPPLY_POINT_ID          -- 供給地点特定番号\n    ,SA_ID                    -- 電力契約番号\n    ,START_DATE               -- 使用開始日\n    ,APPLICATION_DT           -- 申込日\n    ,SA_TYPE_CD               -- 契約タイプ　追加 2024/10\n    ,TRKSBTCD                 -- 種別コード　追加 2024/10\n    ,@outputDT as OUTPUT_DATETIME  -- IF出力日時\nFROM(\n    SELECT\n         cpkiyk.MTGID\n        ,txhis.KEY_1X                   -- ガスメータ設置場所番号\n        ,txhis.KEY_3X                   -- お客さま登録番号\n        ,txhis.GAS_4X                   -- ガス使用契約番号\n        ,txhis.EL_4X                    -- 電力使用契約番号\n        ,txhis.KEY_8X                   -- カスタマ番号\n        ,txhis.SUPPLY_POINT_ID          -- 供給地点特定番号\n        ,txhis.SA_ID                    -- 電力契約番号\n        ,txhis.START_DATE               -- 使用開始日\n        ,txhis.APPLICATION_DT           -- 申込日\n        ,txhis.SA_TYPE_CD               -- 契約タイプ　追加 2024/10\n        ,cpkiyk.TRKSBTCD                -- 種別コード　追加 2024/10\n--        ,ROW_NUMBER() OVER(PARTITION BY cpkiyk.MTGID ORDER BY cpkiyk.CSV_YMD desc)  as rownum   -- MTGIDが一意になるようにする　削除 2024/10\n    FROM [omni].[omni_ods_ma_trn_electricity_thanks_history] txhis -- 電気契約Thanks履歴\n    INNER JOIN [omni].[omni_ods_mytginfo_trn_cpkiyk] cpkiyk        -- 本人特定契約　変更 2024/10\n           ON cpkiyk.CST_REG_NO=txhis.KEY_3X AND cpkiyk.TAIKAI_FLAG=0\n    WHERE @targetDate30<=txhis.START_DATE AND txhis.START_DATE<=@targetDate25  -- 実行日-30日<=使用開始日<=実行日-25日\n)tmp\n;\n",
                                "queryTimeout": "02:00:00",
                                "partitionOption": "None"
                            },
                            "sink": {
                                "type": "DelimitedTextSink",
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextWriteSettings",
                                    "quoteAllText": true,
                                    "fileExtension": ".csv"
                                }
                            },
                            "enableStaging": false,
                            "translator": {
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": true,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_DamDwhTable_shir",
                                "type": "DatasetReference",
                                "parameters": {
                                    "table": "--"
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_CSV_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/ElectricityContractThanks",
                                    "columnDelimiter": ",",
                                    "quoteChar": "\"",
                                    "firstRowAsHeader": true,
                                    "filename": {
                                        "value": "@concat('ElectricityContractThanks_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "at_SendSftp_ElectricityContractThanks",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "at_CreateCSV_ElectricityContractThanks",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/ElectricityContractThanks",
                                    "filename": {
                                        "value": "@concat('ElectricityContractThanks_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/ElectricityContractThanks",
                                    "filename": {
                                        "value": "@concat('ElectricityContractThanks_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "SMC"
                },
                "annotations": [],
                "lastPublishTime": "2024-11-28T10:56:23Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Send_PaymentMethodChanged')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "支払い方法変更",
                "activities": [
                    {
                        "name": "at_CreateCSV_PaymentMethodChanged",
                        "type": "Copy",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "SqlDWSource",
                                "sqlReaderQuery": "-- 「支払方法変更」作成 at_CreateCSV_PaymentMethodChanged\n\nDECLARE @isChanged int;\n\nDECLARE @recRecDT_pre varchar(8);   -- 前日分ガス契約（契約中）日次お客さま情報_tempの登録日\nDECLARE @recRecDT     varchar(8);   -- ODM.ガス契約（契約中）日次お客さま情報の登録日\n\nSELECT top 1 @recRecDT_pre=[REC_REG_YMD2] FROM [omni].[omni_odm_gascstmr_trn_previousday_gaskiy_temp]\nSELECT top 1 @recRecDT=[REC_REG_YMD2] FROM [omni].[omni_odm_gascstmr_trn_gaskiy]\n\nSELECT @isChanged=count(*)\nFROM [omni].[omni_ods_ma_trn_changed_payment_temp]\nWHERE [REC_REG_YMD_PRE]=@recRecDT_pre and [REC_REG_YMD]=@recRecDT;\n\nIF @isChanged=0  -- 以前に「支払い方法が変更された顧客_temp」を作成したときに使用した前日分とODMが変化したとき\n    BEGIN\n        -- ①作業テーブル作成\n\n        TRUNCATE TABLE [omni].[omni_ods_ma_trn_changed_payment_temp];   -- 支払い方法が変更された顧客_temp\n\n        INSERT [omni].[omni_ods_ma_trn_changed_payment_temp]\n        SELECT\n             B.[SYO_KYO_TRNO]\n            ,A.REC_REG_YMD2\n            ,B.REC_REG_YMD2\n        FROM [omni].[omni_odm_gascstmr_trn_previousday_gaskiy_temp] A   -- 前日分ガス契約（契約中）日次お客さま情報_temp\n        INNER JOIN [omni].[omni_odm_gascstmr_trn_gaskiy] B              -- ODM.ガス契約（契約中）日次お客さま情報\n              ON A.[SVKY_NO]=B.[SVKY_NO]\n              AND A.[SIH_KIY_NO]=B.[SIH_KIY_NO]\n        WHERE A.[SIH_HUHU_SHBT]='2'    -- 2:払込\n          and B.[SIH_HUHU_SHBT]<>'2'\n          and B.[SIK_SVC_SHBT] not in ('11','12','13','21')\n        ;\n\n\n        -- 「支払方法変更」出力\n        DECLARE @today_jst varchar(20);  -- 実行日\n        SET @today_jst=format(CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyy/MM/dd HH:mm:ss');\n\n        SELECT Bx\n              ,INDEX_ID\n              ,SYO_KYO_TRNO\n              ,@today_jst as OUTPUT_DATETIME\n        FROM (\n            SELECT\n                 A.Bx\n                ,A.INDEX_ID\n                ,t.SYO_KYO_TRNO\n                ,ROW_NUMBER() OVER(PARTITION BY [Bx] ORDER BY [OUTPUT_DATE] desc) as rown   -- 同一Bx中のOUTPUT_DATEの降順\n            FROM [omni].[omni_ods_cloak_trn_usageservice] A              -- 利用サービス\n            INNER JOIN [omni].[omni_ods_ma_trn_changed_payment_temp] t   -- 支払い方法が変更された顧客_temp\n                  ON A.USER_KEY=t.SYO_KYO_TRNO\n                  AND A.USER_KEY_TYPE='003'\n                  AND A.SERVICE_TYPE='001'     -- 001：ガス\n                  AND A.TRANSFER_TYPE='02'     -- 2:提供中\n        )tmp\n        WHERE rown=1\n        ;\n    END\nELSE\n    BEGIN\n        -- 前日分とODMが変化ないため、カラムだけ出力する\n        SELECT top 0\n             NULL as Bx\n            ,NULL as INDEX_ID\n            ,NULL as SYO_KYO_TRNO\n            ,NULL as OUTPUT_DATETIME\n        ;\n    END\n;\n",
                                "queryTimeout": "02:00:00",
                                "partitionOption": "None"
                            },
                            "sink": {
                                "type": "DelimitedTextSink",
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextWriteSettings",
                                    "quoteAllText": true,
                                    "fileExtension": ".csv"
                                }
                            },
                            "enableStaging": false,
                            "translator": {
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": true,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_DamDwhTable_shir",
                                "type": "DatasetReference",
                                "parameters": {
                                    "table": "--"
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_CSV_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/PaymentMethodChanged",
                                    "columnDelimiter": ",",
                                    "quoteChar": "\"",
                                    "firstRowAsHeader": true,
                                    "filename": {
                                        "value": "@concat('PaymentMethodChanged_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "at_SendSftp_PaymentMethodChanged",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "at_CreateCSV_PaymentMethodChanged",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:00:00",
                                    "useTempFileRename": true
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/PaymentMethodChanged",
                                    "filename": {
                                        "value": "@concat('PaymentMethodChanged_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/PaymentMethodChanged",
                                    "filename": {
                                        "value": "@concat('PaymentMethodChanged_', convertFromUtc(utcnow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "SMC"
                },
                "annotations": [],
                "lastPublishTime": "2024-11-28T10:30:09Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Send_LIMSettlementBreakdownRepair')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "DAM-DBから「ガス機器・水まわり修理 関連商材訴求」IFに必要なデータを抽出、gzipファイルでBLOB出力し、SFMCにSFTP連携する。",
                "activities": [
                    {
                        "name": "at_CreateCSV_LIMSettlementBreakdownRepair",
                        "description": "DBから「ガス機器・水まわり修理 関連商材訴求」IFに必要なデータを抽出、gzipファイルでBLOB出力",
                        "type": "Copy",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "SqlDWSource",
                                "sqlReaderQuery": "--------------------------------------------------------------------------\n-- MA向けリスト連携（ガス機器・水まわり修理）\n--------------------------------------------------------------------------\n\nDECLARE @today_jst DATETIME;        -- 実行日\nSET @today_jst = CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time')\n\nDECLARE @targetDate varchar(8);     -- 抽出対象日=実行日-21日\nSET @targetDate = format(DATEADD(DAY,-21,@today_jst),'yyyyMMdd');\n\n------------------------------------------------------------------\n--① 中間①に出力する\nTRUNCATE TABLE [omni].[omni_ods_ma_trn_lim_settlement_breakdown_repair_temp];\n\nINSERT INTO [omni].[omni_ods_ma_trn_lim_settlement_breakdown_repair_temp]\n\nSELECT\n      GMT_SET_NO                                                                                           --ガスメータ設置場所番号\n     ,WORK_COMPLETION_DATE                                                                                 --作業完了年月日\n     ,MAX(CASE WHEN WORK_SUBJECT_CATEGORY_CODE = '11' THEN '1'ELSE '0' END) AS GAS_APPLIANCES_REPAIR_FLAG  --ガス機器修理フラグ\n     ,MAX(CASE WHEN WORK_SUBJECT_CATEGORY_CODE = '1A' THEN '1'ELSE '0' END) AS WET_AREA_REPAIR_FLAG        --水まわり修理フラグ\nFROM [omni].[omni_ods_livalit_trn_lim_settlement_breakdown_repair]  --ＬＩＭ精算用故障修理データ\nWHERE  GMT_SET_NO <> '00000000000'                      --ガスメータ設置場所番号が無い(00000000000)レコード以外抽出する\n       AND TG_ACCEPTANCE_INSPECTION_DATE <> '00000000'  --TG検収年月日が無い(00000000)レコード以外を抽出する\n       AND WORK_COMPLETION_DATE >= @targetDate          --実行日から21日以内のお客様を抽出する\n       AND FIELD_WORK_DETAIL_CATEGORY_CODE = '0301'       --フィールド業務詳細区分コード が0301(一般機器)を抽出する\n       AND WORK_SUBJECT_CATEGORY_CODE IN ('11','1A')    --作業対象区分コードが11(一般機器)か1A(水まわり修理(加入なし))を抽出する\nGROUP BY GMT_SET_NO,WORK_COMPLETION_DATE \n\n;\n------------------------------------------------------------------\n\n-- 中間①のうち対象外のレコードを削除する\nDELETE FROM [omni].[omni_ods_ma_trn_lim_settlement_breakdown_repair_temp]\nWHERE GMT_SET_NO in(\n    SELECT\n         KEY_1X\n    FROM (\n        SELECT Bx\n              ,SERVICE_KEY1 AS KEY_1X    -- ガスメータ設置場所番号\n        FROM [omni].[omni_ods_cloak_trn_usageservice]\n        WHERE TRANSFER_TYPE = '02'  --異動種別=02(提供中)\n          AND SERVICE_KEY_TYPE1 = '001'\n        UNION \n        SELECT Bx\n              ,SERVICE_KEY2 AS KEY_1X    -- ガスメータ設置場所番号\n        FROM [omni].[omni_ods_cloak_trn_usageservice]\n        WHERE TRANSFER_TYPE = '02'  --異動種別=02(提供中)\n          AND SERVICE_KEY_TYPE2 = '001'\n        UNION \n        SELECT Bx\n              ,SERVICE_KEY3 AS KEY_1X    -- ガスメータ設置場所番号\n        FROM [omni].[omni_ods_cloak_trn_usageservice]\n        WHERE TRANSFER_TYPE = '02'  --異動種別=02(提供中)\n          AND SERVICE_KEY_TYPE3 = '001'\n    ) tmp\n    GROUP BY KEY_1X\n    HAVING count(*)>1   -- 1x:Bx=1:n -- 出力対象外\n)\n;\n\n------------------------------------------------------------------\n--② MA向けに出力する\nDECLARE @outputDT varchar(20);   -- IF出力日時\nSET @outputDT = format(CONVERT(DATETIME, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyy/MM/dd HH:mm:ss');\n\nSELECT      \n     Bx                            --Bx\n    ,myTGID AS mTGID               --myTGID\n    ,INDEX_ID                      --インデックス番号\n    ,GMT_SET_NO                    --ガスメータ設置場所番号\n    ,WORK_COMPLETION_DATE          --作業完了年月日\n    ,GAS_APPLIANCES_REPAIR_FLAG    --ガス機器修理フラグ\n    ,WET_AREA_REPAIR_FLAG          --水まわり修理フラグ\n    ,@outputDT AS OUTPUT_DATETIME  --IF出力日時\nFROM(\n    SELECT\n           us.Bx                           --Bx\n          ,us.myTGID                       --myTGID\n          ,us.INDEX_ID                     --インデックス番号\n          ,rep.GMT_SET_NO                  --ガスメータ設置場所番号\n          ,WORK_COMPLETION_DATE            --作業完了年月日\n          ,rep.GAS_APPLIANCES_REPAIR_FLAG  --ガス機器修理フラグ\n          ,rep.WET_AREA_REPAIR_FLAG        --水まわり修理フラグ\n          ,ROW_NUMBER() OVER(PARTITION BY us.Bx,rep.GMT_SET_NO,rep.WORK_COMPLETION_DATE  ORDER BY OUTPUT_DATE desc)  as rownum -- 同一「Bx,ガスメータ設置場所番号,作業完了年月日」に異なる「INDEX_ID」が存在する場合は「OUTPUT_DATE」が新しいレコードを抽出する\n    FROM [omni].[omni_ods_ma_trn_lim_settlement_breakdown_repair_temp] rep  --中間①\n    INNER JOIN [omni].[omni_ods_cloak_trn_usageservice] us                  -- 利用サービス\n            ON rep.GMT_SET_NO in(us.SERVICE_KEY1,us.SERVICE_KEY2,us.SERVICE_KEY3)\n           AND TRANSFER_TYPE = '02'  --異動種別が02(提供中)のレコードを抽出する\n)tmp\nWHERE rownum = 1\n;\n",
                                "queryTimeout": "02:00:00",
                                "partitionOption": "None"
                            },
                            "sink": {
                                "type": "DelimitedTextSink",
                                "storeSettings": {
                                    "type": "AzureBlobStorageWriteSettings"
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextWriteSettings",
                                    "quoteAllText": true,
                                    "fileExtension": ".csv"
                                }
                            },
                            "enableStaging": false,
                            "translator": {
                                "type": "TabularTranslator",
                                "typeConversion": true,
                                "typeConversionSettings": {
                                    "allowDataTruncation": true,
                                    "treatBooleanAsNumber": false
                                }
                            }
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_DamDwhTable_shir",
                                "type": "DatasetReference",
                                "parameters": {
                                    "table": "--"
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_CSV_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/LIMSettlementBreakdownRepair",
                                    "columnDelimiter": ",",
                                    "quoteChar": "\"",
                                    "firstRowAsHeader": true,
                                    "filename": {
                                        "value": "@concat('LIMSettlementBreakdownRepair_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "at_SendSftp_LIMSettlementBreakdownRepair",
                        "description": "Blobに出力されたgzipファイルをSFMCにSFTP連携",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "at_CreateCSV_LIMSettlementBreakdownRepair",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/LIMSettlementBreakdownRepair",
                                    "filename": {
                                        "value": "@concat('LIMSettlementBreakdownRepair_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/LIMSettlementBreakdownRepair",
                                    "filename": {
                                        "value": "@concat('LIMSettlementBreakdownRepair_', convertFromUtc(utcNow(), 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "SMC"
                },
                "annotations": [],
                "lastPublishTime": "2025-05-09T02:11:11Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Insert_mTGCustomerMaster')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "ODM「mTG会員_契約中フラグ」、「mTG会員_会員マスタ」、「mTG会員契約マスタ」のデータを作成する",
                "activities": [
                    {
                        "name": "at_Insert_InternalAreaGasAndPower_FullContractFlag_temp",
                        "description": "(f)-4 本人特定契約に電力ＣＩＳ契約情報の域内ガス電気合算契約中フラグを付与し、mTG会員_全量契約中フラグ_tempに出力する",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_ExternalAreaGas_FullContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\n-- (f)-4 域内ガス電気合算契約\n-- 本人特定契約テーブル、電力ＣＩＳ契約情報 → mTG会員_全量契約中フラグ_temp\n-- \n-- 2025/03/04  新規作成\n--------------------------------------------------------------------------\nINSERT INTO [omni].[omni_odm_mytginfo_trn_mtgmaster_full_under_contract_flag_temp]      -- mTG会員_全量契約中フラグ_temp\nSELECT\n     cpkiyk.MTGID                                        -- mTG会員ID\n    ,cpkiyk.EDA_NO                                       -- 枝番\n    ,NULL AS INTERNAL_AREA_GAS_FLAG                      -- ガス契約中フラグ\n    ,99   AS EXTERNAL_AREA_GAS_FLAG                      -- 域外ガス契約中フラグ (99:不明)\n    ,1    AS INTERNAL_AREA_GAS_AND_POWER_FLAG            -- 域内ガス電気合算契約中フラグ (0:契約中ではない 1:契約中)\n    ,NULL AS EXTERNAL_AREA_GAS_AND_POWER_FLAG            -- 域外ガス電気合算契約中フラグ\n    ,NULL AS POWER_FLAG                                  -- 電気単独契約中フラグ\nFROM [omni].[omni_ods_mytginfo_trn_cpkiyk] cpkiyk        -- 本人特定契約\nINNER JOIN [omni].[omni_ods_epcis_trn_contract] epcis    -- 電力ＣＩＳ契約情報\n     ON cpkiyk.CST_REG_NO = epcis.KEY_3X                 -- お客さま登録番号 (3x)\n     AND cpkiyk.SYOKY_NO = epcis.GAS_4X                  -- 使用契約番号 (4x) ＝ ガス使用契約番号 (4x)\n     AND epcis.SA_TYPE_CD = 'ESLVY'                      -- 契約タイプ (低圧電力合算)\n     AND epcis.CONTRACT_STATUS = '20'                    -- 契約ステータス (20:有効)\nWHERE TAIKAI_FLAG = 0                                    -- 退会フラグ (0:活きているレコード)\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Delete_FullContractFlag_temp",
                        "description": "(f)-1 mTG会員_全量契約中フラグ_tempの全レコードを削除する",
                        "type": "Script",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (f)-1 mTG会員_全量契約中フラグ_tempの全レコードを削除する\r\n-- \r\n-- 2025/03/04  新規作成\r\n--------------------------------------------------------------------------\r\nTRUNCATE TABLE [omni].[omni_odm_mytginfo_trn_mtgmaster_full_under_contract_flag_temp] -- mTG会員_全量契約中フラグ_temp\r\n;\r\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_InternalAreaGas_FullContractFlag_temp",
                        "description": "(f)-2 本人特定契約にガス契約（契約中）日次お客さま情報の域内ガス契約中フラグを付与し、mTG会員_全量契約中フラグ_tempに出力する",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Delete_FullContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (f)-2 域内ガス契約\r\n-- 本人特定契約テーブル、ガス契約（契約中）日次お客さま情報 → mTG会員_全量契約中フラグ_temp\r\n-- \r\n-- 2025/03/04  新規作成\r\n--------------------------------------------------------------------------\r\nINSERT INTO [omni].[omni_odm_mytginfo_trn_mtgmaster_full_under_contract_flag_temp]      -- mTG会員_全量契約中フラグ_temp\r\nSELECT\r\n     cpkiyk.MTGID                                              -- mTG会員ID\r\n    ,cpkiyk.EDA_NO                                             -- 枝番\r\n    ,1    AS INTERNAL_AREA_GAS_FLAG                            -- ガス契約中フラグ (0:契約中ではない 1:契約中)\r\n    ,99   AS EXTERNAL_AREA_GAS_FLAG                            -- 域外ガス契約中フラグ (99:不明)\r\n    ,NULL AS INTERNAL_AREA_GAS_AND_POWER_FLAG                  -- 域内ガス電気合算契約中フラグ\r\n    ,NULL AS EXTERNAL_AREA_GAS_AND_POWER_FLAG                  -- 域外ガス電気合算契約中フラグ\r\n    ,NULL AS POWER_FLAG                                        -- 電気単独契約中フラグ\r\nFROM [omni].[omni_ods_mytginfo_trn_cpkiyk] cpkiyk              -- 本人特定契約\r\nINNER JOIN [omni].[omni_odm_gascstmr_trn_gaskiy] gaskiy        -- ガス契約（契約中）日次お客さま情報\r\n     ON cpkiyk.SYOKY_NO = convert(varchar, gaskiy.SVKY_NO)     -- 使用契約番号 (4x) ＝ サービス契約番号 (4x)\r\n     AND gaskiy.GMT_KHS_JTKB = '1'                             -- ガスメーター開閉栓状態区分 (1:開栓中)\r\nWHERE TAIKAI_FLAG = 0                                          -- 退会フラグ (0:活きているレコード)\r\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_ExternalAreaGas_FullContractFlag_temp",
                        "description": "(f)-3 域外ガス契約中フラグは未定",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_InternalAreaGas_FullContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (f)-3 域外ガス契約\r\n-- 未定\r\n-- 空ではエラーになるため、今はmTG会員_全量契約中フラグ_tempからレコードSELECTする\r\n-- \r\n-- 2025/03/04  新規作成\r\n--------------------------------------------------------------------------\r\nSELECT TOP 0 *\r\nFROM [omni].[omni_odm_mytginfo_trn_mtgmaster_full_under_contract_flag_temp]      -- mTG会員_全量契約中フラグ_temp\r\n;\r\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_ExternalAreaGasAndPower_FullContractFlag_temp",
                        "description": "(f)-5 本人特定契約に電力ＣＩＳ契約情報の域外ガス電気合算契約中フラグを付与し、mTG会員_全量契約中フラグ_tempに出力する",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_InternalAreaGasAndPower_FullContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (f)-5 域外ガス電気合算契約\r\n-- 本人特定契約テーブル、電力ＣＩＳ契約情報 → mTG会員_全量契約中フラグ_temp\r\n-- \r\n-- 2025/03/04  新規作成\r\n--------------------------------------------------------------------------\r\nINSERT INTO [omni].[omni_odm_mytginfo_trn_mtgmaster_full_under_contract_flag_temp]      -- mTG会員_全量契約中フラグ_temp\r\nSELECT\r\n     cpkiyk.MTGID                                        -- mTG会員ID\r\n    ,cpkiyk.EDA_NO                                       -- 枝番\r\n    ,NULL AS INTERNAL_AREA_GAS_FLAG                      -- ガス契約中フラグ\r\n    ,99   AS EXTERNAL_AREA_GAS_FLAG                      -- 域外ガス契約中フラグ (99:不明)\r\n    ,NULL AS INTERNAL_AREA_GAS_AND_POWER_FLAG            -- 域内ガス電気合算契約中フラグ\r\n    ,1    AS EXTERNAL_AREA_GAS_AND_POWER_FLAG            -- 域外ガス電気合算契約中フラグ (0:契約中ではない 1:契約中)\r\n    ,NULL AS POWER_FLAG                                  -- 電気単独契約中フラグ\r\nFROM [omni].[omni_ods_mytginfo_trn_cpkiyk] cpkiyk        -- 本人特定契約\r\nINNER JOIN [omni].[omni_ods_epcis_trn_contract] epcis    -- 電力ＣＩＳ契約情報\r\n     ON cpkiyk.CST_REG_NO = epcis.KEY_3X                 -- お客さま登録番号 (3x)\r\n     AND epcis.SA_TYPE_CD = 'ESOLY'                      -- 契約タイプ (低圧電力域外合算)\r\n     AND epcis.CONTRACT_STATUS = '20'                    -- 契約ステータス (20:有効)\r\nWHERE TAIKAI_FLAG = 0                                    -- 退会フラグ (0:活きているレコード)\r\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_Power_FullContractFlag_temp",
                        "description": "(f)-6 本人特定契約に電力ＣＩＳ契約情報の電気単独契約中フラグを付与し、mTG会員_全量契約中フラグ_tempに出力する",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_ExternalAreaGasAndPower_FullContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (f)-6 電気単独契約\r\n-- 本人特定契約テーブル、電力ＣＩＳ契約情報 → mTG会員_全量契約中フラグ_temp\r\n-- \r\n-- 2025/03/04  新規作成\r\n--------------------------------------------------------------------------\r\nINSERT INTO [omni].[omni_odm_mytginfo_trn_mtgmaster_full_under_contract_flag_temp]      -- mTG会員_全量契約中フラグ_temp\r\nSELECT\r\n     cpkiyk.MTGID                                        -- mTG会員ID\r\n    ,cpkiyk.EDA_NO                                       -- 枝番\r\n    ,NULL AS INTERNAL_AREA_GAS_FLAG                      -- ガス契約中フラグ\r\n    ,99   AS EXTERNAL_AREA_GAS_FLAG                      -- 域外ガス契約中フラグ (99:不明)\r\n    ,NULL AS INTERNAL_AREA_GAS_AND_POWER_FLAG            -- 域内ガス電気合算契約中フラグ\r\n    ,NULL AS EXTERNAL_AREA_GAS_AND_POWER_FLAG            -- 域外ガス電気合算契約中フラグ\r\n    ,1    AS POWER_FLAG                                  -- 電気単独契約中フラグ (0:契約中ではない 1:契約中)\r\nFROM [omni].[omni_ods_mytginfo_trn_cpkiyk] cpkiyk        -- 本人特定契約\r\nINNER JOIN [omni].[omni_ods_epcis_trn_contract] epcis    -- 電力ＣＩＳ契約情報\r\n     ON cpkiyk.CST_REG_NO = epcis.KEY_3X                 -- お客さま登録番号 (3x)\r\n     AND epcis.SA_TYPE_CD = 'ESLVN'                      -- 契約タイプ (低圧電力単独)\r\n     AND epcis.CONTRACT_STATUS = '20'                    -- 契約ステータス (20:有効)\r\nWHERE TAIKAI_FLAG = 0                                    -- 退会フラグ (0:活きているレコード)\r\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_ContractFlag_temp",
                        "description": "(g)-1 mTG会員_全量契約中フラグ_tempのデータを集約し、mTG会員_契約中フラグ_tempに出力する",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_Power_FullContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\n-- (g)-1 mTG会員_全量契約中フラグ_temp → mTG会員_契約中フラグ_temp\n-- mTG会員ID + 枝番で一意にする\n-- \n-- 2025/03/04  新規作成\n--------------------------------------------------------------------------\nTRUNCATE TABLE [omni].[omni_odm_mytginfo_trn_mtgmaster_under_contract_flag_temp];       -- mTG会員_契約中フラグ_temp\nINSERT INTO [omni].[omni_odm_mytginfo_trn_mtgmaster_under_contract_flag_temp]           -- mTG会員_契約中フラグ_temp\nSELECT\n     MTGID                                                                              -- mTG会員ID\n    ,EDA_NO                                                                             -- 枝番\n    ,MAX(INTERNAL_AREA_GAS_FLAG) AS INTERNAL_AREA_GAS_FLAG                              -- ガス契約中フラグ\n    ,MAX(EXTERNAL_AREA_GAS_FLAG) AS EXTERNAL_AREA_GAS_FLAG                              -- 域外ガス契約中フラグ 99:不明固定\n    ,MAX(INTERNAL_AREA_GAS_AND_POWER_FLAG) AS INTERNAL_AREA_GAS_AND_POWER_FLAG          -- 域内ガス電気合算契約中フラグ\n    ,MAX(EXTERNAL_AREA_GAS_AND_POWER_FLAG) AS EXTERNAL_AREA_GAS_AND_POWER_FLAG          -- 域外ガス電気合算契約中フラグ\n    ,MAX(POWER_FLAG) AS POWER_FLAG                                                      -- 電気単独契約中フラグ\nFROM [omni].[omni_odm_mytginfo_trn_mtgmaster_full_under_contract_flag_temp]             -- mTG会員_全量契約中フラグ_temp\nGROUP BY\n      MTGID\n     ,EDA_NO\n;\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_permission_info_temp",
                        "description": "(a) メールサービスの、サービスコードから許諾情報の有無しのフラグを判定し mTG会員_許諾情報_tempに出力",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_ContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (a)メールサービス → mTG会員_許諾情報_temp\r\n-- \r\n-- 2025/05/16  新規作成\r\n--------------------------------------------------------------------------\r\n-- 変数宣言\r\nDECLARE @today_jst datetime ;\r\nDECLARE @today varchar(8);\r\nSET @today_jst = CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');\r\nSET @today = FORMAT(@today_jst, 'yyyyMMdd');\r\n\r\n-- mTG会員_許諾情報_temp\r\nTRUNCATE TABLE [omni].[omni_ods_mytginfo_trn_mtgmaster_permission_info_temp];\r\n\r\nINSERT INTO [omni].[omni_ods_mytginfo_trn_mtgmaster_permission_info_temp] --mTG会員_許諾情報_tempに登録\r\nSELECT\r\n     ID_NO                                       -- 会員ID\r\n    ,max(PERMISSION_INFO_1) as PERMISSION_INFO_1 -- 許諾情報_サービスコード31フラグ\r\n    ,max(PERMISSION_INFO_2) as PERMISSION_INFO_2 -- 許諾情報_サービスコード32フラグ\r\n    ,max(PERMISSION_INFO_3) as PERMISSION_INFO_3 -- 許諾情報_サービスコード33フラグ\r\n    ,max(PERMISSION_INFO_4) as PERMISSION_INFO_4 -- 許諾情報_サービスコード24フラグ\r\n\r\nFROM(\r\n    SELECT\r\n        ID_NO                                                                         -- 会員ID\r\n        -- 許諾情報_サービスコード31フラグの値の抽出\r\n         ,CASE\r\n             WHEN SVC_CD = '31' AND @today < END_YMD THEN 1\r\n             WHEN SVC_CD = '31' AND (@today >= END_YMD OR END_YMD IS NULL) THEN 0\r\n             ELSE 0\r\n         END AS PERMISSION_INFO_1                                                     -- 許諾情報_サービスコード31フラグ\r\n\r\n        -- 許諾情報_サービスコード32フラグの値の抽出(WebShop廃止で0固定）\r\n         ,0 AS PERMISSION_INFO_2                                                      -- 許諾情報_サービスコード32フラグ\r\n \r\n        -- 許諾情報_サービスコード33フラグの値の抽出\r\n         ,CASE\r\n             WHEN SVC_CD = '33' AND @today < END_YMD THEN 1\r\n             WHEN SVC_CD = '33' AND (@today >= END_YMD OR END_YMD IS NULL) THEN 0\r\n             ELSE 0\r\n         END AS PERMISSION_INFO_3                                                     -- 許諾情報_サービスコード33フラグ\r\n\r\n        -- 許諾情報_サービスコード24フラグの値の抽出SVC_CD\r\n         ,CASE\r\n             WHEN SVC_CD = '24' AND @today < END_YMD THEN 1\r\n             WHEN SVC_CD = '24' AND (@today >= END_YMD OR END_YMD IS NULL) THEN 0\r\n             ELSE 0\r\n         END AS PERMISSION_INFO_4                                                     -- 許諾情報_サービスコード24フラグ\r\n    FROM [omni].[omni_ods_mytginfo_trn_mailsvc]                                       -- メールサービス\r\n    WHERE SVC_CD IN ('31','33','24')                                                  -- サービスコードが31、33、34のどれかに一致するレコード\r\n) tmp\r\n \r\nGROUP BY ID_NO                                                                        -- 会員ID\r\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_point_expiration_date_temp",
                        "description": "(b) ポイント残高連携リストの有効期限が実行日より未来日のポイントをMTGIDごとに合算してmTG会員_ポイント有効期限_temp出力",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_ContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (b)ポイント残高連携リスト → mTG会員_ポイント有効期限_temp\r\n-- \r\n-- 2025/05/16  新規作成\r\n--------------------------------------------------------------------------\r\n-- 変数宣言\r\nDECLARE @today_jst datetime ;\r\nDECLARE @today varchar(8);\r\nSET @today_jst = CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');\r\nSET @today = FORMAT(@today_jst, 'yyyyMMdd');\r\n\r\n-- mTG会員_ポイント有効期限_temp\r\nTRUNCATE TABLE [omni].[omni_ods_mytginfo_trn_mtgmaster_point_expiration_date_temp];\r\n\r\nINSERT INTO [omni].[omni_ods_mytginfo_trn_mtgmaster_point_expiration_date_temp] --mTG会員_ポイント有効期限_tempに登録\r\nSELECT MTGID                                    -- mTG会員ID\r\n      ,MIN(EXPIRE_DATE) AS EXPIRE_DATE          -- 直近の有効期限\r\n      ,SUM(BALANCE_POINT) AS BALANCE_POINT_ALL  -- 残ポイントを集計\r\nFROM [omni].[omni_ods_mytgpnt_trn_pnt_bal]      -- ポイント残高連携リスト\r\nWHERE EXPIRE_DATE >= @today                     -- 有効期限>=実行日\r\nGROUP BY MTGID                                  -- 会員ID\r\n;\r\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_membership_type_temp",
                        "description": "(c) 会員種別において会員IDごとのレコード登録日時が最新のレコードの情報をmTG会員_会員種別_tempに出力",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_ContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (c)会員種別 → mTG会員_会員種別_temp\r\n-- \r\n-- 2025/05/16  新規作成\r\n--------------------------------------------------------------------------\r\n\r\n-- mTG会員_会員種別_temp\r\nTRUNCATE TABLE [omni].[omni_ods_mytginfo_trn_mtgmaster_member_type_temp];\r\n\r\nINSERT INTO [omni].[omni_ods_mytginfo_trn_mtgmaster_member_type_temp] -- mTG会員_会員種別_tempに登録\r\nSELECT ID_NO                              -- 会員ID\r\n      ,MAX(ID_SYB_CD) as ID_SYB_CD        -- 会員種別\r\nFROM [omni].[omni_ods_mytginfo_trn_cpsyb]         -- 会員種別\r\nGROUP BY ID_NO\r\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_lineid_linkageInfo_temp",
                        "description": "(d)LINEID連携累積情報から未連携、連携中の情報をmTG会員_LINEID連携累積情報_tempに出力",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_ContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (d)LINEID連携累積情報 → mTG会員_LINEID連携累積情報_temp\r\n-- \r\n-- 2025/05/16  新規作成\r\n--------------------------------------------------------------------------\r\n\r\n-- mTG会員_LINEID連携累積情報_temp\r\nTRUNCATE TABLE [omni].[omni_ods_mytginfo_trn_mtgmaster_lineid_linkageInfo_temp];\r\n\r\nINSERT INTO [omni].[omni_ods_mytginfo_trn_mtgmaster_lineid_linkageInfo_temp] -- mTG会員_LINEID連携累積情報_tempに登録\r\nSELECT \r\n    ID_NO                                                      -- 会員ID\r\n   ,MAX(CASE\r\n            WHEN KJ_FLG = '0' THEN LINE_U_ID\r\n            ELSE NULL\r\n        END\r\n    ) AS LINE_U_ID                                             -- LINE_uID\r\n   ,MAX(LINE_RNK_KJ_DTTM) as MOST_RECENT_LINEID_UNLINKED_DATE  -- 直近のLINEID連携解除日\r\n   ,MAX(CASE \r\n            WHEN KJ_FLG = '0' THEN 2\r\n            ELSE 1\r\n        END\r\n    ) AS LINEID_LINK_STATUS                                    -- LINEID連携ステータス\r\nFROM [mytg].[mytg_ods_line_mst_line_id_all]                    -- LINEID連携累積情報\r\nGROUP BY ID_NO\r\n;\r\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_ContractFlag",
                        "description": "(g)-2  本人特定契約、mTG会員_契約中フラグ_tempからデータを集約し、mTG会員_契約中フラグに出力",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_ContractFlag_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (g)-2 本人特定契約、mTG会員_契約中フラグ_temp → mTG会員_契約中フラグ\r\n-- \r\n-- 2025/05/16  新規作成\r\n--------------------------------------------------------------------------\r\n-- 変数宣言\r\nDECLARE @today_jst datetime ;\r\nDECLARE @today varchar(8);\r\nDECLARE @empty varchar(1);\r\nSET @today_jst = CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');\r\nSET @today = FORMAT(@today_jst, 'yyyyMMdd');\r\nSET @empty = '';\r\n\r\n\r\n-- mTG会員_契約中フラグ\r\nTRUNCATE TABLE [omni].[omni_odm_mytginfo_trn_mtgmaster_under_contract_flag];\r\n\r\nINSERT INTO [omni].[omni_odm_mytginfo_trn_mtgmaster_under_contract_flag] -- mTG会員_契約中フラグに登録\r\nSELECT \r\n    cpkiyk.MTGID                                                         -- MTGID\r\n    ,cpkiyk.EDA_NO                                                       -- 枝番\r\n    ,cpkiyk.GMT_SET_NO                                                   -- ガスメータ設置場所番号(1x)\r\n    ,cpkiyk.SYOKY_NO                                                     -- 使用契約番号(4x)\r\n    ,cpkiyk.CST_REG_NO                                                   -- お客さま登録番号(3x)\r\n    ,cpkiyk.SHRKY_NO                                                     -- 支払契約番号(2x)\r\n    ,cpkiyk.HJ_CST_NAME                                                  -- 表示名称\r\n    ,cpkiyk.TKTIYMD                                                      -- 特定年月日\r\n    ,cpkiyk.TRKSBTCD                                                     -- 種別コード\r\n    ,cpkiyk.REC_REG_YMD                                                  -- レコード登録年月日\r\n    ,cpkiyk.REC_REG_JKK                                                  -- レコード登録時刻\r\n    ,cpkiyk.REC_UPD_YMD                                                  -- レコード更新年月日\r\n    ,cpkiyk.REC_UPD_JKK                                                  -- レコード更新時刻\r\n    ,ISNULL(contract.INTERNAL_AREA_GAS_FLAG, 0)\r\n        as INTERNAL_AREA_GAS_FLAG                                        -- 域内ガス契約中フラグ\r\n    ,99 as EXTERNAL_AREA_GAS_FLAG                                        -- 域外ガス契約中フラグ\r\n    ,ISNULL(contract.INTERNAL_AREA_GAS_AND_POWER_FLAG, 0)\r\n        as INTERNAL_AREA_GAS_AND_POWER_FLAG                              -- 域内ガス電気合算契約中フラグ\r\n    ,ISNULL(contract.EXTERNAL_AREA_GAS_AND_POWER_FLAG, 0) \r\n        as EXTERNAL_AREA_GAS_AND_POWER_FLAG                              -- 域外ガス電気合算契約中フラグ\r\n    ,ISNULL(contract.POWER_FLAG, 0)                                      -- 域外ガス電気合算契約中フラグ\r\n        as POWER_FLAG                                                    -- 電気単独契約中フラグ\r\n    ,@today as REC_REG_YMD2                                              -- 登録日\r\n    ,@empty as REC_UPD_YMD2                                              -- 更新日\r\nFROM [omni].[omni_ods_mytginfo_trn_cpkiyk] cpkiyk                        -- 本人特定契約\r\nLEFT JOIN [omni].[omni_odm_mytginfo_trn_mtgmaster_under_contract_flag_temp] contract -- mTG会員_契約中フラグ_temp\r\n-- 本人特定契約.MTGID = mTG会員_契約中フラグ_temp.MTGID\r\nON cpkiyk.MTGID = contract.MTGID\r\n-- 本人特定契約.枝番 = mTG会員_契約中フラグ_temp.枝番\r\nAND cpkiyk.EDA_NO = contract.EDA_NO\r\n\r\n-- 本人特定契約.退会フラグ = 0\r\nWHERE cpkiyk.TAIKAI_FLAG = 0\r\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_mtgmaster_temp",
                        "description": "(e)会員基本情報,myTGID最新統合先マッピング,mTG会員_許諾情報_temp,mTG会員_ポイント有効期限_temp,mTG会員_取引情報_temp,mTG会員_会員種別_temp,mTG会員_LINEID連携累積情報_tempからmTG会員マスタ_tempに必要な情報をmTGIDを結合キーとして出力",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_permission_info_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "at_Insert_point_expiration_date_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "at_Insert_membership_type_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "at_Insert_lineid_linkageInfo_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (e)会員基本情報,\r\n--    myTGID最新統合先マッピング,\r\n--    mTG会員_許諾情報_temp,\r\n--    mTG会員_ポイント有効期限_temp,\r\n--    mTG会員_取引情報_temp,\r\n--    mTG会員_会員種別_temp,\r\n--    mTG会員_LINEID連携累積情報_temp\r\n--    ↓\r\n--    mTG会員マスタ_temp\r\n-- \r\n-- 2025/05/16  新規作成\r\n--------------------------------------------------------------------------\r\n-- 変数宣言\r\nDECLARE @today_jst datetime ;\r\nDECLARE @today varchar(8);\r\nDECLARE @empty varchar(1);\r\nSET @today_jst = CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');\r\nSET @today = FORMAT(@today_jst, 'yyyyMMdd');\r\nSET @empty = '';\r\n\r\n-- mTG会員マスタ_temp\r\nTRUNCATE TABLE [omni].[omni_odm_mytginfo_trn_mtgmaster_member_master_temp];\r\n\r\nINSERT INTO [omni].[omni_odm_mytginfo_trn_mtgmaster_member_master_temp] -- mTG会員マスタ_tempに登録\r\nSELECT\r\n    cpinfo.ID_NO as MTGID                                                                 -- 会員ID\r\n    ,cpinfo.MAIL_ADR                                                                      -- メールアドレス\r\n    ,cpinfo.REC_REG_YMD                                                                   -- 登録日\r\n    ,cpinfo.REC_UPD_YMD                                                                   -- 更新日\r\n    ,cpinfo.TAIKAI_FLAG                                                                   -- 退会フラグ\r\n    ,cpinfo.ID_KBN                                                                        -- 会員区分\r\n    ,cpinfo.REG_CD                                                                        -- 会員登録経路\r\n    ,cpinfo.REG_COMP_FLG                                                                  -- 会員登録完了フラグ\r\n    ,CASE WHEN LEN(cpinfo.BIRTHDAY) <> 8 OR                                               -- 生年月日\r\n          NOT (cpinfo.BIRTHDAY LIKE '19%' OR cpinfo.BIRTHDAY LIKE '20%') THEN NULL\r\n          ELSE cpinfo.BIRTHDAY\r\n     END as BIRTHDAY\r\n    ,mapping.myTGID_BEFORE as LATEST_MTGID                                                -- 最新統合先mTGID\r\n    ,ISNULL(permission.PERMISSION_INFO_SERVICE_CODE_31_FLAG, 0) \r\n         as PERMISSION_INFO_SERVICE_CODE_31_FLAG                                          -- 許諾情報_サービスコード31フラグ\r\n    ,0 as PERMISSION_INFO_SERVICE_CODE_32_FLAG                                            -- 許諾情報_サービスコード32フラグ\r\n    ,ISNULL(permission.PERMISSION_INFO_SERVICE_CODE_33_FLAG, 0) \r\n         as PERMISSION_INFO_SERVICE_CODE_33_FLAG                                          -- 許諾情報_サービスコード33フラグ\r\n    ,ISNULL(permission.PERMISSION_INFO_SERVICE_CODE_24_FLAG, 0) \r\n         as PERMISSION_INFO_SERVICE_CODE_24_FLAG                                          -- 許諾情報_サービスコード24フラグ\r\n    ,expiration.LATEST_EXPIRE_DATE                                                        -- 直近有効期限\r\n    ,expiration.REMAINING_POINTS_SUM                                                      -- 残ポイント合算\r\n    ,member.ID_SYB_CD                                                                     -- 会員種別\r\n    ,line.LINE_U_ID                                                                       -- LINE_U_ID\r\n    ,line.MOST_RECENT_LINEID_UNLINKED_DATE                                                -- 直近のLINEID連携解除日\r\n    ,ISNULL(line.LINEID_LINK_STATUS, 0) as LINEID_LINK_STATUS                             -- LINEID連携ステータス\r\n    ,cpinfo.FREE_ITEM01                                                                   -- 予備1\r\n    ,cpinfo.FREE_ITEM02                                                                   -- 予備2\r\n    ,cpinfo.FREE_ITEM03                                                                   -- 予備3\r\n    ,cpinfo.FREE_ITEM04                                                                   -- 予備4\r\n    ,cpinfo.FREE_ITEM05                                                                   -- 予備5\r\n    ,cpinfo.FREE_ITEM06                                                                   -- 予備6\r\n    ,cpinfo.FREE_ITEM07                                                                   -- 予備7\r\n    ,cpinfo.FREE_ITEM08                                                                   -- 予備8\r\n    ,cpinfo.FREE_ITEM09                                                                   -- 予備9\r\n    ,cpinfo.FREE_ITEM10                                                                   -- 予備10\r\n    ,@today as REC_REG_YMD2                                                               -- 登録日\r\n    ,@empty as REC_UPD_YMD2                                                               -- 更新日\r\n\r\nFROM [omni].[omni_ods_mytginfo_trn_cpinfo] cpinfo -- 会員基本情報\r\nLEFT JOIN [omni].[omni_ods_mytginfo_trn_mytgid_merge_latest_mapping] mapping              -- myTGID最新統合先マッピング\r\n-- 会員基本情報.会員ID = myTGID最新統合先マッピング.統合元mTGID\r\nON cpinfo.ID_NO = mapping.myTGID\r\n\r\nLEFT JOIN [omni].[omni_ods_mytginfo_trn_mtgmaster_permission_info_temp] permission        -- mTG会員_許諾情報_temp\r\n-- 会員基本情報.会員ID = mTG会員_許諾情報_temp.会員ID\r\nON cpinfo.ID_NO = permission.ID_NO\r\n\r\nLEFT JOIN [omni].[omni_ods_mytginfo_trn_mtgmaster_point_expiration_date_temp] expiration  -- mTG会員_ポイント有効期限_temp\r\n-- 会員基本情報.会員ID = mTG会員_ポイント有効期限_temp.mTG会員ID\r\nON cpinfo.ID_NO = expiration.MTGID\r\n\r\nLEFT JOIN [omni].[omni_ods_mytginfo_trn_mtgmaster_member_type_temp] member                -- mTG会員_会員種別_temp\r\n-- 会員基本情報.会員ID = mTG会員_会員種別_temp.会員ID\r\nON cpinfo.ID_NO = member.ID_NO\r\n\r\nLEFT JOIN [omni].[omni_ods_mytginfo_trn_mtgmaster_lineid_linkageInfo_temp] line           -- mTG会員_LINEID連携累積情報_temp\r\n-- 会員基本情報.会員ID = mTG会員_LINEID連携累積情報_temp.会員ID\r\nON cpinfo.ID_NO = line.ID_NO\r\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_mtgmaster_Contract",
                        "description": "(h) mTG会員マスタ_temp, mTG会員_契約中フラグからデータを集約し、mTG会員_契約マスタに出力",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_mtgmaster_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            },
                            {
                                "activity": "at_Insert_ContractFlag",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "--------------------------------------------------------------------------\r\n-- (h)mTG会員マスタ_temp, mTG会員_契約中フラグ → mTG会員_契約マスタ\r\n-- \r\n-- 2025/05/16  新規作成\r\n--------------------------------------------------------------------------\r\n-- 変数宣言\r\nDECLARE @today_jst datetime ;\r\nDECLARE @today varchar(8);\r\nDECLARE @empty varchar(8);\r\nSET @today_jst = CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');\r\nSET @today = FORMAT(@today_jst, 'yyyyMMdd');\r\nSET @empty = '';\r\n\r\n-- 顧客契約マスタ\r\nTRUNCATE TABLE [omni].[omni_odm_mytginfo_trn_mtgmaster_contract_master];\r\n\r\nINSERT INTO [omni].[omni_odm_mytginfo_trn_mtgmaster_contract_master] -- 顧客契約マスタに登録\r\n\r\nSELECT \r\n    mst.MTGID                                                                            -- 会員ID\r\n    ,mst.MAIL_ADR                                                                        -- メールアドレス\r\n    ,mst.REC_REG_YMD                                                                     -- 登録日\r\n    ,mst.REC_UPD_YMD                                                                     -- 更新日\r\n    ,mst.TAIKAI_FLAG                                                                     -- 退会フラグ\r\n    ,mst.ID_KBN                                                                          -- 会員区分\r\n    ,mst.REG_CD                                                                          -- 会員登録経路\r\n    ,mst.REG_COMP_FLG                                                                    -- 会員登録完了フラグ\r\n    ,mst.BIRTHDAY                                                                        -- 生年月日\r\n    ,mst.LATEST_MTGID                                                                    -- 最新統合先mTGID\r\n    ,mst.PERMISSION_INFO_SERVICE_CODE_31_FLAG                                            -- 許諾情報_サービスコード31フラグ\r\n    ,0 as PERMISSION_INFO_SERVICE_CODE_32_FLAG                                           -- 許諾情報_サービスコード32フラグ\r\n    ,mst.PERMISSION_INFO_SERVICE_CODE_33_FLAG                                            -- 許諾情報_サービスコード33フラグ\r\n    ,mst.PERMISSION_INFO_SERVICE_CODE_24_FLAG                                            -- 許諾情報_サービスコード24フラグ\r\n    ,mst.LATEST_EXPIRE_DATE                                                              -- 直近有効期限\r\n    ,mst.REMAINING_POINTS_SUM                                                            -- 残ポイント合算\r\n    ,mst.ID_SYB_CD                                                                       -- 会員種別\r\n    ,mst.LINE_U_ID                                                                       -- LINE_uID\r\n    ,mst.MOST_RECENT_LINEID_UNLINKED_DATE                                                -- 直近のLINEID連携解除日\r\n    ,mst.LINEID_LINK_STATUS                                                              -- LINEID連携ステータス\r\n    ,ISNULL(contract.INTERNAL_AREA_GAS_FLAG, 0)\r\n        as INTERNAL_AREA_GAS_FLAG                                                        -- 域内ガス契約中フラグ\r\n    ,99 as EXTERNAL_AREA_GAS_FLAG                                                        -- 域外ガス契約中フラグ\r\n    ,ISNULL(contract.INTERNAL_AREA_GAS_AND_POWER_FLAG, 0)\r\n        as INTERNAL_AREA_GAS_AND_POWER_FLAG                                              -- 域内ガス電気合算契約中フラグ\r\n    ,ISNULL(contract.EXTERNAL_AREA_GAS_AND_POWER_FLAG, 0)\r\n        as EXTERNAL_AREA_GAS_AND_POWER_FLAG                                              -- 域外ガス電気合算契約中フラグ\r\n    ,ISNULL(contract.POWER_FLAG, 0)\r\n        as POWER_FLAG                                                                    -- 電気単独契約中フラグ\r\n    ,mst.FREE_ITEM01                                                                     -- 予備1\r\n    ,mst.FREE_ITEM02                                                                     -- 予備2\r\n    ,mst.FREE_ITEM03                                                                     -- 予備3\r\n    ,mst.FREE_ITEM04                                                                     -- 予備4\r\n    ,mst.FREE_ITEM05                                                                     -- 予備5\r\n    ,mst.FREE_ITEM06                                                                     -- 予備6\r\n    ,mst.FREE_ITEM07                                                                     -- 予備7\r\n    ,mst.FREE_ITEM08                                                                     -- 予備8\r\n    ,mst.FREE_ITEM09                                                                     -- 予備9\r\n    ,mst.FREE_ITEM10                                                                     -- 予備10\r\n    ,@today as REC_REG_YMD2                                                              -- 登録日\r\n    ,@empty as REC_UPD_YMD2                                                              -- 更新日\r\nFROM [omni].[omni_odm_mytginfo_trn_mtgmaster_member_master_temp] mst                     -- mTG会員マスタ_temp\r\nLEFT JOIN\r\n(\r\n    SELECT\r\n         MTGID                                                                           -- mTG会員ID\r\n        ,MAX(INTERNAL_AREA_GAS_FLAG) as INTERNAL_AREA_GAS_FLAG                           -- ガス契約中フラグ\r\n        ,99 as EXTERNAL_AREA_GAS_FLAG                                                    -- 域外ガス契約中フラグ 99:固定値とする\r\n        ,MAX(INTERNAL_AREA_GAS_AND_POWER_FLAG) as INTERNAL_AREA_GAS_AND_POWER_FLAG       -- 域内ガス電気合算契約中フラグ\r\n        ,MAX(EXTERNAL_AREA_GAS_AND_POWER_FLAG) as EXTERNAL_AREA_GAS_AND_POWER_FLAG       -- 域外ガス電気合算契約中フラグ\r\n        ,MAX(POWER_FLAG) as POWER_FLAG                                                   -- 電気単独契約中フラグ\r\n    FROM [omni].[omni_odm_mytginfo_trn_mtgmaster_under_contract_flag]                    -- mTG会員_契約中フラグ\r\n    GROUP BY MTGID\r\n) contract\r\n-- 結合条件会員IDで結合\r\nON mst.MTGID = contract.MTGID\r\n;"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "mTGMaster"
                },
                "annotations": [],
                "lastPublishTime": "2025-05-23T10:42:52Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_PointLostEmail')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "mytokyogas-Blobから「ポイント失効メール」IFに必要なデータを抽出、gzipファイルでBLOB出力し、SFMCにSFTP連携する。",
                "activities": [
                    {
                        "name": "at_GetFiles_PointLostEmail",
                        "description": "Blobのファイル一覧取得",
                        "type": "GetMetadata",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 0,
                            "retryIntervalInSeconds": 30,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "dataset": {
                                "referenceName": "ds_BlobFiles_mTG",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": {
                                        "value": "@concat('forRcvry/',convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'/DCPDA017')",
                                        "type": "Expression"
                                    },
                                    "filename": {
                                        "value": "@concat(convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'_DAM_PointDelete.tsv')",
                                        "type": "Expression"
                                    }
                                }
                            },
                            "fieldList": [
                                "exists"
                            ],
                            "storeSettings": {
                                "type": "AzureBlobStorageReadSettings",
                                "recursive": true,
                                "enablePartitionDiscovery": false
                            },
                            "formatSettings": {
                                "type": "JsonReadSettings"
                            }
                        }
                    },
                    {
                        "name": "at_SendSftp_PointLostEmail",
                        "description": "SMCへ送信",
                        "type": "Copy",
                        "dependsOn": [
                            {
                                "activity": "IfCondition_PointLostEmail",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "7.00:00:00",
                            "retry": 10,
                            "retryIntervalInSeconds": 60,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "typeProperties": {
                            "source": {
                                "type": "BinarySource",
                                "storeSettings": {
                                    "type": "AzureBlobStorageReadSettings",
                                    "recursive": false,
                                    "deleteFilesAfterCompletion": false
                                },
                                "formatSettings": {
                                    "type": "BinaryReadSettings"
                                }
                            },
                            "sink": {
                                "type": "BinarySink",
                                "storeSettings": {
                                    "type": "SftpWriteSettings",
                                    "operationTimeout": "01:00:00",
                                    "useTempFileRename": false
                                }
                            },
                            "enableStaging": false
                        },
                        "inputs": [
                            {
                                "referenceName": "ds_BlobGz",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "datalake/OMNI/MA/PointLostEmail",
                                    "filename": {
                                        "value": "@concat('PointLostEmail_', convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ],
                        "outputs": [
                            {
                                "referenceName": "ds_Gz_Sftp",
                                "type": "DatasetReference",
                                "parameters": {
                                    "directory": "Import/DAM/3A02b_PointExpiration",
                                    "filename": {
                                        "value": "@concat('PointLostEmail_', convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                        "type": "Expression"
                                    }
                                }
                            }
                        ]
                    },
                    {
                        "name": "IfCondition_PointLostEmail",
                        "description": "該当ファイル有無により、出力を替える",
                        "type": "IfCondition",
                        "dependsOn": [
                            {
                                "activity": "at_GetFiles_PointLostEmail",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "userProperties": [],
                        "typeProperties": {
                            "expression": {
                                "value": "@activity('at_GetFiles_PointLostEmail').output.exists",
                                "type": "Expression"
                            },
                            "ifFalseActivities": [
                                {
                                    "name": "at_CreateCSV_PointLostEmail_Header",
                                    "description": "連携ファイルが存在しない場合のヘッダのみ出力",
                                    "type": "Copy",
                                    "dependsOn": [],
                                    "policy": {
                                        "timeout": "7.00:00:00",
                                        "retry": 10,
                                        "retryIntervalInSeconds": 60,
                                        "secureOutput": false,
                                        "secureInput": false
                                    },
                                    "userProperties": [],
                                    "typeProperties": {
                                        "source": {
                                            "type": "DelimitedTextSource",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageReadSettings",
                                                "recursive": false,
                                                "enablePartitionDiscovery": false
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextReadSettings"
                                            }
                                        },
                                        "sink": {
                                            "type": "DelimitedTextSink",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextWriteSettings",
                                                "quoteAllText": true,
                                                "fileExtension": ".csv"
                                            }
                                        },
                                        "enableStaging": false,
                                        "translator": {
                                            "type": "TabularTranslator",
                                            "typeConversion": true,
                                            "typeConversionSettings": {
                                                "allowDataTruncation": true,
                                                "treatBooleanAsNumber": false
                                            }
                                        }
                                    },
                                    "inputs": [
                                        {
                                            "referenceName": "ds_CSV_Blob",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/dev/OMNI/temp/",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": "header_DAM_PointLostEmail.csv"
                                            }
                                        }
                                    ],
                                    "outputs": [
                                        {
                                            "referenceName": "ds_CSV_BlobGz",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/OMNI/MA/PointLostEmail",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": {
                                                    "value": "@concat('PointLostEmail_', convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                                    "type": "Expression"
                                                }
                                            }
                                        }
                                    ]
                                }
                            ],
                            "ifTrueActivities": [
                                {
                                    "name": "at_CreateCSV_PointLostEmail",
                                    "description": "連携ファイルから必要なデータのみを抽出しcsvファイルを作成、BLOBに配置する",
                                    "type": "Copy",
                                    "dependsOn": [],
                                    "policy": {
                                        "timeout": "7.00:00:00",
                                        "retry": 10,
                                        "retryIntervalInSeconds": 60,
                                        "secureOutput": false,
                                        "secureInput": false
                                    },
                                    "userProperties": [],
                                    "typeProperties": {
                                        "source": {
                                            "type": "SqlDWSource",
                                            "sqlReaderQuery": {
                                                "value": "----------------------------------------------------------------------------\n-- MA向けリスト連携 ポイント失効メール 出力 at_CreateCSV_PointLostEmail\n----------------------------------------------------------------------------\n\n-- 作成する外部テーブル(ポイント失効メール_ext_temp)が存在する場合は削除する\nDECLARE @isAllEventsTemp int;\nSELECT @isAllEventsTemp=count(*) FROM sys.objects WHERE schema_id = schema_id('omni') AND name='omni_ods_mytginfo_trn_point_delete_ext_temp';\nIF @isAllEventsTemp = 1\n    DROP EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_point_delete_ext_temp];\n\n\n-- ADFによりTSVをロードする外部テーブルを作成する\n\n-- 外部テーブル作成 omni_ods_mytginfo_trn_point_delete_ext_temp(ポイント失効メール_ext_temp)\nCREATE EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_point_delete_ext_temp]\n(\n     ID_NO\tNVARCHAR(20)\tNULL\t -- 会員ID\n    ,MAIL_ADR\tNVARCHAR(50)\tNULL\t -- メールアドレス\n)\nWITH (\n    DATA_SOURCE=[mytokyogas],\n    LOCATION='@{concat('/forRcvry/',convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'/DCPDA017/',convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'),'_DAM_PointDelete.tsv')}',\n    FILE_FORMAT=[TSV2],\n    REJECT_TYPE=VALUE,\n    REJECT_VALUE=0\n)\n;\n\n-- 会員IDの重複を削除する。重複削除するレコードはメールアドレスが最大のもの以外に行う\nSELECT ID_NO, MAIL_ADR,'@{convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd')}'as CSV_YMD,FORMAT((GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyy/MM/dd HH:mm:ss')as OUTPUT_DATETIME\nFROM (\nSELECT *\n, DupRank = ROW_NUMBER() OVER (\n              PARTITION BY ID_NO\n              ORDER BY MAIL_ADR DESC\n            )\nFROM omni.omni_ods_mytginfo_trn_point_delete_ext_temp\n) as table_pointLostEmail\nWHERE DupRank = 1\n\n\n-- 作成した外部テーブルが存在する場合は削除行う\nSELECT @isAllEventsTemp=count(*) FROM sys.objects WHERE schema_id = schema_id('omni') AND name='omni_ods_mytginfo_trn_point_delete_ext_temp';\nIF @isAllEventsTemp = 1\n    DROP EXTERNAL TABLE [omni].[omni_ods_mytginfo_trn_point_delete_ext_temp];\n\n",
                                                "type": "Expression"
                                            },
                                            "queryTimeout": "02:00:00",
                                            "partitionOption": "None"
                                        },
                                        "sink": {
                                            "type": "DelimitedTextSink",
                                            "storeSettings": {
                                                "type": "AzureBlobStorageWriteSettings"
                                            },
                                            "formatSettings": {
                                                "type": "DelimitedTextWriteSettings",
                                                "quoteAllText": true,
                                                "fileExtension": ".csv"
                                            }
                                        },
                                        "enableStaging": false,
                                        "translator": {
                                            "type": "TabularTranslator",
                                            "typeConversion": true,
                                            "typeConversionSettings": {
                                                "allowDataTruncation": true,
                                                "treatBooleanAsNumber": false
                                            }
                                        }
                                    },
                                    "inputs": [
                                        {
                                            "referenceName": "ds_DamDwhTable_shir",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "table": "--"
                                            }
                                        }
                                    ],
                                    "outputs": [
                                        {
                                            "referenceName": "ds_CSV_BlobGz",
                                            "type": "DatasetReference",
                                            "parameters": {
                                                "directory": "datalake/OMNI/MA/PointLostEmail",
                                                "columnDelimiter": ",",
                                                "quoteChar": "\"",
                                                "firstRowAsHeader": true,
                                                "filename": {
                                                    "value": "@concat('PointLostEmail_', convertFromUtc(pipeline().parameters.executionStartDateTimeUTC, 'Tokyo Standard Time', 'yyyyMMdd'), '.csv.gz')",
                                                    "type": "Expression"
                                                }
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "parameters": {
                    "executionStartDateTimeUTC": {
                        "type": "string",
                        "defaultValue": "@trigger().startTime"
                    }
                },
                "folder": {
                    "name": "検電"
                },
                "annotations": [],
                "lastPublishTime": "2025-02-18T06:50:58Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Insert_ActionPointEntryEvent')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "ODM「アクションポイントエントリーevent」を作成する",
                "activities": [
                    {
                        "name": "at_Insert_EntryEvent_temp",
                        "description": "KARTE全量event → アクションポイントエントリーevent_temp",
                        "type": "Script",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "----------------------------------------------------------------\n-- 2(a)_at_Insert_EntryEvent_temp\n-- アクションポイントエントリーevent_temp 作成\n----------------------------------------------------------------\n\nDECLARE @today date;\nSET @today=CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');  -- 実行日\n\nDECLARE @isEmpty int;\nSELECT @isEmpty=COUNT(*) FROM [omni].[omni_odm_actionpoint_trn_entry_event];  -- 「アクションポイントエントリーevent」のレコード数取得\nIF @isEmpty=0    -- 初回は全量作成する\nBEGIN\n    SET @today='2025-02-01';\nEND\n\ndeclare @targetDT as datetime;\nset @targetDT=DATEADD(day,-30,@today);   -- 実行日-30日\n\n\n----------------------------------------------------------------\n\nTRUNCATE TABLE [omni].[omni_odm_actionpoint_trn_entry_event_temp];\n\nINSERT INTO [omni].[omni_odm_actionpoint_trn_entry_event_temp]\nSELECT DISTINCT\n     KEY_MTGID as MTGID\n    ,CASE WHEN EVENT_NAME='ap_gas'   THEN 1\n          WHEN EVENT_NAME='ap_power' THEN 2\n          WHEN EVENT_NAME='ap_quiz'  THEN 3\n          ELSE 99\n     END as ACTION_POINT_TYPE\n    ,convert(date, EVENT_TIME) as EVENT_DATE   -- 日付にする\n    ,EVENT_NAME\nFROM [omni].[omni_ods_karte_trn_event]   -- KARTE全量event\n\nWHERE \n          EVENT_NAME in('ap_gas','ap_power','ap_quiz')   -- アクションポイントのアクセス\n      and KEY_MTGID is not NULL\n      and EVENT_TIME>=@targetDT\n;\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_EntryEvent",
                        "description": "アクションポイントエントリーevent_temp → アクションポイントエントリーevent",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_EntryEvent_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "----------------------------------------------------------------\n-- 2(b)_at_Insert_EntryEvent\n-- アクションポイントエントリーevent 作成\n----------------------------------------------------------------\n\nDECLARE @today varchar(8);\nSET @today=format(CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyyMMdd');  -- 実行日\n\n\n-- アクションポイントエントリーevent_tempから既存レコード削除\nDELETE tmp\nFROM [omni].[omni_odm_actionpoint_trn_entry_event_temp] tmp\n\nINNER JOIN [omni].[omni_odm_actionpoint_trn_entry_event] eev\n        ON\n                eev.MTGID=tmp.MTGID                          -- mTG会員ID\n            and eev.ACTIONPOINT_TYPE=tmp.ACTIONPOINT_TYPE    -- アクションポイント種別\n            and eev.ENTRY_DATE=tmp.ENTRY_DATE                -- エントリー年月日\n;\n\n\n-- アクションポイントエントリーeventに挿入\nINSERT INTO [omni].[omni_odm_actionpoint_trn_entry_event]\nSELECT\n     MTGID                  -- mTG会員ID\n    ,ACTIONPOINT_TYPE       -- アクションポイント種別\n    ,ENTRY_DATE             -- エントリー年月日\n    ,@today as REC_REG_YMD  -- 登録日\n    ,''     as REC_UPD_YMD  -- 更新日\nFROM [omni].[omni_odm_actionpoint_trn_entry_event_temp]   -- アクションポイントエントリーevent_temp\n;\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "ActionPoint"
                },
                "annotations": [],
                "lastPublishTime": "2025-03-05T02:52:02Z"
            },
            "dependsOn": []
        },
        {
            "name": "[concat(parameters('factoryName'), '/pi_Insert_ActionPointTransactionHistory')]",
            "type": "Microsoft.DataFactory/factories/pipelines",
            "apiVersion": "2018-06-01",
            "properties": {
                "description": "ODM「アクションポイント取引履歴」 および MC向け「アクションポイント直近取引履歴リスト」を作成する",
                "activities": [
                    {
                        "name": "at_Insert_TransactionHistory_temp",
                        "description": "ポイント取引履歴連携リスト → アクションポイント取引履歴_temp\n",
                        "type": "Script",
                        "dependsOn": [],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "----------------------------------------------------------------\n-- 1(a)_at_Insert_TransactionHistory_temp\n-- アクションポイント取引履歴_temp 作成\n----------------------------------------------------------------\n\nDECLARE @today date;\nSET @today=CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time');  -- 実行日\n\nDECLARE @isEmpty int;\nSELECT @isEmpty=COUNT(*) FROM [omni].[omni_odm_actionpoint_trn_transaction_history];  -- 「アクションポイント取引履歴」のレコード数取得\nIF @isEmpty=0    -- 初回は全量作成する\nBEGIN\n    SET @today='2023-01-01';\nEND\n\ndeclare @targetDT as datetime;\nset @targetDT=DATEADD(day,-14,@today);   -- 実行日-14日\n\ndeclare @targetYMD as varchar(8);\nset @targetYMD=format(@targetDT,'yyyyMMdd');\n\n\n----------------------------------------------------------------\n\nTRUNCATE TABLE [omni].[omni_odm_actionpoint_trn_transaction_history_temp];\n\nINSERT INTO [omni].[omni_odm_actionpoint_trn_transaction_history_temp]\nSELECT DISTINCT\n     MTGID\n    ,CASE WHEN REMARKS like 'ガス使用量%' THEN 1\n          WHEN REMARKS like '電気使用量%' THEN 2\n          WHEN REMARKS like 'クイズ回答%' THEN 3\n     END as ACTION_POINT_TYPE    -- アクションポイント種別\n    ,convert(date,TRANSACTION_PROCESSING_DATE) as TRANSACTION_PROCESSING_DATE  -- 取引処理年月日\n    ,REMARKS                     -- 備考\nFROM [omni].[omni_ods_mytgpnt_trn_pnt_trd_hist]  -- ポイント取引履歴連携リスト\n\nWHERE\n        ( REMARKS like 'ガス使用量%' or REMARKS like '電気使用量%' or REMARKS like 'クイズ回答%')\n    and POINT_TYPE_CODE in('9002','9009')\n    and TRANSACTION_PROCESSING_DATE >= @targetYMD\n;\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_TransactionHistory",
                        "description": "アクションポイント取引履歴_temp → アクションポイント取引履歴",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_TransactionHistory_temp",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "----------------------------------------------------------------\n-- 1(b)_at_Insert_TransactionHistory\n-- アクションポイント取引履歴 作成\n----------------------------------------------------------------\n\nDECLARE @today varchar(8);\nSET @today=format(CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyyMMdd');  -- 実行日\n\n\n-- アクションポイント取引履歴_tempから既存レコード削除\nDELETE tmp\nFROM [omni].[omni_odm_actionpoint_trn_transaction_history_temp] tmp    -- アクションポイント取引履歴_temp\n\nINNER JOIN [omni].[omni_odm_actionpoint_trn_transaction_history] th    -- アクションポイント取引履歴\n        ON\n                th.MTGID=tmp.MTGID                          -- mTG会員ID\n            and th.ACTIONPOINT_TYPE=tmp.ACTIONPOINT_TYPE    -- アクションポイント種別\n            and th.TRANSACTION_PROCESSING_DATE=tmp.TRANSACTION_PROCESSING_DATE  --    取引処理年月日\n;\n\n\n-- アクションポイント取引履歴に挿入\nINSERT INTO [omni].[omni_odm_actionpoint_trn_transaction_history]\nSELECT\n     MTGID                          -- mTG会員ID\n    ,ACTIONPOINT_TYPE               -- アクションポイント種別\n    ,TRANSACTION_PROCESSING_DATE    -- 取引処理年月日\n    ,@today as REC_REG_YMD          -- 登録日\n    ,''     as REC_UPD_YMD          -- 更新日\nFROM [omni].[omni_odm_actionpoint_trn_transaction_history_temp]   -- アクションポイント取引履歴_temp\n;\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    },
                    {
                        "name": "at_Insert_RecentTransactionMembersContractList_temp",
                        "description": "アクションポイント取引履歴、会員基本情報、契約中フラグ_temp → アクションポイント直近取引履歴リスト（契約中会員）_temp",
                        "type": "Script",
                        "dependsOn": [
                            {
                                "activity": "at_Insert_TransactionHistory",
                                "dependencyConditions": [
                                    "Succeeded"
                                ]
                            }
                        ],
                        "policy": {
                            "timeout": "0.12:00:00",
                            "retry": 2,
                            "retryIntervalInSeconds": 120,
                            "secureOutput": false,
                            "secureInput": false
                        },
                        "userProperties": [],
                        "linkedServiceName": {
                            "referenceName": "li_dam_dwh",
                            "type": "LinkedServiceReference"
                        },
                        "typeProperties": {
                            "scripts": [
                                {
                                    "type": "NonQuery",
                                    "text": "----------------------------------------------------------------\n-- 1(c)_at_Insert_RecentTransactionMembersContractList_temp\n-- アクションポイント直近取引履歴リスト（契約中会員）_temp\n----------------------------------------------------------------\n\nDECLARE @today varchar(8);\nSET @today=format(CONVERT(DATE, GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Tokyo Standard Time'),'yyyyMMdd');  -- 実行日\n\n\nTRUNCATE TABLE [omni].[omni_odm_actionpoint_trn_recent_transaction_members_contract_list_temp];\n\nINSERT INTO [omni].[omni_odm_actionpoint_trn_recent_transaction_members_contract_list_temp]\nSELECT\n     apthis.MTGID                            -- mTG会員ID\n    ,apthis.ACTIONPOINT_TYPE                 -- アクションポイント種別\n    ,max(apthis.TRANSACTION_PROCESSING_DATE) -- 直近取引年月日\n    ,@today as REC_REG_YMD                   -- 登録日\nFROM [omni].[omni_odm_actionpoint_trn_transaction_history] apthis         -- アクションポイント取引履歴\n\nINNER JOIN [omni].[omni_ods_mytginfo_trn_cpinfo] cpinfo                   -- 会員基本情報\n        ON     apthis.MTGID=cpinfo.ID_NO\n           and cpinfo.TAIKAI_FLAG=0    -- 退会フラグ          =0:現会員\n           and cpinfo.REG_COMP_FLG=1   -- 会員登録完了フラグ  =1:初回ログインし本登録完了済\n\nINNER JOIN [omni].[omni_odm_mytginfo_trn_mtgmaster_under_contract_flag_temp] cfgtmp  -- mTG会員_契約中フラグ_temp\n        ON     apthis.MTGID=cfgtmp.MTGID      -- 「mTG会員_契約中フラグ_temp」は契約中のみのため、MTGIDが一致すれば契約中と判断できる\n\nGROUP BY apthis.MTGID,apthis.ACTIONPOINT_TYPE\n;\n"
                                }
                            ],
                            "scriptBlockExecutionTimeout": "02:00:00"
                        }
                    }
                ],
                "policy": {
                    "elapsedTimeMetric": {}
                },
                "folder": {
                    "name": "ActionPoint"
                },
                "annotations": [],
                "lastPublishTime": "2025-03-24T02:56:58Z"
            },
            "dependsOn": []
        }
    ]
}