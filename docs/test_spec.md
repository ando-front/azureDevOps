# ADFパイプラインテスト仕様書

## 概要
Azure Data Factory (ADF) パイプラインのローカルテスト環境における、テストケースとその実行方法を定義します。

## テスト環境
- Azurite: ローカルでのAzure Storageエミュレーター
- Python: テスト実行環境
- Docker: コンテナ化された実行環境

## 前提条件
- Dockerがインストールされていること
- ポート10000-10002, 2222が利用可能であること

## テストケース

### 1. Azurite動作確認テスト (`test_azurite_is_running`)

#### 目的
Azuriteが正常に起動し、Azure Blob Storageの操作が可能な状態であることを確認します。

#### テスト手順
1. Azuriteへの接続を試行
2. コンテナ一覧の取得を実行

#### 期待結果
- Azuriteへの接続が成功すること
- エラーが発生せずにコンテナ一覧が取得できること

### 2. パイプライン1実行テスト (`test_pipeline1`)

#### 目的
ADFパイプラインの基本的なデータコピー操作が正常に動作することを確認します。

#### 前提条件
- 入力コンテナ（`input`）が存在すること
- 出力コンテナ（`output`）が存在すること
- テストデータファイル（`test.csv`）が準備されていること

#### テスト手順
1. 入力ファイルの準備
   - CSVテストデータの作成
   - 入力コンテナへのアップロード

2. パイプライン処理のシミュレーション
   - 入力Blobからデータ読み取り
   - 出力Blobへのデータ書き込み
   - ローカルフォルダへのダウンロード

3. 結果の検証
   - 出力ファイルの存在確認
   - ファイル内容の正確性確認

#### 期待結果
- 入力ファイルが正常に作成されること
- Blobストレージ間でのデータコピーが成功すること
- 出力ファイルが正しく作成されること
- 出力ファイルの内容が入力ファイルと一致すること

### 3. パイプライン2実行テスト (`test_pipeline2`)

#### 目的
SQLMiからSynapse Analytics経由でBlobストレージにデータを抽出し、SFTPサーバに転送する一連の処理が正常に動作することを確認します。

#### 前提条件
- 入力コンテナ（`input`）が存在すること
- 出力コンテナ（`output`）が存在すること
- SFTPサーバが起動していること
- SFTPフォルダ（`sftp`）が存在すること
- テストデータファイル（`test.csv`）が準備されていること

#### テスト手順
1. 入力ファイルの準備
   - CSVテストデータの作成
   - 入力フォルダへの配置

2. パイプライン処理のシミュレーション
   - SQLMiからのデータ抽出
   - Synapse Analyticsへのデータコピー
   - Blobストレージへのデータエクスポート（CSV形式）
   - SFTPサーバへのファイル転送

3. 結果の検証
   - 出力ファイル（`.gz`形式）の存在確認
   - SFTPサーバ上のファイル転送確認

#### 期待結果
- 入力CSVファイルが正常に処理されること
- 出力フォルダに圧縮ファイル（`.gz`）が生成されること
- SFTPサーバに圧縮ファイルが転送されること

## テスト実行方法

### ローカル環境での実行

```bash
# Dockerイメージのビルド
docker build -t adf-test .

# テストの実行
docker run --rm \
  -p 10000:10000 \
  -p 10001:10001 \
  -p 10002:10002 \
  -p 2222:2222 \
  adf-test
```

### テスト結果の確認

テスト実行時には以下の情報が表示されます：

1. 各テストケースの実行状況
   - テスト開始の通知
   - 各ステップの進捗状況
   - 成功/失敗の結果

2. テスト実行サマリー
   - 実行されたテストの総数
   - 成功したテストの数
   - 失敗したテストの数
   - エラーが発生したテストの数

## エラーハンドリング

### 想定されるエラー

1. Azurite接続エラー
   - 原因: Azuriteが正常に起動していない
   - 対応: Dockerコンテナの状態確認、ポート設定の確認

2. ファイル操作エラー
   - 原因: ファイルシステムの権限問題
   - 対応: フォルダのパーミッション確認

3. Blobストレージ操作エラー
   - 原因: コンテナが存在しない、アクセス権限の問題
   - 対応: コンテナの存在確認、接続文字列の確認

4. SFTPサーバ接続エラー
   - 原因: SFTPサーバが起動していない、認証失敗
   - 対応: サービス状態の確認、認証情報の確認

## メンテナンス

### テストデータの管理
- 入力データは `test.csv` として標準化
- テストデータはテスト実行後に自動的にクリーンアップ

### テストの追加方法
1. 新しいテストケースを `TestADF` クラスに追加
2. セットアップとクリーンアップの処理を適切に実装
3. 本仕様書にテストケースの詳細を追記
