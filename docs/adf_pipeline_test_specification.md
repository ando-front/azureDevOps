# ADFパイプラインのテスト仕様

## 概要

このドキュメントでは、Azure Data Factory (ADF) パイプラインのテスト方法について説明します。

## テスト環境について

ローカル環境でのテストには、以下の要素を使用します。

- Azurite: ローカル環境で Azure Blob Storageのエミュレーター
- Python: テスト実行環境
- Docker: コンテナ化された実行環境

## 前提条件

テストを実行する前に、以下の条件を満たしていることを確認してください。

- Dockerがインストールされていること
- ポート10000-10002, 2222が利用可能であること

## テストケース

### 1. Azuriteの動作確認 (`test_azurite_is_running`)

#### 目的

Azuriteが正常に起動し、Azure Blob Storageの基本的な操作が可能であることを確認します。

#### テスト手順

1. Azuriteへの接続を試みます。
2. コンテナの一覧を取得します。

#### 期待結果

- Azuriteへの接続に成功すること。
- コンテナの一覧がエラーなく取得できること。

### 2. パイプライン1の実行テスト (`test_pipeline1`)

#### 目的

ADFパイプラインの基本的なデータコピー処理が正常に動作することを確認します。

#### 前提条件

- 入力コンテナ (`input`) が存在すること。
- 出力コンテナ (`output`) が存在すること。
- テストデータファイル (`test.csv`) が準備されていること。

#### テスト手順

1. テスト用の入力ファイルを準備します。
   - CSV形式のテストデータを作成します。
   - 作成したデータを入力コンテナにアップロードします。

2. パイプラインの処理をシミュレーションします。
   - 入力Blobからデータを読み取ります。
   - 出力Blobへデータを書き込みます。
   - 処理結果をローカルフォルダにダウンロードします。

3. 処理結果を検証します。
   - 出力ファイルが存在することを確認します。
   - ファイルの内容が正しいことを確認します。

#### 期待結果

- テスト用の入力ファイルが正常に作成されること。
- Blobストレージ間でのデータコピーが成功すること。
- 出力ファイルが正しく作成されること。
- 出力ファイルの内容が入力ファイルと一致すること。

### 3. パイプライン2の実行テスト (`test_pipeline2`)

#### 目的

SQLMiからSynapse Analyticsを経由してBlobストレージにデータを抽出し、SFTPサーバに転送する一連の処理が正常に動作することを確認します。

#### 前提条件

- 入力コンテナ (`input`) が存在すること。
- 出力コンテナ (`output`) が存在すること。
- SFTPサーバが起動していること。
- SFTPフォルダ (`sftp`) が存在すること。
- テストデータファイル (`test.csv`) が準備されていること。

#### テスト手順

1. テスト用の入力ファイルを準備します。
   - CSV形式のテストデータを作成します。
   - 作成したデータを入力フォルダに配置します。

2. パイプラインの処理をシミュレーションします。
   - SQLMiからデータを抽出します。
   - Synapse Analyticsへデータをコピーします。
   - Blobストレージへデータを出力します (CSV形式)。
   - SFTPサーバへファイルを転送します。

3. 処理結果を検証します。
   - 出力ファイル (`.gz` 形式) が存在することを確認します。
   - SFTPサーバ上にファイルが転送されていることを確認します。

#### 期待結果

- テスト用の入力CSVファイルが正常に処理されること。
- 出力フォルダに圧縮ファイル (`.gz`) が生成されること。
- SFTPサーバに圧縮ファイルが転送されること。

## テストの実行方法

### ローカル環境での実行

```bash
# Dockerイメージのビルド
docker build -t adf-test .

# テストの実行
docker run --rm \
  -p 10000:10000 \
  -p 10001:10001 \
  -p 10002:10002 \
  -p 2222:2222 \
  adf-test
```

### テスト結果の確認

テスト実行時には以下の情報が表示されます：

1. 各テストケースの実行状況
   - テスト開始の通知
   - 各ステップの進捗状況
   - 成功/失敗の結果

2. テスト実行サマリー
   - 実行されたテストの総数
   - 成功したテストの数
   - 失敗したテストの数
   - エラーが発生したテストの数

## エラーハンドリング

### 想定されるエラー

1. Azurite接続エラー
   - 原因: Azuriteが正常に起動していない
   - 対応: Dockerコンテナの状態確認、ポート設定の確認

2. ファイル操作エラー
   - 原因: ファイルシステムの権限問題
   - 対応: フォルダのパーミッション確認

3. Blobストレージ操作エラー
   - 原因: コンテナが存在しない、アクセス権限の問題
   - 対応: コンテナの存在確認、接続文字列の確認

4. SFTPサーバ接続エラー
   - 原因: SFTPサーバが起動していない、認証失敗
   - 対応: サービス状態の確認、認証情報の確認

## メンテナンス

### テストデータの管理
- 入力データは `test.csv` として標準化
- テストデータはテスト実行後に自動的にクリーンアップ

### テストの追加方法
1. 新しいテストケースを `TestADF` クラスに追加
2. セットアップとクリーンアップの処理を適切に実装
3. 本仕様書にテストケースの詳細を追記
