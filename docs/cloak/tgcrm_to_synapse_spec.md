# 要件定義・仕様書

## 1. 概要

### 業務目的（背景）
- 従来は週次の洗替方式で更新していたODSテーブル（CLOAK契約キー）について、データの鮮度向上を目的に、日次で作成される差分ファイルによる更新方式に変更する。

### システム概要
- TG-CRM契約情報連携ファイル（CSV形式）をAzure Blob Storageから日次で取得し、Azure Data Factory(ADF)を用いてAzure Synapse Analytics内のODSテーブルに差分データを追加する。

## 2. 機能要件

### 入力ファイル仕様
- **格納場所:** Azure Blob Storage
- **ファイル名:** 固定名（上書き更新）
- **更新判断基準:** ファイルのタイムスタンプ及びファイル内の更新フラグ（UPDATE_FLAG）とUAD区分（UAD_FLAG）
  - 更新フラグの内容:
    - U：更新
    - A：追加（現状は、追加・更新・変更なしも「A」）
    - D：削除

### データフォーマット
- 提供されたスキーマ定義（別途画像参照）に準拠する。

### ADFパイプライン処理概要
- Blob Storage上のファイル更新をイベントトリガーで検知し、パイプラインを起動。
- ファイル内の更新フラグ・UAD区分により差分データを判定。
- Synapse Analytics内の新規作成するODSテーブル（論理名「CLOAK契約キー」、物理名は別途指定）に対して差分データを追加する。

## 3. 非機能要件

### スケジューリング
- 日次処理。Blob Storageのファイル更新をトリガーとして実行。

### エラー処理・監視
- Azure Monitorを利用したアラート検知。
- パイプライン異常終了時は担当者へ通知する。

## 4. 実装の前提および制約事項

### 実行環境
- Azure Data Factory
- Azure Synapse Analytics
- Azure Blob Storage
- 初期開発はローカル環境で行い、各種ADFリソースはJSONファイルで管理。
- DBやBlob Storageはモックを使用して単体テストを実施。
- Dockerコンテナ環境でE2Eテストを実施後、Azure環境へ展開。
- **ローカルおよびDocker環境は、既存パイプライン開発用に構築済みのインフラを流用し、本パイプライン用リソースを追加する形で統合管理する。**

### データボリューム
- 後続タスクにて明確化する。

### セキュリティ要件
- 後続タスクにて明確化する。

## 5. 留意事項
- ファイル名が固定であり、ファイル更新有無判定のためにタイムスタンプを利用する。
- CLOAK契約キーはマスタ的な位置づけのため、必ず最新データをロードする必要があり、古いデータによる誤った上書きや重複取り込みを防ぐ仕組みを検討する。

以上を正式な仕様として確定し、次の段階（実装ToDoリスト作成）に進む。

