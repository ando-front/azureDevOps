# 要件定義・仕様書（案）目次

## 1. 概要

- 業務目的（背景）
- システム概要

## 2. 機能要件

- 入力ファイル（TG-CRM契約情報連携ファイル）の仕様
- 格納場所（Azure Blob Storage）
- ファイル名と更新ルール（タイムスタンプ、更新フラグ、UAD区分）
- データフォーマットおよびスキーマ定義（提供画像を元に記載）
- 処理概要（Azure Data Factoryパイプライン）
- ファイル更新検知（Event Trigger）
- 差分判定ロジック（更新フラグ・UAD区分による判定）
- 差分データ取込処理（Synapse Analytics ODSテーブルへの日次追加）
- 出力先（Synapse Analytics）
- テーブルスキーマ定義（新規作成テーブル案）
- データの更新方式（差分追加型、パフォーマンス次第で見直し可能）

## 3. 非機能要件

- スケジューリング（日次・イベント駆動）
- エラー処理・監視（Azure Monitorを用いたアラート検知）

## 4. 実装の前提および制約事項

- 実行環境（Azure Data Factory, Synapse Analytics, Azure Blob Storage）
- 想定するデータボリューム（後続タスクとして再確認予定）
- セキュリティ要件（後続タスクとして再確認予定）

---

## 追加の留意点と仕様の整理

### 1. CLOAK契約キーに関する特殊要件

- CLOAK契約キー連携ファイルは固定ファイル名で提供される。
- 更新有無の判断は、ファイルのタイムスタンプを使用する。ただし、ファイル名が固定であるため、更新の有無判定が不確実なリスクあり。
- マスタ的な位置づけのため、必ず最新のデータがロードされることを保証しなければならない。

### 2. ファイル更新検知および異常処理

- 「週次の連携ファイルが更新されていない」場合を検知する処理を追加する。
- Azure Data Factoryのパイプライン内でBlob Storage上のファイルの更新日時（LastModified）を確認し、前回ロード時刻との比較を行う。
- 更新がない場合はパイプラインを異常終了させる。
- Azure Monitorのアラートで異常終了を通知する。

### 3. エラーリカバリ戦略

- ファイル更新がない場合のデータロードを防ぎ、過去データによる誤った上書きや重複取り込みを防止する。
- 異常終了時には適切なアラート通知を発し、担当者による確認とリカバリを行えるようにする。

### 4. 作成するODS名について

- 新規に作成するODSテーブル名を『CLOAK契約キー』とする。
