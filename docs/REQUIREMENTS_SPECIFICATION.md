# Azure Data Factory システム要件定義書

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [機能要件](#機能要件)  
3. [非機能要件](#非機能要件)
4. [システム制約](#システム制約)
5. [インターフェース要件](#インターフェース要件)
6. [セキュリティ要件](#セキュリティ要件)
7. [運用要件](#運用要件)
8. [移行要件](#移行要件)

---

## 📊 プロジェクト概要

### プロジェクト名

**Azure Data Factory 統合データパイプラインシステム構築プロジェクト**

### プロジェクト背景

従来の分散したデータ処理システムを統合し、Azure Data Factory を中核とする統一されたデータパイプラインプラットフォームを構築する。顧客データ、契約情報、支払い情報等の多様なデータソースを効率的に統合・変換・配信し、ビジネス価値の最大化を図る。

### プロジェクト目標

#### 主要目標

- **データ処理の統合化**: 37+の統合パイプラインによる一元管理
- **処理性能の向上**: バッチ処理時間30%短縮、リアルタイム処理対応
- **運用コスト削減**: インフラコスト20%削減、運用工数40%削減  
- **データ品質向上**: 99.5%のデータ品質SLA達成
- **セキュリティ強化**: GDPR/個人情報保護法完全準拠

#### 期待効果

- **業務効率化**: 手動データ処理作業の自動化
- **意思決定迅速化**: リアルタイムデータ分析基盤提供
- **顧客体験向上**: パーソナライズされたサービス提供
- **コンプライアンス強化**: 監査対応の自動化

### ステークホルダー

| 役割 | 組織/担当者 | 責任範囲 |
|------|-------------|----------|
| プロジェクトオーナー | 情報システム部長 | 全体責任・予算承認 |
| プロジェクトマネージャー | ITプロジェクト推進室 | 進捗管理・品質管理 |
| システムアーキテクト | データエンジニアリングチーム | 技術設計・アーキテクチャ |
| ビジネスアナリスト | 事業企画部 | 業務要件定義 |
| データサイエンティスト | データ分析部 | データ活用要件 |
| セキュリティ担当 | 情報セキュリティ室 | セキュリティ要件・監査 |
| 運用担当 | システム運用部 | 運用設計・保守 |

---

## 🔧 機能要件

### 1. データ統合機能

#### 1.1 データ取得機能

**FR-001: 多様なデータソース対応**

- **要件**: SQL Server、Oracle、API、ファイル等からのデータ取得
- **詳細**:
  - SQL Managed Instance からの顧客マスタデータ取得
  - REST API からのリアルタイムデータ取得  
  - CSV/JSON/XML ファイルからのバッチデータ取得
  - Event Hub からのストリーミングデータ取得
- **優先度**: 極高
- **検証基準**: 全データソースからの正常なデータ取得

**FR-002: 増分データ取得**

- **要件**: 差分データのみを効率的に取得する機能
- **詳細**:
  - タイムスタンプベースの増分取得
  - Change Data Capture (CDC) 対応
  - 重複データの自動除外
- **優先度**: 高
- **検証基準**: 増分取得によるデータ処理時間50%短縮

#### 1.2 データ変換機能

**FR-003: 大規模データ変換**

- **要件**: 460列の顧客DMデータの包括的変換処理
- **詳細**:
  - NULL値補完・データ型変換
  - ビジネスルールに基づくデータ検証
  - カラムグループ別の並列処理
  - データ品質スコア算出
- **優先度**: 極高
- **検証基準**: 460列データの完全な変換・検証

**FR-004: リアルタイム変換**

- **要件**: ストリーミングデータのリアルタイム変換
- **詳細**:
  - 1000件/秒のスループット対応
  - 低レイテンシ処理（100ms以下）
  - イベント駆動型処理
- **優先度**: 高
- **検証基準**: リアルタイム処理性能目標達成

### 2. パイプライン管理機能

#### 2.1 パイプライン実行制御

**FR-005: 依存関係管理**

- **要件**: パイプライン間の複雑な依存関係を管理
- **詳細**:
  - 先行パイプライン完了を待機
  - 並列実行可能パイプラインの自動検出
  - 障害時の影響範囲制御
- **優先度**: 高
- **検証基準**: 依存関係の正確な制御

**FR-006: スケジュール実行**

- **要件**: 柔軟なスケジュール設定による自動実行
- **詳細**:
  - Cron式による詳細スケジュール設定
  - 祝日・営業日カレンダー連携
  - 実行時間の動的調整
- **優先度**: 中
- **検証基準**: スケジュール通りの正確な実行

#### 2.2 エラーハンドリング

**FR-007: 自動復旧機能**

- **要件**: 一時的障害からの自動復旧
- **詳細**:
  - 指数バックオフによるリトライ
  - 代替パスの自動実行
  - 手動介入ポイントの提供
- **優先度**: 高
- **検証基準**: 95%の障害自動復旧率

### 3. データ配信機能

#### 3.1 ファイル出力

**FR-008: 多形式ファイル出力**

- **要件**: CSV、JSON、Parquet等の多様な形式でのファイル出力
- **詳細**:
  - 圧縮機能（Gzip、Snappy）
  - 文字エンコーディング選択
  - ファイル分割機能
- **優先度**: 高
- **検証基準**: 全対応形式での正常出力

**FR-009: SFTP配信**

- **要件**: 外部システムへの安全なファイル転送
- **詳細**:
  - SSH鍵認証対応
  - 転送完了通知
  - 転送履歴管理
- **優先度**: 高
- **検証基準**: 100%の転送成功率

#### 3.2 API配信

**FR-010: REST API提供**

- **要件**: 処理済みデータのAPI経由提供
- **詳細**:
  - JSON形式でのデータ応答
  - ページネーション対応
  - レート制限機能
- **優先度**: 中
- **検証基準**: API応答時間500ms以下

### 4. 顧客データ管理機能

#### 4.1 顧客統合マスタ

**FR-011: 460列顧客DMパイプライン**

- **要件**: マーケティング用統合顧客データマートの構築
- **詳細**:

  ```
  主要カラムグループ:
  - コア顧客情報 (CLIENT_KEY_AX等)
  - 生活スタイル情報 (LIV0EU_*: 157列)
  - TESシステム情報 (TESHSMC_*, TESHSEQ_*: 89列)  
  - 電力契約情報 (EPCISCRT_*: 76列)
  - Web行動履歴 (WEBHIS_*: 138列)
  ```

- **優先度**: 極高
- **検証基準**: 460列データの完全統合

**FR-012: 顧客セグメント分析**

- **要件**: BXフラグ付与による顧客セグメント化
- **詳細**:
  - 行動履歴に基づくスコア算出
  - セグメント自動分類
  - 定期的なセグメント見直し
- **優先度**: 高
- **検証基準**: セグメント精度85%以上

### 5. 支払い管理機能

#### 5.1 支払い方法管理

**FR-013: 支払い方法マスタ管理**

- **要件**: 支払い方法の一元管理・配信
- **詳細**:
  - 支払い方法変更の検知・通知
  - SFMC連携による自動通知
  - 支払い方法有効性検証
- **優先度**: 高
- **検証基準**: 変更検知100%、通知成功率99%

**FR-014: 支払いアラート機能**

- **要件**: 支払い関連の自動アラート配信
- **詳細**:
  - 支払い期限アラート
  - 支払い失敗通知
  - 支払い方法変更確認
- **優先度**: 中
- **検証基準**: アラート配信成功率99%

### 6. 契約管理機能

#### 6.1 電力契約管理

**FR-015: 契約感謝メール配信**

- **要件**: 電力契約完了時の自動感謝メール配信
- **詳細**:
  - 契約内容の個別化
  - 配信タイミング最適化
  - 開封率トラッキング
- **優先度**: 中
- **検証基準**: 配信成功率99%、開封率30%以上

**FR-016: KARTE連携**

- **要件**: 契約スコア情報のKARTE S3配信
- **詳細**:
  - JSON形式での日次配信
  - MTGID ハッシュ化による匿名化
  - スコア算出ロジックの実装
- **優先度**: 中
- **検証基準**: 日次配信100%、データ精度95%

---

## ⚡ 非機能要件

### 1. 性能要件

#### 1.1 処理性能

**NFR-001: バッチ処理性能**

- **要件**: 大容量データの効率的バッチ処理
- **詳細**:
  - 顧客DM(460列): 100万件を60分以内
  - 支払い情報: 50万件を30分以内
  - 契約情報: 10万件を15分以内
- **測定方法**: パイプライン実行ログ分析
- **優先度**: 極高

**NFR-002: リアルタイム処理性能**

- **要件**: ストリーミングデータの低レイテンシ処理
- **詳細**:
  - スループット: 1000件/秒以上
  - レイテンシ: 100ms以下（95パーセンタイル）
  - 同時接続数: 100接続以上
- **測定方法**: 負荷テスト・性能監視
- **優先度**: 高

#### 1.2 スケーラビリティ

**NFR-003: 水平スケーリング**

- **要件**: 負荷増加に対する自動スケーリング
- **詳細**:
  - Integration Runtime の動的スケーリング
  - 並列度の自動調整（最大10並列）
  - リソース使用率80%でスケールアウト
- **測定方法**: ロードテスト
- **優先度**: 高

### 2. 可用性要件

**NFR-004: システム稼働率**

- **要件**: 高可用性システムの構築
- **詳細**:
  - 稼働率: 99.9%以上（月間ダウンタイム43分以内）
  - 計画停止: 月1回4時間以内
  - 自動フェイルオーバー: 5分以内
- **測定方法**: システム監視・可用性レポート
- **優先度**: 極高

**NFR-005: 災害復旧**

- **要件**: 災害時の迅速な復旧
- **詳細**:
  - RTO（目標復旧時間）: 2時間以内
  - RPO（目標復旧ポイント）: 15分以内
  - 地理的冗長化（東日本・西日本リージョン）
- **測定方法**: DR テスト実施
- **優先度**: 高

### 3. セキュリティ要件

**NFR-006: データ暗号化**

- **要件**: 全データの暗号化保護
- **詳細**:
  - 保存時暗号化: AES-256
  - 転送時暗号化: TLS 1.2以上
  - キー管理: Azure Key Vault
- **測定方法**: セキュリティ監査
- **優先度**: 極高

**NFR-007: アクセス制御**

- **要件**: 厳格なアクセス制御
- **詳細**:
  - RBAC による権限管理
  - MFA（多要素認証）必須
  - 最小権限の原則適用
- **測定方法**: アクセスログ監査
- **優先度**: 極高

### 4. 運用性要件

**NFR-008: 監視・ログ**

- **要件**: 包括的な監視・ログ機能
- **詳細**:
  - リアルタイム監視ダッシュボード
  - 全処理のログ記録（7年保管）
  - 異常検知・自動アラート
- **測定方法**: 監視カバレッジ評価
- **優先度**: 高

**NFR-009: 自動化**

- **要件**: 運用作業の自動化
- **詳細**:
  - CI/CD パイプライン構築
  - 自動デプロイメント
  - 自動テスト実行（734テストケース）
- **測定方法**: 自動化率測定
- **優先度**: 高

### 5. 保守性要件

**NFR-010: コード品質**

- **要件**: 高品質で保守しやすいコード
- **詳細**:
  - SQL外部化による保守性向上
  - 設定の外部化
  - ドキュメント自動生成
- **測定方法**: コード品質メトリクス
- **優先度**: 中

---

## 🔒 システム制約

### 1. 技術制約

**TC-001: プラットフォーム制約**

- Azure Data Factory v2 以上
- .NET Framework 4.8 / .NET Core 3.1以上
- SQL Server 2019 以上
- PowerShell 5.1 以上

**TC-002: データ容量制約**

- 単一ファイル最大サイズ: 5GB
- 1日の総処理量: 1TB以下
- 同時実行パイプライン数: 20以下

**TC-003: ネットワーク制約**

- プライベートエンドポイント必須
- 特定IPレンジからのアクセスのみ許可
- VPN接続必須（オンプレミス連携）

### 2. 業務制約

**BC-001: 処理時間制約**

- バッチ処理: 深夜0時〜6時の時間帯のみ
- メンテナンス: 月1回第3日曜日2-6時
- 緊急時を除き営業時間中の処理停止禁止

**BC-002: データ利用制約**

- 個人情報は仮名化・匿名化必須
- 外部提供時は事前承認必要
- データ保管期間: 法定期間準拠

### 3. コンプライアンス制約

**CC-001: 法的制約**

- 個人情報保護法完全準拠
- GDPR 対応（EU居住者データ）
- SOX法対応（財務関連データ）

**CC-002: 社内制約**

- 情報セキュリティポリシー準拠
- システム開発標準準拠
- データガバナンス規程準拠

---

## 🔌 インターフェース要件

### 1. 外部システム連携

#### 1.1 上流システム

**IF-001: CRM システム連携**

- **接続方式**: SQL Managed Instance 直接接続
- **データ形式**: SQL テーブル
- **更新頻度**: 1時間毎
- **主要テーブル**: 顧客マスタ、契約情報、支払い情報

**IF-002: 契約管理システム連携**

- **接続方式**: REST API
- **データ形式**: JSON
- **更新頻度**: リアルタイム
- **認証方式**: OAuth 2.0

**IF-003: ファイルシステム連携**

- **接続方式**: SFTP
- **ファイル形式**: CSV、JSON、XML
- **配置頻度**: 日次
- **文字コード**: UTF-8

#### 1.2 下流システム

**IF-004: SFMC (Salesforce Marketing Cloud) 連携**

- **配信方式**: SFTP プッシュ
- **ファイル形式**: CSV (Gzip圧縮)
- **配信頻度**: 日次
- **ファイル命名**: {テーブル名}_{YYYYMMDD}.csv.gz

**IF-005: KARTE 連携**

- **配信方式**: S3 バケット配置
- **ファイル形式**: JSON
- **配信頻度**: 日次
- **暗号化**: SSE-S3

**IF-006: BI システム連携**

- **接続方式**: Azure Synapse Analytics
- **データ形式**: Parquet
- **更新頻度**: 1時間毎
- **圧縮**: Snappy

### 2. API仕様

#### 2.1 データ取得API

**API-001: 顧客データ取得API**

```http
GET /api/v1/customers/{customerId}
Authorization: Bearer {token}
Content-Type: application/json

Response:
{
  "customerId": "string",
  "customerName": "string", 
  "segments": ["string"],
  "lastUpdated": "datetime"
}
```

**API-002: パイプライン実行API**

```http
POST /api/v1/pipelines/{pipelineName}/run
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "parameters": {
    "startDate": "2024-01-01",
    "endDate": "2024-01-31"
  }
}

Response:
{
  "runId": "string",
  "status": "Running|Succeeded|Failed",
  "startTime": "datetime"
}
```

### 3. ファイル形式仕様

#### 3.1 CSV出力仕様

```csv
# 顧客DMファイル (CustomerDM_YYYYMMDD.csv)
CLIENT_KEY_AX,CLIENT_NAME,LIV0EU_1X,LIV0EU_8X,...,OUTPUT_DATETIME
C001,田中太郎,1,0,...,2024/01/01 09:00:00
C002,佐藤花子,0,1,...,2024/01/01 09:00:00
```

**仕様詳細**:

- 文字エンコーディング: UTF-8 BOM付き
- 区切り文字: カンマ(,)
- 囲み文字: ダブルクォート(")
- 改行コード: CRLF
- NULL値表現: 空文字

#### 3.2 JSON出力仕様

```json
{
  "contractScore": {
    "hashedMtgId": "a1b2c3d4...",
    "internalAreaGas": "東京",
    "externalAreaGas": "関東",
    "power": "従量電灯A",
    "outputDatetime": "2024-01-01T09:00:00Z"
  }
}
```

---

## 🛡️ セキュリティ要件

### 1. 認証・認可

**SEC-001: ユーザー認証**

- **要件**: Azure AD統合による統一認証
- **詳細**:
  - サービスプリンシパル認証
  - マネージドID利用推奨
  - MFA必須（管理者権限）
- **検証方法**: 認証ログ確認

**SEC-002: アクセス制御**

- **要件**: RBAC によるきめ細かい権限制御
- **詳細**:

  ```
  権限レベル:
  - 読み取り専用: データ参照のみ
  - 操作者: パイプライン実行
  - 開発者: 定義変更
  - 管理者: 全権限
  ```

- **検証方法**: 権限マトリクス確認

### 2. データ保護

**SEC-003: 暗号化**

- **保存時暗号化**:
  - Azure Storage: SSE-S3 (AES-256)
  - SQL Database: TDE (Transparent Data Encryption)
  - Key Vault: HSM保護キー
- **転送時暗号化**:
  - HTTPS/TLS 1.2以上
  - SFTP (SSH暗号化)
  - VPN接続（オンプレミス）

**SEC-004: 個人情報保護**

- **要件**: GDPR・個人情報保護法準拠
- **詳細**:
  - 個人識別情報の仮名化
  - ハッシュ化による匿名化
  - 削除権（忘れられる権利）対応
- **検証方法**: プライバシー影響評価

### 3. 監査・ログ

**SEC-005: 監査ログ**

- **要件**: 全アクセス・操作の記録
- **詳細**:
  - ユーザーアクセスログ
  - データアクセスログ  
  - 設定変更ログ
  - パイプライン実行ログ
- **保管期間**: 7年間
- **検証方法**: 監査ツールによる分析

**SEC-006: セキュリティ監視**

- **要件**: リアルタイムセキュリティ監視
- **詳細**:
  - 異常アクセス検知
  - データ流出監視
  - マルウェア検知
- **対応時間**:
  - Critical: 1時間以内
  - High: 4時間以内
  - Medium: 24時間以内

---

## 🔧 運用要件

### 1. 監視要件

**OPR-001: システム監視**

- **要件**: 24時間365日の継続監視
- **監視項目**:

  ```
  インフラ監視:
  - CPU使用率 (閾値: 80%)
  - メモリ使用率 (閾値: 75%) 
  - ディスクI/O (閾値: 80%)
  - ネットワーク帯域 (閾値: 70%)
  
  アプリケーション監視:
  - パイプライン実行状況
  - エラー発生率 (閾値: 5%)
  - 処理時間 (閾値: SLA+20%)
  - データ品質スコア (閾値: 95%)
  ```

**OPR-002: アラート管理**

- **要件**: 段階的アラート通知
- **通知レベル**:

  ```
  Critical (即座に対応):
  - システム停止
  - データ破損
  - セキュリティ侵害
  → 電話・SMS・メール同時通知
  
  Warning (4時間以内):
  - 性能劣化
  - 容量不足
  - 設定異常
  → メール・Slackチャンネル通知
  
  Info (24時間以内):
  - 定期メンテナンス
  - 軽微な警告
  → メール通知
  ```

### 2. バックアップ・復旧

**OPR-003: バックアップ戦略**

- **データバックアップ**:
  - 日次: 増分バックアップ
  - 週次: 完全バックアップ
  - 月次: アーカイブバックアップ
  - 保管期間: 3年間（法的要件）

**OPR-004: 災害復旧手順**

- **復旧手順書**: Run Book形式で詳細化
- **復旧訓練**: 半年に1回実施
- **RTO/RPO目標**:

  ```
  Critical Pipeline: RTO 2時間, RPO 15分
  Business Pipeline: RTO 4時間, RPO 1時間  
  Report Pipeline: RTO 8時間, RPO 4時間
  ```

### 3. 変更管理

**OPR-005: 変更管理プロセス**

- **変更分類**:

  ```
  緊急変更 (Emergency):
  - セキュリティパッチ適用
  - 重大障害対応
  - 承認: CTO承認のみ
  
  通常変更 (Normal):
  - 機能追加・変更
  - 設定変更
  - 承認: 変更諮問委員会
  
  標準変更 (Standard):
  - 定期メンテナンス
  - 設定値微調整
  - 承認: 事前承認済み
  ```

**OPR-006: デプロイメント管理**

- **環境構成**:

  ```
  Development → Test → Staging → Production
       ↓           ↓        ↓         ↓
   機能開発    統合テスト  性能テスト  本番運用
  ```

- **自動化レベル**: 95%以上の作業自動化
- **ロールバック**: 30分以内の復旧

### 4. 保守・メンテナンス

**OPR-007: 定期メンテナンス**

- **計画停止**: 月1回第3日曜日 2:00-6:00
- **メンテナンス内容**:
  - OSパッチ適用
  - データベースメンテナンス
  - ログローテーション
  - 性能チューニング

**OPR-008: 容量管理**

- **ストレージ監視**: 使用率80%でアラート
- **データアーカイブ**: 3年経過データの自動アーカイブ
- **容量計画**: 半年先までの容量予測

---

## 🔄 移行要件

### 1. データ移行

**MIG-001: 既存データ移行**

- **移行対象データ**:
  - 顧客マスタ: 500万件
  - 契約履歴: 1000万件  
  - 支払い履歴: 2000万件
  - ログデータ: 3年分
- **移行方式**: 段階的移行（フェーズド移行）
- **移行期間**: 6か月
- **検証方法**: データ突合・整合性チェック

**MIG-002: システム間連携移行**

- **移行対象**:
  - 既存ETLツールからADF移行
  - バッチ処理スクリプト移行
  - 監視ツール設定移行
- **移行戦略**: Strangler Fig Pattern
- **並行稼働期間**: 3か月

### 2. 運用移行

**MIG-003: 運用体制移行**

- **移行計画**:

  ```
  Phase 1 (1-2か月): 基盤構築・検証
  Phase 2 (3-4か月): パイロット運用
  Phase 3 (5-6か月): 段階的移行
  Phase 4 (7か月-): 完全移行・最適化
  ```

- **教育計画**: 運用担当者向け研修プログラム
- **引継ぎ**: 既存システムからの運用知識移転

**MIG-004: リスク管理**

- **移行リスク評価**:

  ```
  高リスク:
  - データ不整合 → 詳細検証・ロールバック計画
  - 処理性能劣化 → 性能テスト・チューニング
  - サービス停止 → 並行稼働・段階切替
  
  中リスク:
  - 運用手順相違 → 詳細手順書・研修
  - 監視漏れ → 監視項目チェックリスト
  ```

- **コンティンジェンシープラン**: 各フェーズでの撤退基準

---

## 📋 要件管理

### 要件トレーサビリティマトリクス

| 要件ID | 要件名 | 優先度 | 関連ステークホルダー | 検証方法 | ステータス |
|--------|--------|--------|---------------------|----------|-----------|
| FR-001 | データソース対応 | 極高 | データエンジニア | 接続テスト | 策定完了 |
| FR-011 | 460列顧客DM | 極高 | ビジネスアナリスト | E2Eテスト | 策定完了 |
| NFR-001 | バッチ処理性能 | 極高 | 運用担当 | 性能テスト | 策定完了 |
| SEC-001 | ユーザー認証 | 極高 | セキュリティ担当 | ペネトレーションテスト | 策定完了 |
| OPR-001 | システム監視 | 高 | 運用担当 | 監視テスト | 策定完了 |

### 要件変更管理

**変更管理プロセス**:

1. 変更要求受付
2. 影響範囲分析
3. 変更諮問委員会審議
4. 承認・却下決定
5. 要件文書更新
6. ステークホルダー通知

---

*この要件定義書は2024年12月作成。*
*作成者: プロジェクト推進室、システムアーキテクト*
*承認者: プロジェクトオーナー、情報システム部長*
*次回レビュー: 2025年3月（四半期レビュー）*
