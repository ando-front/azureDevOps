# Azure Data Factory ARM テンプレート 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

OMNI Data Factory Infrastructure Deployment

### 1.2 プロジェクトの目的

Azure Data Factory (`omni-df-dev`) による東京ガスの統合データ基盤における、諸元DB（業務システム）からのデータ抽出・変換・統合を通じたODS（Operational Data Store）およびODM（Operational Data Mart）の構築・運用自動化

### 1.3 スコープ

#### 1.3.1 業務データ処理範囲

- **諸元DB**: 顧客契約情報、利用サービス情報、料金情報の抽出
- **ODS構築**: 業務システム間のデータ統合・標準化
- **ODM構築**: 分析・レポート用データマート作成
- **外部連携**: KARTE、mTG、SFTP等外部システムとの連携

#### 1.3.2 技術的スコープ

- Azure Data Factory リソースの完全な定義と展開
- 複数データソース間のデータ統合パイプライン構築
- セキュアな接続管理とアクセス制御
- スケジュール化されたデータ処理タスクの自動実行

## 2. 業務要件

### 2.1 データソース（諸元DB）要件

#### 2.1.1 顧客・契約系データソース

- **ガス顧客系DB (`omni_odm_gascstmr_trn_gaskiy`)**: 日次お客さま情報
  - 供給区域内ガス契約情報
  - 契約種別、供給開始年月日
  - 顧客番号（KEY_3X, KEY_4X）マスタ

- **電力CIS契約DB (`omni_ods_epcis_trn_contract`)**: 電力契約情報
  - 電力契約ステータス管理
  - 供給地点特定番号（SA_ID）
  - 料金体系コード（RS_CD）

- **CLOAK利用サービスDB (`omni_ods_cloak_trn_usageservice_mtgid`)**:
  - mTGID（myTokyoGas ID）ベース利用サービス
  - サービス種別（001:域内ガス、010:域外ガス、006:電力）
  - サービス契約異動日管理

#### 2.1.2 マーケティング・分析系データソース

- **顧客DNA情報 (`omni_ods_marketing_trn_client_dna`)**:
  - PVスコア（太陽光発電推定スコア）
  - 商材推定情報（総合設備、サービス）
  - デジタル行動スコア

- **顧客DM情報 (`omni_ods_marketing_trn_client_dm`)**:
  - ダイレクトメール配信対象管理
  - 顧客セグメント情報

### 2.2 ODS（Operational Data Store）構築要件

#### 2.2.1 KARTE連携用ODS

**目的**: 外部CRMシステム（KARTE）への顧客統合データ提供

**構築対象テーブル**:

1. **利用サービス統合 (`omni_ods_cloak_trn_karte_usageservice_mtgid`)**
   - 諸元DB: CLOAK利用サービスDB
   - 処理内容: mTGIDベースでの利用サービス統合
   - 出力形式: サービス種別別契約フラグ（域内ガス/域外ガス/電力）

2. **契約情報統合 (`omni_ods_cloak_trn_karte_contract_temp`)**
   - 諸元DB: 利用サービスDB
   - 処理内容: 契約種別別フラグ生成
   - 集約ロジック: MAX関数による契約有無判定

3. **ガス契約詳細 (`omni_ods_gascstmr_trn_karte_gas_contract_temp`)**
   - 諸元DB: ガス顧客系DB + 利用サービスDB
   - 処理内容: KEY結合による契約種別・開始日取得
   - JOIN条件: KEY_3X=供給票番号, KEY_4X=供給番号

4. **電力契約詳細 (`omni_ods_epcis_trn_karte_el_contract_temp`)**
   - 諸元DB: 電力CIS契約DB + 利用サービスDB
   - 処理内容: SA_ID結合による電力契約詳細
   - フィルタ条件: CONTRACT_STATUS='20'（有効契約）

#### 2.2.2 マーケティング統合ODS

**スコア情報統合 (`omni_ods_marketing_trn_karte_score_temp`)**:

- 諸元DB: 顧客DNA情報 + 利用サービス情報
- 処理内容:
  - PVスコア（電力・ガス別）
  - 推定PV保有フラグ
  - 商材推定スコア（総合設備、サービス）
  - デジタル行動スコア

### 2.3 ODM（Operational Data Mart）構築要件

#### 2.3.1 KARTE連携統合データマート

**最終出力テーブル (`omni_ods_marketing_trn_karte_contract_score_info`)**:

**データソース統合**:

- 契約情報temp + ガス契約詳細temp + 電力契約詳細temp + スコア情報temp

**統合処理ロジック**:

```sql
LEFT JOIN による段階的結合
- 契約有無（ベース）
- ガス契約詳細（最新日付での重複排除）
- 電力契約詳細（最新開始日での重複排除）  
- スコア情報（最新異動日での重複排除）
```

**出力項目**:

- 域内ガス契約フラグ・種別
- 域外ガス契約フラグ・種別  
- 電力契約フラグ・種別
- PVスコア（電力・ガス・総合）
- 商材推定スコア（設備・サービス別）

#### 2.3.2 ハッシュ化データマート

**セキュリティ要件対応 (`omni_ods_marketing_trn_karte_contract_score_hashed`)**:

- 諸元DB: 統合データマート + ハッシュマッピングテーブル
- 処理内容: mTGID→HASHED_MTGIDへの変換
- 目的: 個人情報保護対応での外部連携

### 2.4 業務処理パターン要件

#### 2.4.1 顧客関連処理（22パイプライン）

**契約・サービス管理**:

- `pi_Send_ElectricityContractThanks`: 電力契約完了通知
- `pi_Send_OpeningPaymentGuide`: 開栓ガイド送信
- `pi_Send_UsageServices`: 利用サービス情報配信
- `pi_Insert_mTGCustomerMaster`: mTG顧客マスタ更新

**マーケティング・DM配信**:

- `pi_Copy_marketing_client_dm`: 顧客DM情報複製
- `pi_Copy_marketing_client_dna`: 顧客DNA情報複製
- `pi_Send_ClientDM`: 顧客DM配信
- `pi_Send_Cpkiyk`: CP機器・給湯器案内

#### 2.4.2 料金・支払関連処理（8パイプライン）

**支払方法管理**:

- `pi_Send_PaymentMethodMaster`: 支払方法マスタ配信
- `pi_Send_PaymentMethodChanged`: 支払方法変更通知
- `pi_Send_PaymentAlert`: 支払アラート送信

**料金・請求管理**:

- `pi_UtilityBills`: 料金請求情報処理
- `pi_Send_LIMSettlementBreakdownRepair`: LIM決済内訳修正

#### 2.4.3 ポイント・特典関連処理（4パイプライン）

**ポイント管理**:

- `pi_PointGrantEmail`: ポイント付与メール
- `pi_PointLostEmail`: ポイント失効メール
- `pi_Insert_ActionPointEntryEvent`: アクションポイント登録
- `pi_Insert_ActionPointTransactionHistory`: ポイント取引履歴

#### 2.4.4 外部連携・KARTE関連処理（4パイプライン）

**KARTE連携**:

- `pi_Send_karte_contract_score_info`: 契約・スコア情報送信
- `pi_Ins_usageservice_mtgid`: 利用サービスmTGID登録
- `pi_Send_LINEIDLinkInfo`: LINE ID連携情報
- `pi_Send_MovingPromotionList`: 引越しプロモーション

## 3. 技術要件

### 3.1 データ統合基盤要件

#### 3.1.1 データソース接続

- **Azure SQL Data Warehouse**: メインデータ統合基盤
  - `li_dam_dwh`: 本番データウェアハウス
  - `li_dam_dwh_shir`: Self-hosted IR経由接続
- **Azure SQL Managed Instance**: 高可用性統合DB (`li_sqlmi_dwh2`)
- **Azure Blob Storage**: ファイル系データ保管
  - 容量最適化・アーカイブ対応
- **外部システム接続**:
  - Amazon S3 (`li_Karte_AmazonS3`): KARTE連携
  - SFTP/FTP (`li_sftp`, `li_ftp_test`): ファイル転送
- **Azure Key Vault**: 接続情報セキュア管理 (`li_dam_kv_omni`)

#### 3.1.2 データセット管理

**構造化データセット**:

- SQL テーブルデータセット (Azure SQL DW, SQL MI)
- パラメータ化テーブル参照機能
- 動的スキーマ定義・データ型管理

**半構造化データセット**:

- JSON形式データ処理
- CSV/区切り文字形式データ処理  
- 圧縮ファイル対応 (gzip)

**バイナリデータセット**:

- ファイル転送用バイナリ処理
- 圧縮/解凍機能

### 3.2 データ処理パイプライン要件

#### 3.2.1 ETL/ELT処理パターン

**38個のデータ処理パイプライン分類**:

1. **抽出・統合処理** (Extract & Integration):
   - 諸元DB からの業務データ抽出
   - 複数システム間のデータ統合
   - リアルタイム・バッチ処理対応

2. **変換・クレンジング処理** (Transform & Cleansing):
   - データ標準化・正規化
   - 欠損値・異常値処理
   - ビジネスルール適用

3. **ロード・配信処理** (Load & Distribution):
   - ODS・ODM への格納
   - 外部システムへの配信
   - ファイル出力・転送

#### 3.2.2 データ品質管理

- **データ整合性チェック**: 主キー・外部キー制約
- **ビジネスルール検証**: 業務ロジック適合性確認
- **データ鮮度管理**: 最新データ反映確認
- **エラーハンドリング**: 処理失敗時の復旧機能

### 3.3 スケジューリング・運用要件

#### 3.3.1 業務スケジュール

**日次処理**:

- 顧客データ更新・統合
- 利用サービス情報更新
- ポイント関連処理

**週次処理**:  

- 料金確定処理（木曜日特別対応）
- 週次集計・レポート生成

**月次処理**:

- 月次集計処理
- ポイント失効処理  
- 契約更新処理

#### 3.3.2 トリガー管理

**定期実行トリガー**:

- 日次・週次・月次スケジュール
- 業務カレンダー連動
- 曜日別スケジュール設定

**イベント駆動トリガー**:

- ファイル到着検知
- 上流システム完了通知
- 外部API呼び出し

## 4. 非機能要件

### 4.1 セキュリティ要件

#### 4.1.1 個人情報保護

- **ハッシュ化処理**: mTGID→HASHED_MTGID変換による匿名化
- **接続情報保護**: すべての接続文字列をSecureString管理
- **アクセス制御**: ロールベース認証によるデータアクセス制限

#### 4.1.2 データ暗号化・通信保護

- **Azure Key Vault**: シークレット・接続情報の暗号化管理
- **Private Link**: 安全な通信経路確保
- **TLS 1.2+**: 暗号化通信プロトコル適用

### 4.2 可用性・信頼性要件

#### 4.2.1 システム可用性

- **可用性目標**: 99.9%の稼働率維持
- **冗長化**: Self-hosted Integration Runtime (SHIR) 冗長構成
- **フェイルオーバー**: 障害時の自動切り替え機能

#### 4.2.2 データ品質保証

- **データ整合性**: 処理前後での整合性チェック
- **重複排除**: row_number()による重複データ除去
- **エラーハンドリング**: 処理失敗時の自動復旧・再試行

### 4.3 性能要件

#### 4.3.1 処理性能

- **大容量データ対応**: 100万件超データの効率処理
- **並列処理**: パイプライン間の並列実行による性能最適化
- **バッチ処理時間**: 日次処理2時間以内完了

#### 4.3.2 データ転送効率

- **圧縮処理**: gzip圧縮によるデータ転送効率化
- **差分処理**: 前回処理からの差分のみ処理
- **インデックス活用**: 結合処理のパフォーマンス最適化

### 4.4 運用・保守要件

#### 4.4.1 自動化・標準化

- **Infrastructure as Code**: ARM テンプレートによる展開自動化
- **設定標準化**: パラメータ化による環境間設定統一
- **デプロイ自動化**: CI/CD パイプラインによる自動展開

#### 4.4.2 監視・ログ管理

- **処理監視**: パイプライン実行状況の可視化
- **エラー通知**: 処理失敗時のアラート機能
- **ログ保管**: 処理履歴の長期保管・分析

## 5. 業務データ処理詳細仕様

### 5.1 KARTE連携データ処理

#### 5.1.1 契約・スコア情報統合処理 (`pi_Send_karte_contract_score_info`)

**処理概要**: 顧客の契約情報とマーケティングスコアを統合してKARTEシステムに送信

**データフロー**:

1. **諸元DB抽出**:
   - CLOAK利用サービス → サービス種別別契約フラグ生成
   - ガス顧客DB → 域内ガス契約詳細取得
   - 電力CIS → 電力契約詳細取得
   - 顧客DNA → PVスコア・商材推定スコア取得

2. **ODS構築**: 各種tempテーブルでの中間データ生成

3. **ODM統合**: 最終統合テーブル生成・ハッシュ化

4. **外部配信**: Amazon S3経由でKARTEへ送信

#### 5.1.2 利用サービスmTGID管理 (`pi_Ins_usageservice_mtgid`)

**処理概要**: mTGIDベースでの利用サービス情報の統合・管理

**統合ロジック**:

```sql
-- 重複排除処理
row_number() over (PARTITION BY [サービスキー] ORDER BY [UPDATE_FLAG] desc)
-- 最新情報の優先取得
```

### 5.2 顧客関連データ処理

#### 5.2.1 顧客マスタ管理処理

**顧客DM情報処理 (`pi_Copy_marketing_client_dm`)**:

- 諸元DB: マーケティングDB顧客DM情報
- 処理内容: DM配信対象顧客の抽出・複製
- 出力先: 統合顧客DB

**顧客DNA情報処理 (`pi_Copy_marketing_client_dna`)**:

- 諸元DB: マーケティングDB顧客DNA情報
- 処理内容: 顧客行動・嗜好分析データの統合
- 統合項目: PVスコア、商材推定、デジタル行動スコア

#### 5.2.2 契約・サービス通知処理

**電力契約完了通知 (`pi_Send_ElectricityContractThanks`)**:

- 諸元DB: 電力CIS契約DB
- 処理内容: 新規電力契約完了顧客への自動通知
- 配信方法: Email/SMS/LINE連携

**開栓ガイド送信 (`pi_Send_OpeningPaymentGuide`)**:

- 諸元DB: ガス顧客DB + 開栓予定情報
- 処理内容: 開栓予定顧客への事前ガイド配信

### 5.3 料金・支払関連データ処理

#### 5.3.1 支払方法管理

**支払方法マスタ配信 (`pi_Send_PaymentMethodMaster`)**:

- 諸元DB: 料金システムDB支払方法マスタ
- 処理内容: 支払方法情報の外部システム配信
- 配信先: mTGシステム、請求システム
- 配信形式: CSV形式 + SFTP転送

**支払方法変更通知 (`pi_Send_PaymentMethodChanged`)**:

- 諸元DB: 支払方法変更履歴
- 処理内容: 前日比較による変更検知・通知
- 通知対象: 口座振替⇔クレジット変更等

#### 5.3.2 料金・請求処理

**料金請求情報処理 (`pi_UtilityBills`)**:

- 諸元DB: 料金確定システムDB
- 処理内容: 月次料金確定データの統合・配信
- 処理タイミング: 毎月20日（料金確定後）

**支払アラート送信 (`pi_Send_PaymentAlert`)**:

- 諸元DB: 収納システムDB未収情報
- 処理内容: 支払期限経過顧客への督促通知
- 配信タイミング: 支払期限後7日・14日・30日

### 5.4 ポイント・特典関連データ処理

#### 5.4.1 ポイント管理

**ポイント付与処理 (`pi_PointGrantEmail`)**:

- 諸元DB: ポイントシステムDB付与実績
- 処理内容: ポイント付与完了通知の配信
- 通知内容: 付与ポイント数、累計ポイント、有効期限

**ポイント失効処理 (`pi_PointLostEmail`)**:

- 諸元DB: ポイントシステムDB失効予定・実績
- 処理内容: 失効予定・失効完了の顧客通知
- 処理タイミング: 失効30日前、失効当日

#### 5.4.2 アクションポイント管理

**アクションポイント登録 (`pi_Insert_ActionPointEntryEvent`)**:

- 諸元DB: Webサイト行動ログ、アプリ利用ログ
- 処理内容: 顧客行動に基づくポイント付与イベント登録

**ポイント取引履歴管理 (`pi_Insert_ActionPointTransactionHistory`)**:

- 諸元DB: 各種ポイント取引システム
- 処理内容: ポイント付与・利用・失効履歴の統合管理

### 5.5 外部システム連携処理

#### 5.5.1 LINE連携

**LINE ID連携情報送信 (`pi_Send_LINEIDLinkInfo`)**:

- 諸元DB: LINE連携システムDB
- 処理内容: mTGID⇔LINE ID紐付け情報の配信
- 配信先: KARTE、CRM、マーケティングシステム

#### 5.5.2 プロモーション・マーケティング

**引越しプロモーション配信 (`pi_Send_MovingPromotionList`)**:

- 諸元DB: 顧客住所変更履歴、契約変更履歴
- 処理内容: 引越し予定・完了顧客への特典案内
- 配信タイミング: 住所変更検知後、契約手続き完了後

**CP機器案内配信 (`pi_Send_Cpkiyk`)**:

- 諸元DB: 機器利用状況、設備情報、顧客DNA
- 処理内容: CP機器（コージェネ・給湯器等）の案内配信
- ターゲティング: PVスコア、設備更新時期、利用パターン分析

## 6. 業務運用スケジュール

### 6.1 日次処理スケジュール

#### 6.1.1 顧客・契約関連処理

- **04:00-06:00**: 顧客マスタ更新処理
  - `pi_Insert_mTGCustomerMaster`: mTG顧客マスタ同期
  - `pi_Copy_marketing_client_dm`: 顧客DM情報更新
  - `pi_Copy_marketing_client_dna`: 顧客DNA情報更新

- **06:00-08:00**: 利用サービス情報更新
  - `pi_Ins_usageservice_mtgid`: 利用サービスmTGID統合
  - `pi_Send_UsageServices`: 利用サービス情報配信

#### 6.1.2 ポイント・通知関連処理

- **08:00-10:00**: ポイント関連処理
  - `pi_Insert_ActionPointEntryEvent`: アクションポイント登録
  - `pi_Insert_ActionPointTransactionHistory`: ポイント取引履歴更新
  - `pi_PointGrantEmail`: ポイント付与通知（日次分）

- **10:00-12:00**: 各種通知配信
  - `pi_Send_ElectricityContractThanks`: 電力契約完了通知
  - `pi_Send_OpeningPaymentGuide`: 開栓ガイド配信
  - `pi_Send_LINEIDLinkInfo`: LINE ID連携情報配信

### 6.2 週次処理スケジュール

#### 6.2.1 木曜日特別処理（料金確定日）

- **02:00-04:00**: 料金確定前処理
  - 料金システムDB データ整合性チェック
  - 前月分料金データ確定準備

- **20:00-22:00**: 料金確定後処理（料金確定完了後）
  - `pi_UtilityBills`: 料金請求情報処理・配信
  - 月次請求データ外部システム連携

#### 6.2.2 支払関連処理（金曜日）

- **06:00-08:00**: 支払情報処理
  - `pi_Send_PaymentMethodMaster`: 支払方法マスタ配信
  - `pi_Send_PaymentMethodChanged`: 支払方法変更通知
  - `pi_Send_PaymentAlert`: 支払アラート配信（週次督促）

### 6.3 月次処理スケジュール

#### 6.3.1 月初処理（1-3日）

- **01:00-03:00**: 月次集計・統計処理
  - 前月利用実績集計
  - 顧客行動分析データ更新
  - KPI集計レポート生成

#### 6.3.2 月中処理（15日前後）

- **KARTE連携処理**:
  - `pi_Send_karte_contract_score_info`: 契約・スコア情報月次更新
  - 顧客セグメント更新・配信

#### 6.3.3 月末処理（25-末日）

- **02:00-05:00**: ポイント・特典関連処理
  - `pi_PointLostEmail`: ポイント失効通知（月次）
  - `pi_Send_MovingPromotionList`: 引越しプロモーション配信
  - `pi_Send_Cpkiyk`: CP機器案内配信（月次キャンペーン）

### 6.4 特別スケジュール

#### 6.4.1 システムメンテナンス

- **第2日曜日 02:00-06:00**: 定期メンテナンス
  - データベース最適化処理
  - インデックス再構築
  - 古いログファイル削除

#### 6.4.2 緊急時・臨時処理

- **災害時**: 安否確認・緊急通知配信
- **システム障害時**: 代替処理・手動バッチ実行
- **キャンペーン時**: 臨時DM配信・プロモーション処理

## 7. テスト戦略

### 7.1 テストアプローチ

- **単体テスト**: 個別コンポーネントの動作検証
- **結合テスト**: システム間連携の検証
- **E2Eテスト**: ビジネスシナリオ全体の検証
- **総合テスト**: 品質保証と最終確認

### 7.2 テスト対象

- ARM テンプレート (構文・デプロイ検証)
- リンクサービス (14個の接続検証)
- データセット (14個のスキーマ検証)
- パイプライン (38個の処理検証)
- トリガー (30+個のスケジュール検証)
- Integration Runtime (2個の実行環境検証)

### 7.3 品質基準

- **機能要件**: 100%の要件適合
- **性能要件**: 大容量データ処理 < 2時間
- **可用性要件**: 99.9%の稼働率
- **セキュリティ要件**: TLS 1.2+暗号化、RBAC適用
- **データ品質**: エラー率 < 1%、整合性100%

## 8. 承認事項

### 8.1 ステークホルダー承認

- [ ] インフラストラクチャ要件
- [ ] セキュリティ要件
- [ ] 運用要件
- [ ] 性能要件
- [ ] テスト方針・計画

### 8.2 技術承認

- [ ] ARM テンプレート設計
- [ ] パラメータ設計
- [ ] セキュリティ設計
- [ ] テスト仕様書

### 8.3 品質承認

- [ ] テスト計画承認
- [ ] 品質基準承認
- [ ] 受入基準承認

## 9. 関連文書

### 9.1 設計関連文書

- ARM テンプレート設計仕様書 (`ARM_TEMPLATE_DESIGN_SPECIFICATION.md`)
- アーキテクチャ設計書

### 9.2 テスト関連文書

- テスト方針書 (`TEST_STRATEGY_DOCUMENT.md`)
- 単体テスト仕様書 (`UNIT_TEST_SPECIFICATION.md`)
- E2Eテスト仕様書 (`E2E_TEST_SPECIFICATION.md`)
- 総合テスト仕様書 (`COMPREHENSIVE_TEST_SPECIFICATION.md`)

### 9.3 運用関連文書

- 運用手順書
- 監視設定書
- 障害対応手順書

---

**文書作成日**: 2025年7月3日  
**バージョン**: 2.0  
**最終更新**: 2025年7月3日 (業務要件中心への全面改訂)  
**作成者**: 業務分析・システム設計担当  
**承認者**: [承認者名]

## 📝 ドキュメント更新履歴

### v2.0 業務要件中心への全面改訂 (2025/07/03)

**改訂内容**:

- **業務要件の詳細化**: 諸元DB、ODS、ODM構築の具体的要件を追加
- **データ処理パターンの明確化**: 38個のパイプラインを業務用途別に分類・詳細化
- **実際のテーブル名・処理ロジック記載**: ARMテンプレート分析結果を反映
- **運用スケジュールの具体化**: 日次・週次・月次の業務スケジュール詳細化

**業務要件追加項目**:

- KARTE連携データ処理詳細仕様
- 顧客・契約・料金・ポイント関連の具体的処理フロー  
- 諸元DBからODS/ODMへのデータ変換ロジック
- 実際の業務運用タイミング・頻度

### パイプライン数の訂正について (2025/07/03)

**訂正内容**:

- **旧表記**: 120+個のパイプライン
- **正表記**: 38個のパイプライン

**訂正根拠**:
ARMTemplateForFactory.jsonを詳細分析した結果、実際に定義されているパイプライン数は38個であることが確認されました。従来の"120+"という表記は、テストケース数やデータ処理件数との混同により生じた誤記載でした。

**影響範囲**:

- 要件定義書、設計仕様書、各種テスト仕様書の数値を実際の38個に統一
- README.mdのアーキテクチャ概要図も修正
- テストケース数は引き続き適切な規模で維持
